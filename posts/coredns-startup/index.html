<!DOCTYPE html>
<html lang="zh">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta http-equiv="X-UA-Compatible" content="ie=edge">
	<meta name="theme-color" content="#494f5c">
	<meta name="msapplication-TileColor" content="#494f5c">
<meta itemprop="name" content="Coredns 启动流程分析">
<meta itemprop="description" content="最近在看coredns的实现，它是基于 caddy 框架实现的，充分利用了 caddy 的插件功能。由于 coredns 大多数功能都是利用插件功能来实现的，所以整个项目的代码理解">
<meta itemprop="datePublished" content="2019-12-12T11:03:08&#43;08:00" />
<meta itemprop="dateModified" content="2019-12-12T11:03:08&#43;08:00" />
<meta itemprop="wordCount" content="4560">



<meta itemprop="keywords" content="coredns," /><meta property="og:title" content="Coredns 启动流程分析" />
<meta property="og:description" content="最近在看coredns的实现，它是基于 caddy 框架实现的，充分利用了 caddy 的插件功能。由于 coredns 大多数功能都是利用插件功能来实现的，所以整个项目的代码理解" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://wangzeping722.github.io/posts/coredns-startup/" />
<meta property="article:published_time" content="2019-12-12T11:03:08+08:00" />
<meta property="article:modified_time" content="2019-12-12T11:03:08+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Coredns 启动流程分析"/>
<meta name="twitter:description" content="最近在看coredns的实现，它是基于 caddy 框架实现的，充分利用了 caddy 的插件功能。由于 coredns 大多数功能都是利用插件功能来实现的，所以整个项目的代码理解"/>

	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
	<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
	<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
	<link rel="manifest" href="/site.webmanifest">
	<link rel="mask-icon" href="/safari-pinned-tab.svg" color="">
	<link rel="shortcut icon" href="/favicon.ico">

	<title>Coredns 启动流程分析</title>
	<link rel="stylesheet" href="https://wangzeping722.github.io/css/style.min.eac77496566fd7d5768fd650ddb0b2b181ca6a2d7c5fdd6fe6b8ba4bf47e566f.css" integrity="sha256-6sd0llZv19V2j9ZQ3bCysYHKai18X91v5ri6S/R+Vm8=" crossorigin="anonymous">
	
</head>

<body id="page">
	
	<header id="site-header" class="animated slideInUp">
		<div class="hdr-wrapper section-inner">
			<div class="hdr-left">
				<div class="site-branding">
					<a href="https://wangzeping722.github.io/">Wrong</a>
				</div>
				<nav class="site-nav hide-in-mobile">
					
				<a href="https://wangzeping722.github.io/posts/">Posts</a>
				<a href="https://wangzeping722.github.io/about/">About</a>

				</nav>
			</div>
			<div class="hdr-right hdr-icons">
				<span class="hdr-social hide-in-mobile"><a href="https://github.com/wangzeping722" target="_blank" rel="noopener me" title="Github"><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg></a></span><button id="menu-btn" class="hdr-btn" title=""><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></button>
			</div>
		</div>
	</header>
	<div id="mobile-menu" class="animated fast">
		<ul>
			<li><a href="https://wangzeping722.github.io/posts/">Posts</a></li>
			<li><a href="https://wangzeping722.github.io/about/">About</a></li>
		</ul>
	</div>


	<main class="site-main section-inner animated fadeIn faster">
		<article class="thin">
			<header class="post-header">
				<div class="post-meta"><span>Dec 12, 2019</span></div>
				<h1>Coredns 启动流程分析</h1>
			</header>
			<div class="content">
				<p>最近在看<code>coredns</code>的实现，它是基于 <a href="https://github.com/caddyserver/caddy">caddy</a> 框架实现的，充分利用了 caddy 的插件功能。由于 coredns 大多数功能都是利用插件功能来实现的，所以整个项目的代码理解起来都比较简单。</p>
<h4 id="coredns-的实现">CoreDNS 的实现<a href="#coredns-的实现" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h4>
<p>首先来看根目录下的 <code>Makefile</code> ，其中有自动生成 <code>core/plugin/zplugin.go</code> 文件和 <code>core/dnsserver/zdirectives.go</code> 文件的命令：</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="nf">core/plugin/zplugin.go core/dnsserver/zdirectives.go</span><span class="o">:</span> <span class="n">plugin</span>.<span class="n">cfg</span>
	go generate coredns.go
</code></pre></div><p>该命令可以通过 <code>plugin.cfg</code> 中列出的插件列表自动生成 zplugin.go 和 zdirectives.go 中的代码：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// generated by directives_generate.go; DO NOT EDIT
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">plugin</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="c1">// Include all plugins.
</span><span class="c1"></span>	<span class="nx">_</span> <span class="s">&#34;github.com/caddyserver/caddy/onevent&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/acl&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/any&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/auto&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/autopath&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/azure&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/bind&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/bufsize&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/cache&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/cancel&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/chaos&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/clouddns&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/debug&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/dnssec&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/dnstap&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/erratic&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/errors&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/etcd&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/file&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/forward&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/grpc&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/health&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/hosts&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/k8s_external&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/kubernetes&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/loadbalance&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/log&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/loop&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/metadata&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/metrics&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/nsid&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/pprof&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/ready&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/reload&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/rewrite&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/root&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/route53&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/secondary&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/sign&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/template&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/tls&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/trace&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/transfer&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/whoami&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/federation&#34;</span>
<span class="p">)</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// generated by directives_generate.go; DO NOT EDIT
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">dnsserver</span>

<span class="kd">var</span> <span class="nx">Directives</span> <span class="p">=</span> <span class="p">[</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
	<span class="s">&#34;metadata&#34;</span><span class="p">,</span>
	<span class="s">&#34;cancel&#34;</span><span class="p">,</span>
	<span class="s">&#34;tls&#34;</span><span class="p">,</span>
	<span class="s">&#34;reload&#34;</span><span class="p">,</span>
	<span class="s">&#34;nsid&#34;</span><span class="p">,</span>
	<span class="s">&#34;bufsize&#34;</span><span class="p">,</span>
	<span class="s">&#34;root&#34;</span><span class="p">,</span>
	<span class="s">&#34;bind&#34;</span><span class="p">,</span>
	<span class="s">&#34;debug&#34;</span><span class="p">,</span>
	<span class="s">&#34;trace&#34;</span><span class="p">,</span>
	<span class="s">&#34;ready&#34;</span><span class="p">,</span>
	<span class="s">&#34;health&#34;</span><span class="p">,</span>
	<span class="s">&#34;pprof&#34;</span><span class="p">,</span>
	<span class="s">&#34;prometheus&#34;</span><span class="p">,</span>
	<span class="s">&#34;errors&#34;</span><span class="p">,</span>
	<span class="s">&#34;log&#34;</span><span class="p">,</span>
	<span class="s">&#34;dnstap&#34;</span><span class="p">,</span>
	<span class="s">&#34;acl&#34;</span><span class="p">,</span>
	<span class="s">&#34;any&#34;</span><span class="p">,</span>
	<span class="s">&#34;chaos&#34;</span><span class="p">,</span>
	<span class="s">&#34;loadbalance&#34;</span><span class="p">,</span>
	<span class="s">&#34;cache&#34;</span><span class="p">,</span>
	<span class="s">&#34;rewrite&#34;</span><span class="p">,</span>
	<span class="s">&#34;dnssec&#34;</span><span class="p">,</span>
	<span class="s">&#34;autopath&#34;</span><span class="p">,</span>
	<span class="s">&#34;template&#34;</span><span class="p">,</span>
	<span class="s">&#34;transfer&#34;</span><span class="p">,</span>
	<span class="s">&#34;hosts&#34;</span><span class="p">,</span>
	<span class="s">&#34;route53&#34;</span><span class="p">,</span>
	<span class="s">&#34;azure&#34;</span><span class="p">,</span>
	<span class="s">&#34;clouddns&#34;</span><span class="p">,</span>
	<span class="s">&#34;federation&#34;</span><span class="p">,</span>
	<span class="s">&#34;k8s_external&#34;</span><span class="p">,</span>
	<span class="s">&#34;kubernetes&#34;</span><span class="p">,</span>
	<span class="s">&#34;file&#34;</span><span class="p">,</span>
	<span class="s">&#34;auto&#34;</span><span class="p">,</span>
	<span class="s">&#34;secondary&#34;</span><span class="p">,</span>
	<span class="s">&#34;etcd&#34;</span><span class="p">,</span>
	<span class="s">&#34;loop&#34;</span><span class="p">,</span>
	<span class="s">&#34;forward&#34;</span><span class="p">,</span>
	<span class="s">&#34;grpc&#34;</span><span class="p">,</span>
	<span class="s">&#34;erratic&#34;</span><span class="p">,</span>
	<span class="s">&#34;whoami&#34;</span><span class="p">,</span>
	<span class="s">&#34;on&#34;</span><span class="p">,</span>
	<span class="s">&#34;sign&#34;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div><p>这些代码的作用将在后面解释。</p>
<h5 id="main函数">main函数<a href="#main函数" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h5>
<p>我们先看 <code>coredns.go</code> 中的 main 函数：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="c1">//go:generate go run directives_generate.go
</span><span class="c1"></span><span class="c1">//go:generate go run owners_generate.go
</span><span class="c1"></span>
<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;github.com/coredns/coredns/coremain&#34;</span>

	<span class="c1">// 初始化所有插件
</span><span class="c1"></span>	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/core/plugin&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">coremain</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>想必大家都很熟悉 <code>_ &quot;github.com/coredns/coredns/core/plugin&quot;</code> 这一用法，目的就是想执行包 github.com/coredns/coredns/core/plugin 里的 <strong>init</strong> 函数。这时再回头看看 <code>core/plugin/zplugin.go</code> 中的代码，原来它又接着导入了所有在 <strong>plugin.cfg</strong> 中声明的插件的包，并且执行包里的 <strong>init</strong> 函数。这就使得所有的插件都会在 caddy 中注册自己，例如插件 file 的注册如下：</p>
<p><img src="file-init.png" alt="file-init"></p>
<p><img src="register.png" alt="register plugin"></p>
<p><code>caddy.Plugin</code> 结构包含了被注册的插件的基本信息,包括注册的服务类型(在CoreDNS中的服务类型是 <code>dns</code> )和请求这个插件时,这个插件该做的 Action。</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Plugin is a type which holds information about a plugin.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Plugin</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="c1">// ServerType is the type of server this plugin is for.
</span><span class="c1"></span>	<span class="c1">// Can be empty if not applicable, or if the plugin
</span><span class="c1"></span>	<span class="c1">// can associate with any server type.
</span><span class="c1"></span>	<span class="nx">ServerType</span> <span class="kt">string</span>

	<span class="c1">// Action is the plugin&#39;s setup function, if associated
</span><span class="c1"></span>	<span class="c1">// with a directive in the Caddyfile.
</span><span class="c1"></span>	<span class="nx">Action</span> <span class="nx">SetupFunc</span>
<span class="p">}</span>
</code></pre></div><p>caddy.RegisterPlugin方法的作用:</p>
<p>将指定plugin name(本示例:kubernetes)注册到服务类型为DNS的CoreDNS服务中。最终所有被注册plugin的存储结构为:</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// plugins is a map of server type to map of plugin name to
</span><span class="c1"></span><span class="c1">// Plugin. These are the &#34;general&#34; plugins that may or may
</span><span class="c1"></span><span class="c1">// not be associated with a specific server type. If it&#39;s
</span><span class="c1"></span><span class="c1">// applicable to multiple server types or the server type is
</span><span class="c1"></span><span class="c1">// irrelevant, the key is empty string (&#34;&#34;). But all plugins
</span><span class="c1"></span><span class="c1">// must have a name.
</span><span class="c1"></span><span class="nx">plugins</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">Plugin</span><span class="p">)</span>
</code></pre></div><p>因此，通过上面的这个过程就把CoreDNS需要的所有的plugin都注册到了 <code>plugins = make(map[string]map[string]Plugin)</code> 结构中，用于后续的使用。</p>
<p>注册完所有的 plugin 之后，就开始执行 main 方法。接着会去调用 <code>coremain.Run()</code> 函数，通过 <code>Run</code> 方法进入 CoreDNS 的初始化过程。需要注意的是，run.go 引入了包 <code>github.com/coredns/coredns/core/dnsserver</code> ，里面也包含了<strong>init</strong> 方法：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">const</span> <span class="nx">serverType</span> <span class="p">=</span> <span class="s">&#34;dns&#34;</span>

<span class="c1">// Any flags defined here, need to be namespaced to the serverType other
</span><span class="c1"></span><span class="c1">// wise they potentially clash with other server types.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">init</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">Port</span><span class="p">,</span> <span class="nx">serverType</span><span class="o">+</span><span class="s">&#34;.port&#34;</span><span class="p">,</span> <span class="nx">DefaultPort</span><span class="p">,</span> <span class="s">&#34;Default port&#34;</span><span class="p">)</span>

	<span class="nx">caddy</span><span class="p">.</span><span class="nf">RegisterServerType</span><span class="p">(</span><span class="nx">serverType</span><span class="p">,</span> <span class="nx">caddy</span><span class="p">.</span><span class="nx">ServerType</span><span class="p">{</span>
		<span class="nx">Directives</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">[</span><span class="p">]</span><span class="kt">string</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Directives</span> <span class="p">}</span><span class="p">,</span>
		<span class="nx">DefaultInput</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="nx">caddy</span><span class="p">.</span><span class="nx">Input</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">caddy</span><span class="p">.</span><span class="nx">CaddyfileInput</span><span class="p">{</span>
				<span class="nx">Filepath</span><span class="p">:</span>       <span class="s">&#34;Corefile&#34;</span><span class="p">,</span>
				<span class="nx">Contents</span><span class="p">:</span>       <span class="p">[</span><span class="p">]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;.:&#34;</span> <span class="o">+</span> <span class="nx">Port</span> <span class="o">+</span> <span class="s">&#34; {\nwhoami\nlog\n}\n&#34;</span><span class="p">)</span><span class="p">,</span>
				<span class="nx">ServerTypeName</span><span class="p">:</span> <span class="nx">serverType</span><span class="p">,</span>
			<span class="p">}</span>
		<span class="p">}</span><span class="p">,</span>
		<span class="nx">NewContext</span><span class="p">:</span> <span class="nx">newContext</span><span class="p">,</span>
	<span class="p">}</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>这里会向 caddy 注册一个名为 <code>dns</code> 的服务类型，并关联与这个 dns 服务类型相关的一些操作和信息，包括：</p>
<ul>
<li>插件的执行顺序</li>
<li>默认配置文件</li>
<li><code>newContext</code>就是<code>dnsContext</code>对象，实现了 caddy 的 Context 接口</li>
</ul>
<p>进入 run.go 的 init 函数，这里以注释的形式展示：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">init</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// 默认配置文件
</span><span class="c1"></span>	<span class="nx">caddy</span><span class="p">.</span><span class="nx">DefaultConfigFile</span> <span class="p">=</span> <span class="s">&#34;Corefile&#34;</span>
	<span class="nx">caddy</span><span class="p">.</span><span class="nx">Quiet</span> <span class="p">=</span> <span class="kc">true</span> <span class="c1">// don&#39;t show init stuff from caddy
</span><span class="c1"></span>	<span class="nf">setVersion</span><span class="p">(</span><span class="p">)</span>	<span class="c1">// 设置版本信息
</span><span class="c1"></span>
	<span class="c1">// 指定需要加载的配置文件
</span><span class="c1"></span>	<span class="nx">flag</span><span class="p">.</span><span class="nf">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">conf</span><span class="p">,</span> <span class="s">&#34;conf&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;Corefile to load (default \&#34;&#34;</span><span class="o">+</span><span class="nx">caddy</span><span class="p">.</span><span class="nx">DefaultConfigFile</span><span class="o">+</span><span class="s">&#34;\&#34;)&#34;</span><span class="p">)</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">BoolVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">plugins</span><span class="p">,</span> <span class="s">&#34;plugins&#34;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s">&#34;List installed plugins&#34;</span><span class="p">)</span>
	<span class="c1">// 需要将PIDfile写入的地址
</span><span class="c1"></span>	<span class="nx">flag</span><span class="p">.</span><span class="nf">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">caddy</span><span class="p">.</span><span class="nx">PidFile</span><span class="p">,</span> <span class="s">&#34;pidfile&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;Path to write pid file&#34;</span><span class="p">)</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">BoolVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">version</span><span class="p">,</span> <span class="s">&#34;version&#34;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s">&#34;Show version&#34;</span><span class="p">)</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">BoolVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">dnsserver</span><span class="p">.</span><span class="nx">Quiet</span><span class="p">,</span> <span class="s">&#34;quiet&#34;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s">&#34;Quiet mode (no initialization output)&#34;</span><span class="p">)</span>

  <span class="c1">// 与加载配置文件有关
</span><span class="c1"></span>	<span class="nx">caddy</span><span class="p">.</span><span class="nf">RegisterCaddyfileLoader</span><span class="p">(</span><span class="s">&#34;flag&#34;</span><span class="p">,</span> <span class="nx">caddy</span><span class="p">.</span><span class="nf">LoaderFunc</span><span class="p">(</span><span class="nx">confLoader</span><span class="p">)</span><span class="p">)</span>
	<span class="nx">caddy</span><span class="p">.</span><span class="nf">SetDefaultCaddyfileLoader</span><span class="p">(</span><span class="s">&#34;default&#34;</span><span class="p">,</span> <span class="nx">caddy</span><span class="p">.</span><span class="nf">LoaderFunc</span><span class="p">(</span><span class="nx">defaultLoader</span><span class="p">)</span><span class="p">)</span>

	<span class="nx">caddy</span><span class="p">.</span><span class="nx">AppName</span> <span class="p">=</span> <span class="nx">coreName</span>
	<span class="nx">caddy</span><span class="p">.</span><span class="nx">AppVersion</span> <span class="p">=</span> <span class="nx">CoreVersion</span>
<span class="p">}</span>
</code></pre></div><p>做了那么多准备工作，终于要进入主方法了，我们来看 run.go 中的 Run 方法：</p>
<p>其他的代码我们就不关心了，直接看 :</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">corefile</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">caddy</span><span class="p">.</span><span class="nf">LoadCaddyfile</span><span class="p">(</span><span class="nx">serverType</span><span class="p">)</span>
</code></pre></div><p>该函数主要就是利用 coredns 注册的两个方法解析并加载配置文件到 <code>corefile</code>中，corefile 对应的结构体定义如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Input represents a Caddyfile; its contents and file path
</span><span class="c1"></span><span class="c1">// (which should include the file name at the end of the path).
</span><span class="c1"></span><span class="c1">// If path does not apply (e.g. piped input) you may use
</span><span class="c1"></span><span class="c1">// any understandable value. The path is mainly used for logging,
</span><span class="c1"></span><span class="c1">// error messages, and debugging.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Input</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// Gets the Caddyfile contents
</span><span class="c1"></span>	<span class="nf">Body</span><span class="p">(</span><span class="p">)</span> <span class="p">[</span><span class="p">]</span><span class="kt">byte</span>

	<span class="c1">// Gets the path to the origin file
</span><span class="c1"></span>	<span class="nf">Path</span><span class="p">(</span><span class="p">)</span> <span class="kt">string</span>

	<span class="c1">// The type of server this input is intended for
</span><span class="c1"></span>	<span class="nf">ServerType</span><span class="p">(</span><span class="p">)</span> <span class="kt">string</span>
<span class="p">}</span>
</code></pre></div><p>有了 <code>corefile</code> 我们就能够启动服务器啦：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">instance</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">caddy</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">corefile</span><span class="p">)</span>
</code></pre></div><p>Start 的细节我们接下来再说，我们先把主流程看完，Start 会返回一个 instance 结构，其包含了服务的状态，并且可以用来控制和访问这些服务：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Instance contains the state of servers created as a result of
</span><span class="c1"></span><span class="c1">// calling Start and can be used to access or control those servers.
</span><span class="c1"></span><span class="c1">// It is literally an instance of a server type. Instance values
</span><span class="c1"></span><span class="c1">// should NOT be copied. Use *Instance for safety.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Instance</span> <span class="kd">struct</span> <span class="p">{</span>
   <span class="c1">// serverType is the name of the instance&#39;s server type
</span><span class="c1"></span>   <span class="nx">serverType</span> <span class="kt">string</span>

   <span class="c1">// caddyfileInput is the input configuration text used for this process
</span><span class="c1"></span>   <span class="nx">caddyfileInput</span> <span class="nx">Input</span>

   <span class="c1">// wg is used to wait for all servers to shut down
</span><span class="c1"></span>   <span class="nx">wg</span> <span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>

   <span class="c1">// context is the context created for this instance,
</span><span class="c1"></span>   <span class="c1">// used to coordinate the setting up of the server type
</span><span class="c1"></span>   <span class="nx">context</span> <span class="nx">Context</span>

   <span class="c1">// servers is the list of servers with their listeners
</span><span class="c1"></span>   <span class="nx">servers</span> <span class="p">[</span><span class="p">]</span><span class="nx">ServerListener</span>

   <span class="c1">// these callbacks execute when certain events occur
</span><span class="c1"></span>   <span class="nx">OnFirstStartup</span>  <span class="p">[</span><span class="p">]</span><span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="kt">error</span> <span class="c1">// starting, not as part of a restart
</span><span class="c1"></span>   <span class="nx">OnStartup</span>       <span class="p">[</span><span class="p">]</span><span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="kt">error</span> <span class="c1">// starting, even as part of a restart
</span><span class="c1"></span>   <span class="nx">OnRestart</span>       <span class="p">[</span><span class="p">]</span><span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="kt">error</span> <span class="c1">// before restart commences
</span><span class="c1"></span>   <span class="nx">OnRestartFailed</span> <span class="p">[</span><span class="p">]</span><span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="kt">error</span> <span class="c1">// if restart failed
</span><span class="c1"></span>   <span class="nx">OnShutdown</span>      <span class="p">[</span><span class="p">]</span><span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="kt">error</span> <span class="c1">// stopping, even as part of a restart
</span><span class="c1"></span>   <span class="nx">OnFinalShutdown</span> <span class="p">[</span><span class="p">]</span><span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="kt">error</span> <span class="c1">// stopping, not as part of a restart
</span><span class="c1"></span>
   <span class="c1">// storing values on an instance is preferable to
</span><span class="c1"></span>   <span class="c1">// global state because these will get garbage-
</span><span class="c1"></span>   <span class="c1">// collected after in-process reloads when the
</span><span class="c1"></span>   <span class="c1">// old instances are destroyed; use StorageMu
</span><span class="c1"></span>   <span class="c1">// to access this value safely
</span><span class="c1"></span>   <span class="nx">Storage</span>   <span class="kd">map</span><span class="p">[</span><span class="kd">interface</span><span class="p">{</span><span class="p">}</span><span class="p">]</span><span class="kd">interface</span><span class="p">{</span><span class="p">}</span>
   <span class="nx">StorageMu</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
<span class="p">}</span>

<span class="c1">// ServerListener pairs a server to its listener and/or packetconn.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ServerListener</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">server</span>   <span class="nx">Server</span>
	<span class="nx">listener</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span>
	<span class="nx">packet</span>   <span class="nx">net</span><span class="p">.</span><span class="nx">PacketConn</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Server</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">TCPServer</span>
	<span class="nx">UDPServer</span>
<span class="p">}</span>
</code></pre></div><ul>
<li>serverType：表示该 instance 的服务类型，在 coredns 中是 <code>dns</code></li>
<li>caddyfileInput：表示配置文件</li>
<li>wg：wg 用来等待所有的服务器关闭</li>
<li>context：启动服务时需要的一些上下文配置，在 coredns 中，这个 context 就是 <code>dnsContext</code></li>
<li>servers：该 instance 需要启动的服务列表，从上面的代码中可以看出，主要是 <code>TCP</code> 和 <code>UDP</code> 服务。</li>
<li>Onxxx：on 开头的方法可以看成当特定事件发生时候的回调函数</li>
<li>Storage：用来存储全局状态</li>
</ul>
<p>然后主函数阻塞在instance.Wait()上面。</p>
<hr>
<p>接下来，我们来看 Start 函数：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Start starts Caddy with the given Caddyfile.
</span><span class="c1"></span><span class="c1">//
</span><span class="c1"></span><span class="c1">// This function blocks until all the servers are listening.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Start</span><span class="p">(</span><span class="nx">cdyfile</span> <span class="nx">Input</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Instance</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">inst</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Instance</span><span class="p">{</span><span class="nx">serverType</span><span class="p">:</span> <span class="nx">cdyfile</span><span class="p">.</span><span class="nf">ServerType</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="nx">wg</span><span class="p">:</span> <span class="nb">new</span><span class="p">(</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">)</span><span class="p">,</span> <span class="nx">Storage</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kd">interface</span><span class="p">{</span><span class="p">}</span><span class="p">]</span><span class="kd">interface</span><span class="p">{</span><span class="p">}</span><span class="p">)</span><span class="p">}</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nf">startWithListenerFds</span><span class="p">(</span><span class="nx">cdyfile</span><span class="p">,</span> <span class="nx">inst</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">inst</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nf">signalSuccessToParent</span><span class="p">(</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">pidErr</span> <span class="o">:=</span> <span class="nf">writePidFile</span><span class="p">(</span><span class="p">)</span><span class="p">;</span> <span class="nx">pidErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;[ERROR] Could not write pidfile: %v&#34;</span><span class="p">,</span> <span class="nx">pidErr</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// Execute instantiation events
</span><span class="c1"></span>	<span class="nf">EmitEvent</span><span class="p">(</span><span class="nx">InstanceStartupEvent</span><span class="p">,</span> <span class="nx">inst</span><span class="p">)</span>

	<span class="k">return</span> <span class="nx">inst</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>可以看见，他首先初始化了一个 Instance 结构体，在该函数中主要调用三个函数分别是:</p>
<ul>
<li>startWithListenerFds: 用于解析 Corefile 配置文件及校验指令执行的是否正确，并启动CoreDNS服务。</li>
<li>signalSuccessToParent: 向父进程报告服务启动状态。</li>
<li>writePidFile: 将启动服务的进程 ID(PID) 写入到指定的文件。</li>
</ul>
<p>从上面的解释中即可知道 startWithListenerFds 是最为核心的函数调用了，接下来直接详细的分析startWithListenerFds 函数。在该函数中首先会调用</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">err</span> <span class="p">=</span> <span class="nf">ValidateAndExecuteDirectives</span><span class="p">(</span><span class="nx">cdyfile</span><span class="p">,</span> <span class="nx">inst</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</code></pre></div><p>从名字就可以看出这个函数的主要功能就是验证和执行指令（也就是插件），首先他会调用</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">sblocks</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">loadServerBlocks</span><span class="p">(</span><span class="nx">stypeName</span><span class="p">,</span> <span class="nx">cdyfile</span><span class="p">.</span><span class="nf">Path</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">cdyfile</span><span class="p">.</span><span class="nf">Body</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">)</span>
</code></pre></div><p>来解析配置文件中的内容，如果配置文件中出现了coredns无法识别的插件，那么就会直接返回错误，程序终止，如果解析成功，那么就会把配置文件中的内容映射到 ServerBlock 结构体中：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// ServerBlock associates any number of keys (usually addresses
</span><span class="c1"></span><span class="c1">// of some sort) with tokens (grouped by directive name).
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ServerBlock</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Keys</span>   <span class="p">[</span><span class="p">]</span><span class="kt">string</span>
	<span class="nx">Tokens</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="p">[</span><span class="p">]</span><span class="nx">Token</span>
<span class="p">}</span>
</code></pre></div><p>其中，keys 用来存储配置文件中 Zone 的相关数据，而 Tokens 则用来存储该 server 中的插件的相关信息，其中 Tokens 的 key 是 plugin name , []Token 存储的是该 plugin 在 Corefile 中的位置，便于后续的解析操作。可能不太好理解，但是对应配置文件就非常好理解啦：</p>
<pre><code class="language-Corefile" data-lang="Corefile">// coredns.io:5300 为 keys
coredns.io:5300 {
    file db.coredns.io
}

example.io:53 {
    log
    errors
    file db.example.io
}

example.net:53 {
    file db.example.net
}

.:53 {
    kubernetes
    proxy . 8.8.8.8
    log
    errors
    cache
}
</code></pre><p><img src="debug.png" alt=""></p>
<p>如上图，对应的 zone 就是 <code>example.io:53</code>，其中包含三个插件，所以 Tokens 有三个元素，其中 file 插件对应的value 的长度为 2。</p>
<p>接着，会调用</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">inst</span><span class="p">.</span><span class="nx">context</span> <span class="p">=</span> <span class="nx">stype</span><span class="p">.</span><span class="nf">NewContext</span><span class="p">(</span><span class="nx">inst</span><span class="p">)</span>
</code></pre></div><p>这里的 stype.NewContext 就是在初始化阶段赋值给他的 <code>newContext</code>函数：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">newContext</span><span class="p">(</span><span class="nx">i</span> <span class="o">*</span><span class="nx">caddy</span><span class="p">.</span><span class="nx">Instance</span><span class="p">)</span> <span class="nx">caddy</span><span class="p">.</span><span class="nx">Context</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">dnsContext</span><span class="p">{</span><span class="nx">keysToConfigs</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">Config</span><span class="p">)</span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// dnsContext
</span><span class="c1"></span><span class="c1">// 实现了caddy.Context接口
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">dnsContext</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">keysToConfigs</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">Config</span>

	<span class="c1">// configs is the master list of all site configs.
</span><span class="c1"></span>	<span class="c1">// configs是所有站点配置的主列表。
</span><span class="c1"></span>	<span class="nx">configs</span> <span class="p">[</span><span class="p">]</span><span class="o">*</span><span class="nx">Config</span>
<span class="p">}</span>

<span class="nx">Context</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// Called after the Caddyfile is parsed into server
</span><span class="c1"></span>	<span class="c1">// blocks but before the directives are executed,
</span><span class="c1"></span>	<span class="c1">// this method gives you an opportunity to inspect
</span><span class="c1"></span>	<span class="c1">// the server blocks and prepare for the execution
</span><span class="c1"></span>	<span class="c1">// of directives. Return the server blocks (which
</span><span class="c1"></span>	<span class="c1">// you may modify, if desired) and an error, if any.
</span><span class="c1"></span>	<span class="c1">// The first argument is the name or path to the
</span><span class="c1"></span>	<span class="c1">// configuration file (Caddyfile).
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// This function can be a no-op and simply return its
</span><span class="c1"></span>	<span class="c1">// input if there is nothing to do here.
</span><span class="c1"></span>	<span class="nf">InspectServerBlocks</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="p">[</span><span class="p">]</span><span class="nx">caddyfile</span><span class="p">.</span><span class="nx">ServerBlock</span><span class="p">)</span> <span class="p">(</span><span class="p">[</span><span class="p">]</span><span class="nx">caddyfile</span><span class="p">.</span><span class="nx">ServerBlock</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// This is what Caddy calls to make server instances.
</span><span class="c1"></span>	<span class="c1">// By this time, all directives have been executed and,
</span><span class="c1"></span>	<span class="c1">// presumably, the context has enough state to produce
</span><span class="c1"></span>	<span class="c1">// server instances for Caddy to start.
</span><span class="c1"></span>	<span class="nf">MakeServers</span><span class="p">(</span><span class="p">)</span> <span class="p">(</span><span class="p">[</span><span class="p">]</span><span class="nx">Server</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>所以，创建一个实现了 <code>caddy.Context</code> 接口的 <code>dnsContext</code>结构体，并赋值给 <code>instance.Context</code>，然后调用 Context 的接口方法 InspectServerBlocks ，这个函数会在解析完Corefile文件之后，执行Corefile中的指令之前会被调用，用于进一步的对 sblocks 进行检查并进行进一步的参数完善。：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">sblocks</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">inst</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nf">InspectServerBlocks</span><span class="p">(</span><span class="nx">cdyfile</span><span class="p">.</span><span class="nf">Path</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="nx">sblocks</span><span class="p">)</span>
</code></pre></div><p>等上面的准备工作准备完成之后，会调用<code>executeDirectives</code>去遍历所有的指令<code>directives</code>,并执行每个 sblocks 中的指令,并设置相应的 Controller 去执行相关 plugin 的 action 动作, 每个 serverblock 中的插件的 setup 只执行一次:</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">executeDirectives</span><span class="p">(</span><span class="nx">inst</span> <span class="o">*</span><span class="nx">Instance</span><span class="p">,</span> <span class="nx">filename</span> <span class="kt">string</span><span class="p">,</span>
   <span class="nx">directives</span> <span class="p">[</span><span class="p">]</span><span class="kt">string</span><span class="p">,</span> <span class="nx">sblocks</span> <span class="p">[</span><span class="p">]</span><span class="nx">caddyfile</span><span class="p">.</span><span class="nx">ServerBlock</span><span class="p">,</span> <span class="nx">justValidate</span> <span class="kt">bool</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
   <span class="c1">// map of server block ID to map of directive name to whatever.
</span><span class="c1"></span>   <span class="nx">storages</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{</span><span class="p">}</span><span class="p">)</span>

   <span class="c1">// It is crucial that directives are executed in the proper order.
</span><span class="c1"></span>   <span class="c1">// We loop with the directives on the outer loop so we execute
</span><span class="c1"></span>   <span class="c1">// a directive for all server blocks before going to the next directive.
</span><span class="c1"></span>   <span class="c1">// This is important mainly due to the parsing callbacks (below).
</span><span class="c1"></span>   <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">dir</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">directives</span> <span class="p">{</span>
      <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">sb</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">sblocks</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">once</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Once</span>
         <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">storages</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="p">;</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
            <span class="nx">storages</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{</span><span class="p">}</span><span class="p">)</span>
         <span class="p">}</span>

         <span class="k">for</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">key</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">Keys</span> <span class="p">{</span>
            <span class="c1">// Execute directive if it is in the server block
</span><span class="c1"></span>            <span class="k">if</span> <span class="nx">tokens</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">Tokens</span><span class="p">[</span><span class="nx">dir</span><span class="p">]</span><span class="p">;</span> <span class="nx">ok</span> <span class="p">{</span>
               <span class="nx">controller</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Controller</span><span class="p">{</span>
                  <span class="nx">instance</span><span class="p">:</span>  <span class="nx">inst</span><span class="p">,</span>
                  <span class="nx">Key</span><span class="p">:</span>       <span class="nx">key</span><span class="p">,</span>
                  <span class="nx">Dispenser</span><span class="p">:</span> <span class="nx">caddyfile</span><span class="p">.</span><span class="nf">NewDispenserTokens</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">)</span><span class="p">,</span>
                  <span class="nx">OncePerServerBlock</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">f</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
                     <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
                     <span class="nx">once</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">err</span> <span class="p">=</span> <span class="nf">f</span><span class="p">(</span><span class="p">)</span>
                     <span class="p">}</span><span class="p">)</span>
                     <span class="k">return</span> <span class="nx">err</span>
                  <span class="p">}</span><span class="p">,</span>
                  <span class="nx">ServerBlockIndex</span><span class="p">:</span>    <span class="nx">i</span><span class="p">,</span>
                  <span class="nx">ServerBlockKeyIndex</span><span class="p">:</span> <span class="nx">j</span><span class="p">,</span>
                  <span class="nx">ServerBlockKeys</span><span class="p">:</span>     <span class="nx">sb</span><span class="p">.</span><span class="nx">Keys</span><span class="p">,</span>
                  <span class="nx">ServerBlockStorage</span><span class="p">:</span>  <span class="nx">storages</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="p">[</span><span class="nx">dir</span><span class="p">]</span><span class="p">,</span>
               <span class="p">}</span>

               <span class="nx">setup</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">DirectiveAction</span><span class="p">(</span><span class="nx">inst</span><span class="p">.</span><span class="nx">serverType</span><span class="p">,</span> <span class="nx">dir</span><span class="p">)</span>
               <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="nx">err</span>
               <span class="p">}</span>

               <span class="nx">err</span> <span class="p">=</span> <span class="nf">setup</span><span class="p">(</span><span class="nx">controller</span><span class="p">)</span>
               <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="nx">err</span>
               <span class="p">}</span>

               <span class="nx">storages</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="p">[</span><span class="nx">dir</span><span class="p">]</span> <span class="p">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">ServerBlockStorage</span> <span class="c1">// persist for this server block
</span><span class="c1"></span>            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">!</span><span class="nx">justValidate</span> <span class="p">{</span>
         <span class="c1">// See if there are any callbacks to execute after this directive
</span><span class="c1"></span>         <span class="k">if</span> <span class="nx">allCallbacks</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">parsingCallbacks</span><span class="p">[</span><span class="nx">inst</span><span class="p">.</span><span class="nx">serverType</span><span class="p">]</span><span class="p">;</span> <span class="nx">ok</span> <span class="p">{</span>
            <span class="nx">callbacks</span> <span class="o">:=</span> <span class="nx">allCallbacks</span><span class="p">[</span><span class="nx">dir</span><span class="p">]</span>
            <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">callback</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">callbacks</span> <span class="p">{</span>
               <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">callback</span><span class="p">(</span><span class="nx">inst</span><span class="p">.</span><span class="nx">context</span><span class="p">)</span><span class="p">;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="nx">err</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>执行完了 <code>ValidateAndExecuteDirectives</code> 函数，就意味着所有的插件都已经准备完毕，接着调用 <code>MakeServers</code>返回一个服务器列表：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">slist</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">inst</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nf">MakeServers</span><span class="p">(</span><span class="p">)</span>
</code></pre></div><p>我们深入进去会发现，这个方法其实非常简单：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// MakeServers uses the newly-created siteConfigs to create and return a list of server instances.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">dnsContext</span><span class="p">)</span> <span class="nf">MakeServers</span><span class="p">(</span><span class="p">)</span> <span class="p">(</span><span class="p">[</span><span class="p">]</span><span class="nx">caddy</span><span class="p">.</span><span class="nx">Server</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>

   <span class="c1">// Now that all Keys and Directives are parsed and initialized
</span><span class="c1"></span>   <span class="c1">// lets verify that there is no overlap on the zones and addresses to listen for
</span><span class="c1"></span>   <span class="nx">errValid</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nf">validateZonesAndListeningAddresses</span><span class="p">(</span><span class="p">)</span>
   <span class="k">if</span> <span class="nx">errValid</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errValid</span>
   <span class="p">}</span>

   <span class="c1">// we must map (group) each config to a bind address
</span><span class="c1"></span>   <span class="nx">groups</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">groupConfigsByListenAddr</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">configs</span><span class="p">)</span>
   <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
   <span class="p">}</span>
   <span class="c1">// then we create a server for each group
</span><span class="c1"></span>   <span class="kd">var</span> <span class="nx">servers</span> <span class="p">[</span><span class="p">]</span><span class="nx">caddy</span><span class="p">.</span><span class="nx">Server</span>
   <span class="k">for</span> <span class="nx">addr</span><span class="p">,</span> <span class="nx">group</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">groups</span> <span class="p">{</span>
      <span class="c1">// switch on addr
</span><span class="c1"></span>      <span class="k">switch</span> <span class="nx">tr</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">parse</span><span class="p">.</span><span class="nf">Transport</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span><span class="p">;</span> <span class="nx">tr</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nx">transport</span><span class="p">.</span><span class="nx">DNS</span><span class="p">:</span>
         <span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewServer</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">group</span><span class="p">)</span>
         <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
         <span class="p">}</span>
         <span class="nx">servers</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">servers</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>

      <span class="k">case</span> <span class="nx">transport</span><span class="p">.</span><span class="nx">TLS</span><span class="p">:</span>
         <span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewServerTLS</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">group</span><span class="p">)</span>
         <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
         <span class="p">}</span>
         <span class="nx">servers</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">servers</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>

      <span class="k">case</span> <span class="nx">transport</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">:</span>
         <span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewServergRPC</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">group</span><span class="p">)</span>
         <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
         <span class="p">}</span>
         <span class="nx">servers</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">servers</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>

      <span class="k">case</span> <span class="nx">transport</span><span class="p">.</span><span class="nx">HTTPS</span><span class="p">:</span>
         <span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewServerHTTPS</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">group</span><span class="p">)</span>
         <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
         <span class="p">}</span>
         <span class="nx">servers</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">servers</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
      <span class="p">}</span>

   <span class="p">}</span>

   <span class="k">return</span> <span class="nx">servers</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>首先，它验证是否有端口冲突（同一zone，并且同一端口才算冲突），然后再根据 dnsContext 中的 <code>configs</code>生成不同的 <code>group</code>，根据监听的端口不同被分到不同的 group，最后返回一个 <code>groups</code>，之后遍历该 <code>groups</code>, 然后根据不同的 transport 去启动相应的服务，当前 CoreDNS 支持4种类型的 transport，默认情况下都是 DNS 。</p>
<p>但是，无论哪种 transport 最终都会调用 <code>NewServer</code>：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">NewServer</span><span class="p">(</span><span class="nx">addr</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">group</span> <span class="p">[</span><span class="p">]</span><span class="o">*</span><span class="nx">Config</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Server</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>

   <span class="nx">s</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Server</span><span class="p">{</span>
      <span class="nx">Addr</span><span class="p">:</span>         <span class="nx">addr</span><span class="p">,</span>
      <span class="nx">zones</span><span class="p">:</span>        <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">Config</span><span class="p">)</span><span class="p">,</span>
      <span class="nx">graceTimeout</span><span class="p">:</span> <span class="mi">5</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
   <span class="p">}</span>
   <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">site</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">group</span> <span class="p">{</span>
      
      <span class="nx">s</span><span class="p">.</span><span class="nx">zones</span><span class="p">[</span><span class="nx">site</span><span class="p">.</span><span class="nx">Zone</span><span class="p">]</span> <span class="p">=</span> <span class="nx">site</span>

      <span class="c1">// compile custom plugin for everything
</span><span class="c1"></span>      <span class="kd">var</span> <span class="nx">stack</span> <span class="nx">plugin</span><span class="p">.</span><span class="nx">Handler</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">Plugin</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span> <span class="p">{</span>
         <span class="nx">stack</span> <span class="p">=</span> <span class="nx">site</span><span class="p">.</span><span class="nx">Plugin</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="p">(</span><span class="nx">stack</span><span class="p">)</span>

         <span class="c1">// register the *handler* also
</span><span class="c1"></span>         <span class="nx">site</span><span class="p">.</span><span class="nf">registerHandler</span><span class="p">(</span><span class="nx">stack</span><span class="p">)</span>

         <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">trace</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">stack</span><span class="p">.</span><span class="nf">Name</span><span class="p">(</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#34;trace&#34;</span> <span class="p">{</span>
            <span class="c1">// we have to stash away the plugin, not the
</span><span class="c1"></span>            <span class="c1">// Tracer object, because the Tracer won&#39;t be initialized yet
</span><span class="c1"></span>            <span class="k">if</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">stack</span><span class="p">.</span><span class="p">(</span><span class="nx">trace</span><span class="p">.</span><span class="nx">Trace</span><span class="p">)</span><span class="p">;</span> <span class="nx">ok</span> <span class="p">{</span>
               <span class="nx">s</span><span class="p">.</span><span class="nx">trace</span> <span class="p">=</span> <span class="nx">t</span>
            <span class="p">}</span>
         <span class="p">}</span>
         <span class="c1">// Unblock CH class queries when any of these plugins are loaded.
</span><span class="c1"></span>         <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">EnableChaos</span><span class="p">[</span><span class="nx">stack</span><span class="p">.</span><span class="nf">Name</span><span class="p">(</span><span class="p">)</span><span class="p">]</span><span class="p">;</span> <span class="nx">ok</span> <span class="p">{</span>
            <span class="nx">s</span><span class="p">.</span><span class="nx">classChaos</span> <span class="p">=</span> <span class="kc">true</span>
         <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">site</span><span class="p">.</span><span class="nx">pluginChain</span> <span class="p">=</span> <span class="nx">stack</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="nx">s</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>由于代码过长，只看重点部分，先创建了一个 <code>Server</code> 变量，然后遍历 group ，并将每个 site 对应的 plugins 以栈的形式组成  <code>pluginChain</code>，最后返回。</p>
<p>上面只是make了CoreDNS需要启动的<code>Server</code>结构,但是真正的服务进程到现在这个阶段还没有真正的启动。当所有的 plugin 需要的准备工作都处理完成之后，就调用<code>startServers</code>来启动CoreDNS服务,<code>startServers</code>函数的定义如下:</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">startServers</span><span class="p">(</span><span class="nx">serverList</span> <span class="p">[</span><span class="p">]</span><span class="nx">Server</span><span class="p">,</span> <span class="nx">inst</span> <span class="o">*</span><span class="nx">Instance</span><span class="p">,</span> <span class="nx">restartFds</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">restartTriple</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
   <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">s</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">serverList</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="p">(</span>
         <span class="nx">ln</span>  <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span>
         <span class="nx">pc</span>  <span class="nx">net</span><span class="p">.</span><span class="nx">PacketConn</span>
         <span class="nx">err</span> <span class="kt">error</span>
      <span class="p">)</span>

 			<span class="o">...</span><span class="o">...</span>
      <span class="o">...</span><span class="o">...</span>
      <span class="k">if</span> <span class="nx">ln</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
         <span class="nx">ln</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="p">)</span>
         <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Listen: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
         <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="nx">pc</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
         <span class="nx">pc</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">ListenPacket</span><span class="p">(</span><span class="p">)</span>
         <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;ListenPacket: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
         <span class="p">}</span>
      <span class="p">}</span>

      <span class="nx">inst</span><span class="p">.</span><span class="nx">servers</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">inst</span><span class="p">.</span><span class="nx">servers</span><span class="p">,</span> <span class="nx">ServerListener</span><span class="p">{</span><span class="nx">server</span><span class="p">:</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">listener</span><span class="p">:</span> <span class="nx">ln</span><span class="p">,</span> <span class="nx">packet</span><span class="p">:</span> <span class="nx">pc</span><span class="p">}</span><span class="p">)</span>
   <span class="p">}</span>

   <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">s</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">inst</span><span class="p">.</span><span class="nx">servers</span> <span class="p">{</span>
      <span class="nx">inst</span><span class="p">.</span><span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
      <span class="nx">stopWg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
      <span class="kd">func</span><span class="p">(</span><span class="nx">s</span> <span class="nx">Server</span><span class="p">,</span> <span class="nx">ln</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">,</span> <span class="nx">pc</span> <span class="nx">net</span><span class="p">.</span><span class="nx">PacketConn</span><span class="p">,</span> <span class="nx">inst</span> <span class="o">*</span><span class="nx">Instance</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">defer</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">inst</span><span class="p">.</span><span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">(</span><span class="p">)</span>
               <span class="nx">stopWg</span><span class="p">.</span><span class="nf">Done</span><span class="p">(</span><span class="p">)</span>
            <span class="p">}</span><span class="p">(</span><span class="p">)</span>
            <span class="nx">errChan</span> <span class="o">&lt;-</span> <span class="nx">s</span><span class="p">.</span><span class="nf">Serve</span><span class="p">(</span><span class="nx">ln</span><span class="p">)</span>
         <span class="p">}</span><span class="p">(</span><span class="p">)</span>

         <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">defer</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">inst</span><span class="p">.</span><span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">(</span><span class="p">)</span>
               <span class="nx">stopWg</span><span class="p">.</span><span class="nf">Done</span><span class="p">(</span><span class="p">)</span>
            <span class="p">}</span><span class="p">(</span><span class="p">)</span>
            <span class="nx">errChan</span> <span class="o">&lt;-</span> <span class="nx">s</span><span class="p">.</span><span class="nf">ServePacket</span><span class="p">(</span><span class="nx">pc</span><span class="p">)</span>
         <span class="p">}</span><span class="p">(</span><span class="p">)</span>
      <span class="p">}</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">server</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">listener</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">packet</span><span class="p">,</span> <span class="nx">inst</span><span class="p">)</span>
   <span class="p">}</span>

   <span class="c1">// Log errors that may be returned from Serve() calls,
</span><span class="c1"></span>   <span class="c1">// these errors should only be occurring in the server loop.
</span><span class="c1"></span>   <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">{</span>
         <span class="k">select</span> <span class="p">{</span>
         <span class="k">case</span> <span class="nx">err</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">errChan</span><span class="p">:</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">!</span><span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="s">&#34;use of closed network connection&#34;</span><span class="p">)</span> <span class="p">{</span>
                  <span class="c1">// this error is normal when closing the listener; see https://github.com/golang/go/issues/4373
</span><span class="c1"></span>                  <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">stopChan</span><span class="p">:</span>
            <span class="k">return</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span><span class="p">(</span><span class="p">)</span>

   <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">stopWg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">(</span><span class="p">)</span>
      <span class="nx">stopChan</span> <span class="o">&lt;-</span> <span class="kd">struct</span><span class="p">{</span><span class="p">}</span><span class="p">{</span><span class="p">}</span>
   <span class="p">}</span><span class="p">(</span><span class="p">)</span>

   <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>


<span class="c1">// Serve starts the server with an existing listener. It blocks until the server stops.
</span><span class="c1"></span><span class="c1">// This implements caddy.TCPServer interface.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">Serve</span><span class="p">(</span><span class="nx">l</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">Lock</span><span class="p">(</span><span class="p">)</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">server</span><span class="p">[</span><span class="nx">tcp</span><span class="p">]</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">dns</span><span class="p">.</span><span class="nx">Server</span><span class="p">{</span><span class="nx">Listener</span><span class="p">:</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">Net</span><span class="p">:</span> <span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">Handler</span><span class="p">:</span> <span class="nx">dns</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">dns</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">dns</span><span class="p">.</span><span class="nx">Msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithValue</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="nx">Key</span><span class="p">{</span><span class="p">}</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
		<span class="nx">s</span><span class="p">.</span><span class="nf">ServeDNS</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
	<span class="p">}</span><span class="p">)</span><span class="p">}</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">(</span><span class="p">)</span>

	<span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">server</span><span class="p">[</span><span class="nx">tcp</span><span class="p">]</span><span class="p">.</span><span class="nf">ActivateAndServe</span><span class="p">(</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// ServePacket starts the server with an existing packetconn. It blocks until the server stops.
</span><span class="c1"></span><span class="c1">// This implements caddy.UDPServer interface.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">ServePacket</span><span class="p">(</span><span class="nx">p</span> <span class="nx">net</span><span class="p">.</span><span class="nx">PacketConn</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">Lock</span><span class="p">(</span><span class="p">)</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">server</span><span class="p">[</span><span class="nx">udp</span><span class="p">]</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">dns</span><span class="p">.</span><span class="nx">Server</span><span class="p">{</span><span class="nx">PacketConn</span><span class="p">:</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">Net</span><span class="p">:</span> <span class="s">&#34;udp&#34;</span><span class="p">,</span> <span class="nx">Handler</span><span class="p">:</span> <span class="nx">dns</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">dns</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">dns</span><span class="p">.</span><span class="nx">Msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithValue</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="nx">Key</span><span class="p">{</span><span class="p">}</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
		<span class="nx">s</span><span class="p">.</span><span class="nf">ServeDNS</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
	<span class="p">}</span><span class="p">)</span><span class="p">}</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">(</span><span class="p">)</span>

	<span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">server</span><span class="p">[</span><span class="nx">udp</span><span class="p">]</span><span class="p">.</span><span class="nf">ActivateAndServe</span><span class="p">(</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>同样省略部分代码，首先遍历 serverList ，并且生成 <code>inst.servers</code> 列表，然后再遍历 <code>inst.servers</code> 列表，启动协程分别监听 TCP 和 UDP，并且分别调用各自内部的 ServeDNS 来进行服务。</p>
<p>走到这里，启动流程算是彻底走完了。</p>
<h5 id="总结">总结<a href="#总结" class="anchor" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 0 1 5 5 5 5 0 0 1-5 5h-3m-6 0H6a5 5 0 0 1-5-5 5 5 0 0 1 5-5h3"></path><line x1="8" y1="12" x2="16" y2="12"></line></svg></a></h5>
<p>CoreDNS 代码的结构非常清晰，通过初始化时加载自定义的插件顺序，依次注入到 caddy 中去，并在执行的时候，按照定义的插件顺序依次执行，形成一个链式的调用结构。CoreDNS 同样还支持多种协议供使用者选择，这是一个非常好的实现。</p>
<p><strong>参考</strong>：</p>
<ol>
<li><a href="https://xigang.github.io/2019/08/25/coredns/">CoreDNS源码分析</a></li>
<li><a href="https://juejin.im/post/5d11d262e51d4556f76e80ca">CoreDNS源码分析</a></li>
</ol>

			</div>
			<hr class="post-end">
			<footer class="post-info">
				<p>
					<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line></svg><span class="tag"><a href="https://wangzeping722.github.io/tags/coredns">coredns</a></span>
				</p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg></p>
				<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>2019-12-12 11:03 &#43;0800</p>
			</footer>
		</article>
		<div class="post-nav thin">
			<a class="next-post" href="https://wangzeping722.github.io/posts/dns-recording/">
				<span class="post-nav-label"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-left"><line x1="19" y1="12" x2="5" y2="12"></line><polyline points="12 19 5 12 12 5"></polyline></svg>&nbsp;</span><br><span>DNS学习总结</span>
			</a>
			<a class="prev-post" href="https://wangzeping722.github.io/posts/how-to-write-webconsole/">
				<span class="post-nav-label">&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></span><br><span>如何设计与实现WebCosole</span>
			</a>
		</div>
		<div id="comments" class="thin">
</div>
	</main>

	<footer id="site-footer" class="section-inner thin animated fadeIn faster">
		<p>&copy; 2020 <a href="https://wangzeping722.github.io/">Wrong</a> &#183; <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" rel="noopener">CC BY-NC 4.0</a></p>
		<p>
			Made with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> &#183; Theme <a href="https://github.com/Track3/hermit" target="_blank" rel="noopener">Hermit</a> &#183; <a href="https://wangzeping722.github.io/posts/index.xml" target="_blank" title="rss"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a>
		</p>
	</footer>



	<script src="https://wangzeping722.github.io/js/bundle.min.4a9a0ac3d2217822c7865b4161e6c2a71de1d70492264337755427898dd718f6.js" integrity="sha256-SpoKw9IheCLHhltBYebCpx3h1wSSJkM3dVQniY3XGPY=" crossorigin="anonymous"></script>
	

</body>

</html>
