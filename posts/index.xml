<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
	<channel>
		<title>Posts on ç»™æˆ‘ä¸€æ¡é±¼ğŸŸ</title>
		<link>https://wangzeping722.github.io/posts/</link>
		<description>Recent content in Posts on ç»™æˆ‘ä¸€æ¡é±¼ğŸŸ</description>
		<generator>Hugo -- gohugo.io</generator>
		<language>zh</language>
		<copyright>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</copyright>
		<lastBuildDate>Mon, 09 Nov 2020 17:59:31 +0800</lastBuildDate>
		<atom:link href="https://wangzeping722.github.io/posts/index.xml" rel="self" type="application/rss+xml" />
		
		<item>
			<title>gRPC RoundRobin Picker åˆ†æ</title>
			<link>https://wangzeping722.github.io/posts/grpc-picker/</link>
			<pubDate>Mon, 09 Nov 2020 17:59:31 +0800</pubDate>
			
			<guid>https://wangzeping722.github.io/posts/grpc-picker/</guid>
			<description>å‰è¨€ ä¸Šä¸€ç¯‡æ–‡ç« æåˆ°è¿‡ï¼šPicker æ˜¯è´Ÿè½½å‡è¡¡å™¨é‡Œé¢çš„ä¸€ä¸ªç»„ä»¶ï¼Œä¸»è¦ä½œç”¨å°±æ˜¯å®¢æˆ·ç«¯è¦è¿›è¡Œ rpc è°ƒç”¨çš„æ—¶å€™ï¼Œåœ¨å¯ç”¨çš„è¿æ¥ä¸­æ ¹æ®è´Ÿè½½å‡è¡¡ç­–ç•¥æŒ‘é€‰å‡ºæœ€æ—¶</description>
			<content type="html"><![CDATA[<h2 id="å‰è¨€">å‰è¨€</h2>
<p>ä¸Šä¸€ç¯‡æ–‡ç« æåˆ°è¿‡ï¼šPicker æ˜¯è´Ÿè½½å‡è¡¡å™¨é‡Œé¢çš„ä¸€ä¸ªç»„ä»¶ï¼Œä¸»è¦ä½œç”¨å°±æ˜¯å®¢æˆ·ç«¯è¦è¿›è¡Œ rpc è°ƒç”¨çš„æ—¶å€™ï¼Œåœ¨å¯ç”¨çš„è¿æ¥ä¸­æ ¹æ®è´Ÿè½½å‡è¡¡ç­–ç•¥æŒ‘é€‰å‡ºæœ€æ—¶å€™çš„è¿æ¥äº¤ä¸ª gRPC è¿›è¡Œè°ƒç”¨ã€‚æœ¬æ–‡ç®€å•çš„åˆ†æä¸€ä¸‹ Picker çš„åŸç†ï¼Œä»¥åŠå®˜æ–¹å®ç°çš„ RoundRobin Pickerã€‚</p>
<h2 id="1-picker">1. Picker</h2>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Picker is used by gRPC to pick a SubConn to send an RPC.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Picker</span> <span class="kd">interface</span> <span class="p">{</span>
   <span class="nf">Pick</span><span class="p">(</span><span class="nx">info</span> <span class="nx">PickInfo</span><span class="p">)</span> <span class="p">(</span><span class="nx">PickResult</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// PickResult contains information related to a connection chosen for an RPC.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">PickResult</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="c1">// SubConn is the connection to use for this pick, if its state is Ready.
</span><span class="c1"></span>	<span class="c1">// If the state is not Ready, gRPC will block the RPC until a new Picker is
</span><span class="c1"></span>	<span class="c1">// provided by the balancer (using ClientConn.UpdateState).  The SubConn
</span><span class="c1"></span>	<span class="c1">// must be one returned by ClientConn.NewSubConn.
</span><span class="c1"></span>	<span class="nx">SubConn</span> <span class="nx">SubConn</span>

	<span class="c1">// Done is called when the RPC is completed.  If the SubConn is not ready,
</span><span class="c1"></span>	<span class="c1">// this will be called with a nil parameter.  If the SubConn is not a valid
</span><span class="c1"></span>	<span class="c1">// type, Done may not be called.  May be nil if the balancer does not wish
</span><span class="c1"></span>	<span class="c1">// to be notified when the RPC completes.
</span><span class="c1"></span>	<span class="nx">Done</span> <span class="kd">func</span><span class="p">(</span><span class="nx">DoneInfo</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// DoneInfo contains additional information for done.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">DoneInfo</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="c1">// Err is the rpc error the RPC finished with. It could be nil.
</span><span class="c1"></span>	<span class="nx">Err</span> <span class="kt">error</span>
	<span class="c1">// Trailer contains the metadata from the RPC&#39;s trailer, if present.
</span><span class="c1"></span>	<span class="nx">Trailer</span> <span class="nx">metadata</span><span class="p">.</span><span class="nx">MD</span>
	<span class="c1">// BytesSent indicates if any bytes have been sent to the server.
</span><span class="c1"></span>	<span class="nx">BytesSent</span> <span class="kt">bool</span>
	<span class="c1">// BytesReceived indicates if any byte has been received from the server.
</span><span class="c1"></span>	<span class="nx">BytesReceived</span> <span class="kt">bool</span>
	<span class="c1">// ServerLoad is the load received from server. It&#39;s usually sent as part of
</span><span class="c1"></span>	<span class="c1">// trailing metadata.
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// The only supported type now is *orca_v1.LoadReport.
</span><span class="c1"></span>	<span class="nx">ServerLoad</span> <span class="kd">interface</span><span class="p">{</span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Picker æ¥å£åªæœ‰ä¸€ä¸ª Pick æ–¹æ³•ï¼Œç”¨æ¥è¿”å›ä¸€ä¸ªå¯ç”¨çš„ <code>SubConn</code> ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒPick å¹¶ä¸æ˜¯ç›´æ¥è¿”å›ä¸€ä¸ª <code>SubConn</code>ï¼Œè€Œæ˜¯è¿”å›äº†ä¸€ä¸ª <code>PickResult</code> ï¼Œé‡Œé¢åŒ…å«äº†ä¸€ä¸ª <code>SubConn</code> ï¼Œä»¥åŠä¸€ä¸ª <code>Done func(DoneInfo)</code> çš„é—­åŒ…ã€‚ä»æ–‡æ¡£ä¸­å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªé—­åŒ…æ˜¯åœ¨ RPC è°ƒç”¨å®Œæˆä¹‹åæ‰è¢«è°ƒç”¨çš„ã€‚å‚æ•° <code>DoneInfo</code> åŒ…å«äº†è°ƒç”¨ä»¥åŠæœåŠ¡å™¨è¿”å›çš„ä¿¡æ¯ã€‚æœ‰ç»éªŒçš„å°ä¼™ä¼´è‚¯å®šå·²ç»çŒœåˆ°äº†ï¼š<code>DoneInfo</code> ä¸­çš„ Trailer èƒ½å¤Ÿå†™åˆ°æœåŠ¡ç«¯ä¿¡æ¯ï¼ˆåŒ…æ‹¬ CPUï¼Œå†…å­˜ï¼ŒæœåŠ¡å™¨çŠ¶æ€ç­‰ä¿¡æ¯ï¼‰ï¼Œè¿™æ ·å°±å¯ä»¥åˆ©ç”¨ DoneInfo ä½œä¸º Picker ä»¥å Pick æœåŠ¡å™¨çš„ä¾æ®ã€‚</p>
<h2 id="2-rrpicker-å®ç°">2. rrPicker å®ç°</h2>
<p>å®˜æ–¹çš„å®ç°å¾ˆç®€å•ï¼Œè¿™é‡Œå°±ç›´æ¥è´´å‡ºä»£ç ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">rrPickerBuilder</span> <span class="kd">struct</span><span class="p">{</span><span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="o">*</span><span class="nx">rrPickerBuilder</span><span class="p">)</span> <span class="nf">Build</span><span class="p">(</span><span class="nx">info</span> <span class="nx">base</span><span class="p">.</span><span class="nx">PickerBuildInfo</span><span class="p">)</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">Picker</span> <span class="p">{</span>
	<span class="nx">logger</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;roundrobinPicker: newPicker called with info: %v&#34;</span><span class="p">,</span> <span class="nx">info</span><span class="p">)</span>
  <span class="c1">// æ²¡æœ‰å¯ç”¨çš„è¿æ¥ï¼Œè¿”å› errPicker
</span><span class="c1"></span>	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nx">ReadySCs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">base</span><span class="p">.</span><span class="nf">NewErrPicker</span><span class="p">(</span><span class="nx">balancer</span><span class="p">.</span><span class="nx">ErrNoSubConnAvailable</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="kd">var</span> <span class="nx">scs</span> <span class="p">[</span><span class="p">]</span><span class="nx">balancer</span><span class="p">.</span><span class="nx">SubConn</span>
	<span class="k">for</span> <span class="nx">sc</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">info</span><span class="p">.</span><span class="nx">ReadySCs</span> <span class="p">{</span>
		<span class="nx">scs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">scs</span><span class="p">,</span> <span class="nx">sc</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">rrPicker</span><span class="p">{</span>
		<span class="nx">subConns</span><span class="p">:</span> <span class="nx">scs</span><span class="p">,</span>
		<span class="c1">// Start at a random index, as the same RR balancer rebuilds a new
</span><span class="c1"></span>		<span class="c1">// picker when SubConn states change, and we don&#39;t want to apply excess
</span><span class="c1"></span>		<span class="c1">// load to the first server in the list.
</span><span class="c1"></span>		<span class="nx">next</span><span class="p">:</span> <span class="nx">grpcrand</span><span class="p">.</span><span class="nf">Intn</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nx">scs</span><span class="p">)</span><span class="p">)</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">rrPicker</span> <span class="kd">struct</span> <span class="p">{</span>
   <span class="c1">// subConns is the snapshot of the roundrobin balancer when this picker was
</span><span class="c1"></span>   <span class="c1">// created. The slice is immutable. Each Get() will do a round robin
</span><span class="c1"></span>   <span class="c1">// selection from it and return the selected SubConn.
</span><span class="c1"></span>   <span class="nx">subConns</span> <span class="p">[</span><span class="p">]</span><span class="nx">balancer</span><span class="p">.</span><span class="nx">SubConn</span>

   <span class="nx">mu</span>   <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
   <span class="nx">next</span> <span class="kt">int</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">rrPicker</span><span class="p">)</span> <span class="nf">Pick</span><span class="p">(</span><span class="nx">balancer</span><span class="p">.</span><span class="nx">PickInfo</span><span class="p">)</span> <span class="p">(</span><span class="nx">balancer</span><span class="p">.</span><span class="nx">PickResult</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
   <span class="nx">p</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">(</span><span class="p">)</span>
   <span class="nx">sc</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">subConns</span><span class="p">[</span><span class="nx">p</span><span class="p">.</span><span class="nx">next</span><span class="p">]</span>
   <span class="c1">// æ¯æ¬¡é€‰æ‹©è¿æ¥ä¹‹åéƒ½ä¼šæŠŠ next åŠ  1ï¼Œç„¶åå¯¹é•¿åº¦å–ä½™ï¼Œå®ç°è½®è¯¢æ‰€æœ‰è¿æ¥
</span><span class="c1"></span>   <span class="nx">p</span><span class="p">.</span><span class="nx">next</span> <span class="p">=</span> <span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">next</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="nx">p</span><span class="p">.</span><span class="nx">subConns</span><span class="p">)</span>
   <span class="nx">p</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">(</span><span class="p">)</span>
   <span class="k">return</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">PickResult</span><span class="p">{</span><span class="nx">SubConn</span><span class="p">:</span> <span class="nx">sc</span><span class="p">}</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>é¦–å…ˆï¼Œè´Ÿè½½å‡è¡¡å™¨ä¼šé€šè¿‡ <code>rrPickerBuilder.Build</code> æ–¹æ³•ä½¿ç”¨ä¼ å…¥çš„ <code>SubConn</code> æ¥åˆå§‹åŒ– <code>rrPicker</code> å®ä¾‹ã€‚å½“éœ€è¦è¿›è¡Œ RPC è°ƒç”¨æ—¶ï¼ŒgRPC ä¼šè°ƒç”¨ <code>Pick</code> æ–¹æ³•æ¥è·å–ä¸€æ¡å¯ç”¨è¿æ¥ã€‚åœ¨ <code>rrPicker</code> ä¸­ï¼Œæ¯æ¬¡è°ƒç”¨ Pick éƒ½ä¼šæŠŠ <code>rrPicker.next</code> å€¼åŠ 1ï¼Œç„¶åå¯¹é•¿åº¦å–ä½™ï¼Œå®ç°è½®è¯¢æ‰€æœ‰è¿æ¥ã€‚</p>
<h2 id="3-æ€»ç»“">3. æ€»ç»“</h2>
<p>gRPC å®ç°çš„ RoundRobin éå¸¸ç®€æ´æ˜“æ‡‚ï¼Œå¦‚æœæˆ‘ä»¬æœ‰è‡ªå·±å®ç°è´Ÿè½½å‡è¡¡ç­–ç•¥çš„éœ€æ±‚ï¼Œä¹Ÿå¯ä»¥å‚è€ƒ RoundRobin çš„å†™æ³•æ¥æ„å»ºè‡ªå·±çš„è´Ÿè½½å‡è¡¡é€‰æ‹©å™¨ã€‚æ¯”å¦‚ go-zero çš„ <a href="https://github.com/tal-tech/go-zero/blob/master/zrpc/internal/balancer/p2c/p2c.go">p2c</a> é€‰æ‹©å™¨ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>gRPC Balancer åˆ†æ</title>
			<link>https://wangzeping722.github.io/posts/grpc-balancer/</link>
			<pubDate>Fri, 06 Nov 2020 18:07:55 +0800</pubDate>
			
			<guid>https://wangzeping722.github.io/posts/grpc-balancer/</guid>
			<description>1. è´Ÿè½½å‡è¡¡ gRPC å®ç°è´Ÿè½½å‡è¡¡çš„æ–¹æ³•ä¸»è¦æœ‰ä¸‰ç§ï¼Œåˆ†åˆ«æ˜¯ é›†ä¸­å¼ LBï¼ˆProxy Modelï¼‰ è¿›ç¨‹å†… LBï¼ˆBalancing-aware Clientï¼‰ ç‹¬</description>
			<content type="html"><![CDATA[<h2 id="1-è´Ÿè½½å‡è¡¡">1. è´Ÿè½½å‡è¡¡</h2>
<p>gRPC å®ç°è´Ÿè½½å‡è¡¡çš„æ–¹æ³•ä¸»è¦æœ‰ä¸‰ç§ï¼Œåˆ†åˆ«æ˜¯</p>
<ul>
<li>é›†ä¸­å¼ LBï¼ˆProxy Modelï¼‰</li>
<li>è¿›ç¨‹å†… LBï¼ˆBalancing-aware Clientï¼‰</li>
<li>ç‹¬ç«‹ LB è¿›ç¨‹ï¼ˆExternal Load Balancing Serviceï¼‰</li>
</ul>
<p>å…·ä½“çš„å®ç°æ–¹å¼è¯·å‚è€ƒè¿™ç¯‡æ–‡ç« <a href="https://segmentfault.com/a/1190000008672912">gRPC æœåŠ¡å‘ç°&amp;è´Ÿè½½å‡è¡¡</a>ã€‚</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒgRPC ä½¿ç”¨ <strong>è¿›ç¨‹å†… LB</strong> çš„æ–¹æ¡ˆï¼Œå¹¶ä¸”æ˜¯åŸºäºæ¯æ¬¡è°ƒç”¨ RPC æ¥å£å®ç°çš„è´Ÿè½½å‡è¡¡ï¼Œ å¦‚ä¸‹å›¾ï¼š</p>
<p><!-- raw HTML omitted --></p>
<ol>
<li>æœåŠ¡å¯åŠ¨å gRPC å®¢æˆ·ç«¯å‘æ³¨å†Œä¸­å¿ƒè·å–åç«¯æœåŠ¡åˆ—è¡¨</li>
<li>å®¢æˆ·ç«¯å®ä¾‹åŒ–è´Ÿè½½å‡è¡¡ç­–ç•¥</li>
<li>è´Ÿè½½å‡è¡¡å™¨ï¼ˆBalancerï¼‰ä¸ºæ¯ä¸€ä¸ªåç«¯åœ°å€åˆ›å»ºä¸€ä¸ªå­è¿æ¥ï¼ˆSubConnï¼‰</li>
<li>å½“è¦å‘èµ· RPC è¯·æ±‚çš„æ—¶å€™ï¼Œè´Ÿè½½å‡è¡¡å™¨å°±ä¼šé€‰æ‹©å½“å‰æœ€åŒ¹é…çš„å­è¿æ¥æ¥è¿›è¡Œ RCP è°ƒç”¨</li>
</ol>
<h2 id="2-é—®é¢˜">2. é—®é¢˜</h2>
<p>å¸¦ç€é—®é¢˜æ¥çœ‹æºç ï¼Œæ”¶è·ä¼šæ›´å¤šï¼š</p>
<ul>
<li>Balancer å¦‚ä½•æ¥æ”¶æ¥è‡ª Resolver è§£æå‡ºæ¥çš„åœ°å€ï¼Ÿ</li>
<li>ä¸è¿™äº›åœ°å€çš„è¿æ¥æ˜¯åœ¨å“ªå»ºç«‹çš„ï¼Ÿ</li>
<li>å¦‚ä½•é€‰æ‹©æ¯æ¬¡è°ƒç”¨é€‚åˆçš„è¿æ¥ï¼Ÿ</li>
</ul>
<p><a href="https://github.com/grpc/proposal/blob/master/L9-go-resolver-balancer-API.md">L9-go-resolver-balancer-API</a>è¿™ç¯‡æ–‡ç« ä¸­ç»™å‡ºäº† resolver-balancer çš„è®¾è®¡ç†å¿µï¼Œå¹¶ä¸”ç»™å‡ºäº†å®˜æ–¹æ¶æ„å›¾ï¼š</p>
<p><img src="https://blog-wero.oss-cn-shanghai.aliyuncs.com/img/resolver-balancer-arch.png" alt="resolver-balancer"></p>
<p>å›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹è§ Balancer ä½äº gRPC çš„å³æ–¹ï¼Œå¹¶ä¸” Resolver ä¸ Balancer æ²¡æœ‰è€¦åˆåœ¨ä¸€èµ·ï¼Œè€Œæ˜¯é‡‡ç”¨æ¥å£éš”ç¦»åŠ  Builder å’ŒWrapper è®¾è®¡æ¨¡å¼ã€‚å…¶ä¸­ï¼ŒBalancer è´Ÿè´£ä¸åç«¯æœåŠ¡å™¨å»ºç«‹è¿æ¥ï¼Œå¹¶ä¸”åˆ›å»º Picker æ¥æ‰§è¡Œè´Ÿè½½å‡è¡¡çš„é€»è¾‘ã€‚</p>
<h2 id="3-ä¸€åˆ‡éƒ½è¦ä»-resolver-è¯´èµ·">3. ä¸€åˆ‡éƒ½è¦ä» Resolver è¯´èµ·</h2>
<p>ä¸Šæ–‡ï¼Œæˆ‘ä»¬æåˆ° Resolver åœ¨è§£æåˆ°åç«¯æœåŠ¡å™¨åˆ—è¡¨ä¹‹åä¼šé€šè¿‡ <code>resolver.ClientConn.UpdateState(state)</code>æ¥é€šçŸ¥ gRPC åç«¯åœ°å€æœ‰æ›´æ–°ï¼Œå¯¹åº”ä¸Šå›¾çš„å·¦è¾¹ <code>Addr Updates</code>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// ccResolverWrapper å¯ä»¥çœ‹åšæ˜¯ Resolver çš„ä»£ç†ï¼Œå¹¶ä¸”å®ç°äº†resolver.ClientConnæ¥å£
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ccResolverWrapper</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">cc</span>         <span class="o">*</span><span class="nx">ClientConn</span>
	<span class="nx">resolverMu</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
	<span class="nx">resolver</span>   <span class="nx">resolver</span><span class="p">.</span><span class="nx">Resolver</span>
	<span class="nx">done</span>       <span class="o">*</span><span class="nx">grpcsync</span><span class="p">.</span><span class="nx">Event</span>
	<span class="nx">curState</span>   <span class="nx">resolver</span><span class="p">.</span><span class="nx">State</span>

	<span class="nx">pollingMu</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
	<span class="nx">polling</span>   <span class="kd">chan</span> <span class="kd">struct</span><span class="p">{</span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">ccr</span> <span class="o">*</span><span class="nx">ccResolverWrapper</span><span class="p">)</span> <span class="nf">UpdateState</span><span class="p">(</span><span class="nx">s</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">ccr</span><span class="p">.</span><span class="nx">done</span><span class="p">.</span><span class="nf">HasFired</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="o">...</span>
	<span class="c1">// æ›´æ–°åœ°å€æ± 
</span><span class="c1"></span>	<span class="nx">ccr</span><span class="p">.</span><span class="nx">curState</span> <span class="p">=</span> <span class="nx">s</span>
	<span class="nx">ccr</span><span class="p">.</span><span class="nf">poll</span><span class="p">(</span><span class="nx">ccr</span><span class="p">.</span><span class="nx">cc</span><span class="p">.</span><span class="nf">updateResolverState</span><span class="p">(</span><span class="nx">ccr</span><span class="p">.</span><span class="nx">curState</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>å¯è§æœ€ç»ˆä¼šè°ƒç”¨ <code>ClientConn.updateResolverState(ccr.curState, nil)</code> æ–¹æ³•ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢ï¼ŒgRPC ä¼šå¤„ç† Balancer çš„é€»è¾‘ã€‚</p>
<p>è¿™é‡Œéœ€è¦æ¢³ç†ä¸€ä¸‹ï¼š</p>
<ul>
<li>ccResolverWrapper å®ç°äº† <code>resolver.ClientConn</code> æ¥å£</li>
<li>ccResolverWrapper ä¸­çš„ cc æ˜¯ <code>grpc.ClientConn</code> ç»“æ„ä½“</li>
<li>å½“åœ¨ Resolver ä¸­è°ƒç”¨  <code>resolver.ClientConn.UpdateState(state)</code> çš„æ—¶å€™ï¼Œä¾¿æœ€ç»ˆä¼šè°ƒç”¨ <code>ClientConn.updateResolverState(ccr.curState, nil)</code></li>
</ul>
<p>ä»¥ dnsResolver ä¸ºä¾‹ï¼Œè°ƒç”¨é“¾å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">dnsResovler.watcher --&gt; ccResolverWrapper.UpdateState --&gt; ClientConn.updateResolverState
--&gt;  cc.balancerWrapper.updateClientConnState
</code></pre></div><h3 id="clientconnupdateresolverstate">ClientConn.updateResolverState</h3>
<p>updateResolverState ä¼šä¸ Balancer æ¨¡å—è¿›è¡Œäº¤äº’ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">cc</span> <span class="o">*</span><span class="nx">ClientConn</span><span class="p">)</span> <span class="nf">updateResolverState</span><span class="p">(</span><span class="nx">s</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">State</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">defer</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">firstResolveEvent</span><span class="p">.</span><span class="nf">Fire</span><span class="p">(</span><span class="p">)</span>
	<span class="nx">cc</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">(</span><span class="p">)</span>
	<span class="c1">// Check if the ClientConn is already closed. Some fields (e.g.
</span><span class="c1"></span>	<span class="c1">// balancerWrapper) are set to nil when closing the ClientConn, and could
</span><span class="c1"></span>	<span class="c1">// cause nil pointer panic if we don&#39;t have this check.
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">conns</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">cc</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">(</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">nil</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="c1">// May need to apply the initial service config in case the resolver
</span><span class="c1"></span>		<span class="c1">// doesn&#39;t support service configs, or doesn&#39;t provide a service config
</span><span class="c1"></span>		<span class="c1">// with the new addresses.
</span><span class="c1"></span>		<span class="nx">cc</span><span class="p">.</span><span class="nf">maybeApplyDefaultServiceConfig</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span>

		<span class="k">if</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">balancerWrapper</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">cc</span><span class="p">.</span><span class="nx">balancerWrapper</span><span class="p">.</span><span class="nf">resolverError</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>

		<span class="c1">// No addresses are valid with err set; return early.
</span><span class="c1"></span>		<span class="nx">cc</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">(</span><span class="p">)</span>
		<span class="k">return</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">ErrBadResolverState</span>
	<span class="p">}</span>

	<span class="kd">var</span> <span class="nx">ret</span> <span class="kt">error</span>
	<span class="c1">// å¦‚æœç¦ç”¨æœåŠ¡é…ç½®æˆ–è€…æœåŠ¡é…ç½®ä¸ºç©º, åˆ™å¯èƒ½ä½¿ç”¨é»˜è®¤é…ç½®
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">disableServiceConfig</span> <span class="o">||</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ServiceConfig</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="c1">// A
</span><span class="c1"></span>		<span class="nx">cc</span><span class="p">.</span><span class="nf">maybeApplyDefaultServiceConfig</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Addresses</span><span class="p">)</span>
		<span class="c1">// TODO: do we need to apply a failing LB policy if there is no
</span><span class="c1"></span>		<span class="c1">// default, per the error handling design?
</span><span class="c1"></span>	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// B
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">sc</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ServiceConfig</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="p">(</span><span class="o">*</span><span class="nx">ServiceConfig</span><span class="p">)</span><span class="p">;</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ServiceConfig</span><span class="p">.</span><span class="nx">Err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">ok</span> <span class="p">{</span>
			<span class="nx">cc</span><span class="p">.</span><span class="nf">applyServiceConfigAndBalancer</span><span class="p">(</span><span class="nx">sc</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Addresses</span><span class="p">)</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="c1">// é…ç½®ä¸æ­£ç¡®
</span><span class="c1"></span>			<span class="nx">ret</span> <span class="p">=</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">ErrBadResolverState</span>
			<span class="k">if</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">balancerWrapper</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
				<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ServiceConfig</span><span class="p">.</span><span class="nx">Err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
					<span class="nx">err</span> <span class="p">=</span> <span class="nx">status</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="nx">codes</span><span class="p">.</span><span class="nx">Unavailable</span><span class="p">,</span> <span class="s">&#34;error parsing service config: %v&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ServiceConfig</span><span class="p">.</span><span class="nx">Err</span><span class="p">)</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="nx">err</span> <span class="p">=</span> <span class="nx">status</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="nx">codes</span><span class="p">.</span><span class="nx">Unavailable</span><span class="p">,</span> <span class="s">&#34;illegal service config type: %T&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">ServiceConfig</span><span class="p">.</span><span class="nx">Config</span><span class="p">)</span>
				<span class="p">}</span>
				<span class="nx">cc</span><span class="p">.</span><span class="nx">blockingpicker</span><span class="p">.</span><span class="nf">updatePicker</span><span class="p">(</span><span class="nx">base</span><span class="p">.</span><span class="nf">NewErrPicker</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span><span class="p">)</span>
				<span class="nx">cc</span><span class="p">.</span><span class="nx">csMgr</span><span class="p">.</span><span class="nf">updateState</span><span class="p">(</span><span class="nx">connectivity</span><span class="p">.</span><span class="nx">TransientFailure</span><span class="p">)</span>
				<span class="nx">cc</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">(</span><span class="p">)</span>
				<span class="k">return</span> <span class="nx">ret</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="kd">var</span> <span class="nx">balCfg</span> <span class="nx">serviceconfig</span><span class="p">.</span><span class="nx">LoadBalancingConfig</span>
	<span class="c1">// ä¼˜å…ˆä½¿ç”¨å®¢æˆ·ç«¯é…ç½®çš„è´Ÿè½½å‡è¡¡ç­–ç•¥
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">balancerBuilder</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">sc</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">sc</span><span class="p">.</span><span class="nx">lbConfig</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">balCfg</span> <span class="p">=</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">sc</span><span class="p">.</span><span class="nx">lbConfig</span><span class="p">.</span><span class="nx">cfg</span>
	<span class="p">}</span>

	<span class="nx">cbn</span> <span class="o">:=</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">curBalancerName</span>
	<span class="nx">bw</span> <span class="o">:=</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">balancerWrapper</span>
	<span class="nx">cc</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">(</span><span class="p">)</span>
	<span class="c1">// å¦‚æœè´Ÿè½½çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ä¸æ˜¯ grpclb, å°±å‰”é™¤æ‰€æœ‰ç±»å‹æ˜¯ grpclb çš„åœ°å€
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">cbn</span> <span class="o">!=</span> <span class="nx">grpclbName</span> <span class="p">{</span>
		<span class="c1">// Filter any grpclb addresses since we don&#39;t have the grpclb balancer.
</span><span class="c1"></span>		<span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="p">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Addresses</span><span class="p">)</span><span class="p">;</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Addresses</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="p">.</span><span class="nx">Type</span> <span class="o">==</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">GRPCLB</span> <span class="p">{</span>
				<span class="nb">copy</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Addresses</span><span class="p">[</span><span class="nx">i</span><span class="p">:</span><span class="p">]</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Addresses</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="p">]</span><span class="p">)</span>
				<span class="nx">s</span><span class="p">.</span><span class="nx">Addresses</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">Addresses</span><span class="p">[</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">Addresses</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
				<span class="k">continue</span>
			<span class="p">}</span>
			<span class="nx">i</span><span class="o">++</span>
		<span class="p">}</span>
	<span class="p">}</span>
 	<span class="c1">// è°ƒç”¨è´Ÿè½½å‡è¡¡ç­–ç•¥æ›´æ–°è¿æ¥çŠ¶æ€
</span><span class="c1"></span>	<span class="nx">uccsErr</span> <span class="o">:=</span> <span class="nx">bw</span><span class="p">.</span><span class="nf">updateClientConnState</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">balancer</span><span class="p">.</span><span class="nx">ClientConnState</span><span class="p">{</span><span class="nx">ResolverState</span><span class="p">:</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">BalancerConfig</span><span class="p">:</span> <span class="nx">balCfg</span><span class="p">}</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">ret</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">ret</span> <span class="p">=</span> <span class="nx">uccsErr</span> <span class="c1">// prefer ErrBadResolver state since any other error is
</span><span class="c1"></span>		<span class="c1">// currently meaningless to the caller.
</span><span class="c1"></span>	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">ret</span>
<span class="p">}</span>
</code></pre></div><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½ä¼šè¿›å…¥ A ä»£ç å—ï¼ˆä½¿ç”¨é»˜è®¤é…ç½®ï¼‰ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">cc</span> <span class="o">*</span><span class="nx">ClientConn</span><span class="p">)</span> <span class="nf">maybeApplyDefaultServiceConfig</span><span class="p">(</span><span class="nx">addrs</span> <span class="p">[</span><span class="p">]</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">Address</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">sc</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">cc</span><span class="p">.</span><span class="nf">applyServiceConfigAndBalancer</span><span class="p">(</span><span class="nx">cc</span><span class="p">.</span><span class="nx">sc</span><span class="p">,</span> <span class="nx">addrs</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">defaultServiceConfig</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">cc</span><span class="p">.</span><span class="nf">applyServiceConfigAndBalancer</span><span class="p">(</span><span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">defaultServiceConfig</span><span class="p">,</span> <span class="nx">addrs</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// 
</span><span class="c1"></span>		<span class="nx">cc</span><span class="p">.</span><span class="nf">applyServiceConfigAndBalancer</span><span class="p">(</span><span class="nx">emptyServiceConfig</span><span class="p">,</span> <span class="nx">addrs</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>å½“æˆ‘ä»¬æœªæŒ‡å®šé…ç½®çš„æ—¶å€™ï¼Œä¼šä¼ å…¥ <code>emptyServiceConfig</code> ç©ºçš„é…ç½®,  ç„¶åè°ƒç”¨ <code>ClientConn.applyServiceConfigAndBalancer</code>ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">cc</span> <span class="o">*</span><span class="nx">ClientConn</span><span class="p">)</span> <span class="nf">applyServiceConfigAndBalancer</span><span class="p">(</span><span class="nx">sc</span> <span class="o">*</span><span class="nx">ServiceConfig</span><span class="p">,</span> <span class="nx">addrs</span> <span class="p">[</span><span class="p">]</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">Address</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">sc</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="c1">// should never reach here.
</span><span class="c1"></span>		<span class="k">return</span>
	<span class="p">}</span>
	<span class="c1">// å¯èƒ½æ˜¯ emptyServiceConfig
</span><span class="c1"></span>	<span class="nx">cc</span><span class="p">.</span><span class="nx">sc</span> <span class="p">=</span> <span class="nx">sc</span>

	<span class="k">if</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">sc</span><span class="p">.</span><span class="nx">retryThrottling</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">newThrottler</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">retryThrottler</span><span class="p">{</span>
			<span class="nx">tokens</span><span class="p">:</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">sc</span><span class="p">.</span><span class="nx">retryThrottling</span><span class="p">.</span><span class="nx">MaxTokens</span><span class="p">,</span>
			<span class="nx">max</span><span class="p">:</span>    <span class="nx">cc</span><span class="p">.</span><span class="nx">sc</span><span class="p">.</span><span class="nx">retryThrottling</span><span class="p">.</span><span class="nx">MaxTokens</span><span class="p">,</span>
			<span class="nx">thresh</span><span class="p">:</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">sc</span><span class="p">.</span><span class="nx">retryThrottling</span><span class="p">.</span><span class="nx">MaxTokens</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span>
			<span class="nx">ratio</span><span class="p">:</span>  <span class="nx">cc</span><span class="p">.</span><span class="nx">sc</span><span class="p">.</span><span class="nx">retryThrottling</span><span class="p">.</span><span class="nx">TokenRatio</span><span class="p">,</span>
		<span class="p">}</span>
		<span class="nx">cc</span><span class="p">.</span><span class="nx">retryThrottler</span><span class="p">.</span><span class="nf">Store</span><span class="p">(</span><span class="nx">newThrottler</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="nx">cc</span><span class="p">.</span><span class="nx">retryThrottler</span><span class="p">.</span><span class="nf">Store</span><span class="p">(</span><span class="p">(</span><span class="o">*</span><span class="nx">retryThrottler</span><span class="p">)</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span><span class="p">)</span>
	<span class="p">}</span>

  <span class="c1">// å¦‚æœæ²¡æœ‰æŒ‡å®š balancerBuilder, å°±éœ€è¦å…ˆè·å–ä¸€ä¸ª builder, ä¸€èˆ¬æƒ…å†µä¸‹éƒ½ä¼šæŒ‡å®š
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">balancerBuilder</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="c1">// Only look at balancer types and switch balancer if balancer dial
</span><span class="c1"></span>		<span class="c1">// option is not set.
</span><span class="c1"></span>		<span class="kd">var</span> <span class="nx">newBalancerName</span> <span class="kt">string</span>
		<span class="k">if</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">sc</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">sc</span><span class="p">.</span><span class="nx">lbConfig</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="c1">// 1. ä½¿ç”¨ ServiceConfig æŒ‡å®šçš„ Builder
</span><span class="c1"></span>			<span class="nx">newBalancerName</span> <span class="p">=</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">sc</span><span class="p">.</span><span class="nx">lbConfig</span><span class="p">.</span><span class="nx">name</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">isGRPCLB</span> <span class="kt">bool</span>
			<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">a</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">addrs</span> <span class="p">{</span>
				<span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">Type</span> <span class="o">==</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">GRPCLB</span> <span class="p">{</span>
					<span class="nx">isGRPCLB</span> <span class="p">=</span> <span class="kc">true</span>
					<span class="k">break</span>
				<span class="p">}</span>
			<span class="p">}</span>
      <span class="c1">// 2. å¦‚æœè‡³å°‘æœ‰ä¸€ä¸ªåœ°å€çš„ç±»å‹æ˜¯ GRPCLB, é‚£ä¹ˆä½¿ç”¨ GRPCLB
</span><span class="c1"></span>			<span class="k">if</span> <span class="nx">isGRPCLB</span> <span class="p">{</span>
				<span class="nx">newBalancerName</span> <span class="p">=</span> <span class="nx">grpclbName</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">sc</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">sc</span><span class="p">.</span><span class="nx">LB</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="c1">// 3. ä½¿ç”¨ WithBalancer æä¾›çš„ builder
</span><span class="c1"></span>				<span class="nx">newBalancerName</span> <span class="p">=</span> <span class="o">*</span><span class="nx">cc</span><span class="p">.</span><span class="nx">sc</span><span class="p">.</span><span class="nx">LB</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// 4. ä½¿ç”¨ pick_first
</span><span class="c1"></span>				<span class="nx">newBalancerName</span> <span class="p">=</span> <span class="nx">PickFirstBalancerName</span>
			<span class="p">}</span>
		<span class="p">}</span>
    <span class="c1">// åˆ‡æ¢è´Ÿè½½å‡è¡¡ç­–ç•¥
</span><span class="c1"></span>		<span class="nx">cc</span><span class="p">.</span><span class="nf">switchBalancer</span><span class="p">(</span><span class="nx">newBalancerName</span><span class="p">)</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">balancerWrapper</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="c1">// Balancer dial option was set, and this is the first time handling
</span><span class="c1"></span>		<span class="c1">// resolved addresses. Build a balancer with dopts.balancerBuilder.
</span><span class="c1"></span>		<span class="nx">cc</span><span class="p">.</span><span class="nx">curBalancerName</span> <span class="p">=</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">balancerBuilder</span><span class="p">.</span><span class="nf">Name</span><span class="p">(</span><span class="p">)</span>
		<span class="nx">cc</span><span class="p">.</span><span class="nx">balancerWrapper</span> <span class="p">=</span> <span class="nf">newCCBalancerWrapper</span><span class="p">(</span><span class="nx">cc</span><span class="p">,</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">balancerBuilder</span><span class="p">,</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">balancerBuildOpts</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>ä»ä¸Šé¢ä»£ç å¯ä»¥çœ‹å‡º ClientConn ä¼šé€šè¿‡æœåŠ¡é…ç½®é€‰æ‹©å¯¹åº”çš„ Balancerï¼š</p>
<ol>
<li>
<p>ä¼˜å…ˆä½¿ç”¨å®¢æˆ·ç«¯é…ç½®çš„è´Ÿè½½å‡è¡¡ç­–ç•¥</p>
</li>
<li>
<p>å¦‚æœå®¢æˆ·ç«¯æ²¡æœ‰æŒ‡å®šè´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œé‚£ä¹ˆä¼šé€šè¿‡æœåŠ¡é…ç½®æ¥å†³å®šä½¿ç”¨ä»€ä¹ˆè´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œé€‰æ‹©è§„åˆ™å¦‚ä¸‹ï¼š</p>
<ol>
<li>
<p>ä½¿ç”¨ ServiceConfig æŒ‡å®šçš„è´Ÿè½½å‡è¡¡ç­–ç•¥</p>
</li>
<li>
<p>å¦‚æœè‡³å°‘æœ‰ä¸€ä¸ªåœ°å€çš„ç±»å‹æ˜¯ GRPCLB, é‚£ä¹ˆä½¿ç”¨ GRPCLB</p>
</li>
<li>
<p>ä½¿ç”¨ WithBalancer æä¾›çš„è´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œ ä¸è¿‡è¿™ä¸ªé€‰æ‹©å·²ç»è¢«ä¼˜åŒ–æ‰äº†ï¼Œå¯ä»¥æŸ¥çœ‹å­—æ®µ LB ä¸Šé¢çš„æ³¨é‡Šï¼š</p>
<blockquote>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// LB is the load balancer the service providers recommends. The balancer
</span><span class="c1"></span><span class="c1">// specified via grpc.WithBalancerName will override this.  This is deprecated;
</span><span class="c1"></span><span class="c1">// lbConfigs is preferred.  If lbConfig and LB are both present, lbConfig
</span><span class="c1"></span><span class="c1">// will be used.
</span><span class="c1"></span><span class="nx">LB</span> <span class="o">*</span><span class="kt">string</span>
</code></pre></div></blockquote>
<p>è¯´æ˜ï¼Œå¦‚æœä½¿ç”¨äº† WithBalancerName æ¥æŒ‡å®šè´Ÿè½½å‡è¡¡ç­–ç•¥ï¼Œé‚£ä¹ˆä¼šè¦†ç›–æ‰è¿™ä¸ªé€‰é¡¹ï¼Œå³ä¼š<strong>ä¼˜å…ˆä½¿ç”¨å®¢æˆ·ç«¯é…ç½®çš„è´Ÿè½½å‡è¡¡ç­–ç•¥</strong></p>
</li>
<li>
<p>ä½¿ç”¨ pick_first è´Ÿè½½å‡è¡¡ç­–ç•¥</p>
</li>
</ol>
</li>
</ol>
<p>åœ¨å®Œæˆè´Ÿè½½å‡è¡¡ç­–ç•¥çš„åˆå§‹åŒ–æˆ–åˆ‡æ¢ä¹‹åï¼Œä¼šè°ƒç”¨<code>bw.updateClientConnState(&amp;balancer.ClientConnState{ResolverState: s, BalancerConfig: balCfg})</code> æ¥æ›´æ–°è¿æ¥çš„çŠ¶æ€ï¼ˆbw å°±æ˜¯ balancerWrapperï¼‰ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨åé¢ä¼šè§£æã€‚</p>
<h2 id="4-balancer-åˆ†æ">4. Balancer åˆ†æ</h2>
<p>Balancer åŒ…çš„ç»“æ„è·Ÿ Resolver çš„åŒ…ç»“æ„ç±»ä¼¼ï¼Œéƒ½æ˜¯é‡‡ç”¨ Builder + Wrapper è®¾è®¡æ¨¡å¼ç›¸ç»“åˆï¼Œä½¿ç”¨è€…åªéœ€è¦å®ç°è‡ªå·±çš„ Balancerï¼Œç„¶åå†ä»¥æ’ä»¶çš„å½¢å¼æ³¨å†Œåˆ° gRPC ä¸­å°±å¯ä»¥ä¸å…¶ä»–æ¨¡å—é…åˆä½¿ç”¨ã€‚</p>
<h3 id="newccbalancerwrapper">newCCBalancerWrapper</h3>
<p>æ–°å»ºä¸€ä¸ª ccBalancerWrapperï¼Œå¹¶ä¸”å’Œ ccResolverWrapper ä¸€æ ·ï¼Œå­˜å‚¨åˆ° <code>ClientConn</code> çš„ <code>balancerWrapper</code> ä¸­ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">newCCBalancerWrapper</span><span class="p">(</span><span class="nx">cc</span> <span class="o">*</span><span class="nx">ClientConn</span><span class="p">,</span> <span class="nx">b</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">Builder</span><span class="p">,</span> <span class="nx">bopts</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">BuildOptions</span><span class="p">)</span> <span class="o">*</span><span class="nx">ccBalancerWrapper</span> <span class="p">{</span>
	<span class="c1">// åˆå§‹åŒ–å®ä¾‹
</span><span class="c1"></span>  <span class="nx">ccb</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">ccBalancerWrapper</span><span class="p">{</span>
		<span class="nx">cc</span><span class="p">:</span>       <span class="nx">cc</span><span class="p">,</span>
		<span class="nx">scBuffer</span><span class="p">:</span> <span class="nx">buffer</span><span class="p">.</span><span class="nf">NewUnbounded</span><span class="p">(</span><span class="p">)</span><span class="p">,</span>
		<span class="nx">done</span><span class="p">:</span>     <span class="nx">grpcsync</span><span class="p">.</span><span class="nf">NewEvent</span><span class="p">(</span><span class="p">)</span><span class="p">,</span>
		<span class="nx">subConns</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="o">*</span><span class="nx">acBalancerWrapper</span><span class="p">]</span><span class="kd">struct</span><span class="p">{</span><span class="p">}</span><span class="p">)</span><span class="p">,</span>
	<span class="p">}</span>
  <span class="c1">// å¯åŠ¨åç¨‹ç›‘å¬
</span><span class="c1"></span>	<span class="k">go</span> <span class="nx">ccb</span><span class="p">.</span><span class="nf">watcher</span><span class="p">(</span><span class="p">)</span>
  <span class="c1">// Build è´Ÿè½½å‡è¡¡å™¨
</span><span class="c1"></span>	<span class="nx">ccb</span><span class="p">.</span><span class="nx">balancer</span> <span class="p">=</span> <span class="nx">b</span><span class="p">.</span><span class="nf">Build</span><span class="p">(</span><span class="nx">ccb</span><span class="p">,</span> <span class="nx">bopts</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">ccb</span>
<span class="p">}</span>
</code></pre></div><h3 id="ccbalancerwrapperwatcher">ccBalancerWrapper.watcher</h3>
<p>åœ¨åˆ›å»º ccBalancerWrapper ä¼šå¯åŠ¨ä¸€ä¸ªgoroutine æ¥æ‰§è¡Œ watcher æ–¹æ³•ï¼Œé‚£ <em>watcher</em> çš„ä½œç”¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// watcher balancer functions sequentially, so the balancer can be implemented
</span><span class="c1"></span><span class="c1">// lock-free.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">ccb</span> <span class="o">*</span><span class="nx">ccBalancerWrapper</span><span class="p">)</span> <span class="nf">watcher</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nx">t</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">ccb</span><span class="p">.</span><span class="nx">scBuffer</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="p">)</span><span class="p">:</span>
			<span class="nx">ccb</span><span class="p">.</span><span class="nx">scBuffer</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="p">)</span>
			<span class="k">if</span> <span class="nx">ccb</span><span class="p">.</span><span class="nx">done</span><span class="p">.</span><span class="nf">HasFired</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">break</span>
			<span class="p">}</span>
			<span class="nx">ccb</span><span class="p">.</span><span class="nx">balancerMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">(</span><span class="p">)</span>
			<span class="nx">su</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="p">(</span><span class="o">*</span><span class="nx">scStateUpdate</span><span class="p">)</span>
			<span class="nx">ccb</span><span class="p">.</span><span class="nx">balancer</span><span class="p">.</span><span class="nf">UpdateSubConnState</span><span class="p">(</span><span class="nx">su</span><span class="p">.</span><span class="nx">sc</span><span class="p">,</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">SubConnState</span><span class="p">{</span><span class="nx">ConnectivityState</span><span class="p">:</span> <span class="nx">su</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">ConnectionError</span><span class="p">:</span> <span class="nx">su</span><span class="p">.</span><span class="nx">err</span><span class="p">}</span><span class="p">)</span>
			<span class="nx">ccb</span><span class="p">.</span><span class="nx">balancerMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">(</span><span class="p">)</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ccb</span><span class="p">.</span><span class="nx">done</span><span class="p">.</span><span class="nf">Done</span><span class="p">(</span><span class="p">)</span><span class="p">:</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="nx">ccb</span><span class="p">.</span><span class="nx">done</span><span class="p">.</span><span class="nf">HasFired</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">ccb</span><span class="p">.</span><span class="nx">balancer</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="p">)</span>
			<span class="nx">ccb</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">(</span><span class="p">)</span>
			<span class="nx">scs</span> <span class="o">:=</span> <span class="nx">ccb</span><span class="p">.</span><span class="nx">subConns</span>
			<span class="nx">ccb</span><span class="p">.</span><span class="nx">subConns</span> <span class="p">=</span> <span class="kc">nil</span>
			<span class="nx">ccb</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">(</span><span class="p">)</span>
			<span class="k">for</span> <span class="nx">acbw</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">scs</span> <span class="p">{</span>
				<span class="nx">ccb</span><span class="p">.</span><span class="nx">cc</span><span class="p">.</span><span class="nf">removeAddrConn</span><span class="p">(</span><span class="nx">acbw</span><span class="p">.</span><span class="nf">getAddrConn</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="nx">errConnDrain</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="nx">ccb</span><span class="p">.</span><span class="nf">UpdateState</span><span class="p">(</span><span class="nx">balancer</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">ConnectivityState</span><span class="p">:</span> <span class="nx">connectivity</span><span class="p">.</span><span class="nx">Connecting</span><span class="p">,</span> <span class="nx">Picker</span><span class="p">:</span> <span class="kc">nil</span><span class="p">}</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>ä»ä»£ç çš„æ³¨é‡Šä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“ä¸ºä»€ä¹ˆè¦ä¸“é—¨å¯åŠ¨ä¸€ä¸ª goroutine æ¥æ‰§è¡Œ watcher æ–¹æ³•ï¼šä¸ºäº†ç›‘å¬æœåŠ¡å™¨åœ°å€çš„æ›´æ–°å’ŒçŠ¶æ€å˜åŒ–ï¼Œå¹¶ä¸”è®© balancer å®ç°æ— é”æ›´æ–°ï¼Œåæ–‡ä¼šè¯¦ç»†è®²è§£ã€‚</p>
<h3 id="balancerbuilder">balancer.Builder</h3>
<p>å’Œ Resolver ä¸€æ ·ï¼Œåœ¨å®ç° Balancer çš„ç»„ä»¶çš„åŒæ—¶ä¹Ÿè¦å®ç°ä¸€ä¸ª Builderï¼Œç”¨æ¥æ„å»º Balancer å®ä¾‹ã€‚ä»¥ <code>grpclb</code> è´Ÿè½½å‡è¡¡å™¨ä¸ºä¾‹ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">lbBuilder</span><span class="p">)</span> <span class="nf">Build</span><span class="p">(</span><span class="nx">cc</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">ClientConn</span><span class="p">,</span> <span class="nx">opt</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">BuildOptions</span><span class="p">)</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">Balancer</span> <span class="p">{</span>
	<span class="c1">// This generates a manual resolver builder with a fixed scheme. This
</span><span class="c1"></span>	<span class="c1">// scheme will be used to dial to remote LB, so we can send filtered
</span><span class="c1"></span>	<span class="c1">// address updates to remote LB ClientConn using this manual resolver.
</span><span class="c1"></span>  <span class="c1">// grpclb å†…éƒ¨çš„ resolverï¼Œæœ‰ç‰¹æ®Šç”¨é€”
</span><span class="c1"></span>	<span class="nx">r</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">lbManualResolver</span><span class="p">{</span><span class="nx">scheme</span><span class="p">:</span> <span class="s">&#34;grpclb-internal&#34;</span><span class="p">,</span> <span class="nx">ccb</span><span class="p">:</span> <span class="nx">cc</span><span class="p">}</span>

	<span class="nx">lb</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">lbBalancer</span><span class="p">{</span>
    <span class="c1">// æœ‰ç¼“å­˜åŠŸèƒ½çš„ ClientConn wrapper
</span><span class="c1"></span>		<span class="nx">cc</span><span class="p">:</span>              <span class="nf">newLBCacheClientConn</span><span class="p">(</span><span class="nx">cc</span><span class="p">)</span><span class="p">,</span>
		<span class="nx">target</span><span class="p">:</span>          <span class="nx">opt</span><span class="p">.</span><span class="nx">Target</span><span class="p">.</span><span class="nx">Endpoint</span><span class="p">,</span>
		<span class="nx">opt</span><span class="p">:</span>             <span class="nx">opt</span><span class="p">,</span>
		<span class="nx">fallbackTimeout</span><span class="p">:</span> <span class="nx">b</span><span class="p">.</span><span class="nx">fallbackTimeout</span><span class="p">,</span>
		<span class="nx">doneCh</span><span class="p">:</span>          <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{</span><span class="p">}</span><span class="p">)</span><span class="p">,</span>

		<span class="nx">manualResolver</span><span class="p">:</span> <span class="nx">r</span><span class="p">,</span>
		<span class="nx">subConns</span><span class="p">:</span>       <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">Address</span><span class="p">]</span><span class="nx">balancer</span><span class="p">.</span><span class="nx">SubConn</span><span class="p">)</span><span class="p">,</span>
		<span class="nx">scStates</span><span class="p">:</span>       <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">balancer</span><span class="p">.</span><span class="nx">SubConn</span><span class="p">]</span><span class="nx">connectivity</span><span class="p">.</span><span class="nx">State</span><span class="p">)</span><span class="p">,</span>
    <span class="c1">// åˆå§‹åŒ– picker
</span><span class="c1"></span>		<span class="nx">picker</span><span class="p">:</span>         <span class="o">&amp;</span><span class="nx">errPicker</span><span class="p">{</span><span class="nx">err</span><span class="p">:</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">ErrNoSubConnAvailable</span><span class="p">}</span><span class="p">,</span>
		<span class="nx">clientStats</span><span class="p">:</span>    <span class="nf">newRPCStats</span><span class="p">(</span><span class="p">)</span><span class="p">,</span>
		<span class="nx">backoff</span><span class="p">:</span>        <span class="nx">backoff</span><span class="p">.</span><span class="nx">DefaultExponential</span><span class="p">,</span> <span class="c1">// TODO: make backoff configurable.
</span><span class="c1"></span>	<span class="p">}</span>

	<span class="o">...</span>

	<span class="k">return</span> <span class="nx">lb</span>
<span class="p">}</span>
</code></pre></div><h3 id="balancer-æ¥å£">Balancer æ¥å£</h3>
<p>æˆ‘ä»¬å†æ¥çœ‹çœ‹ Balancer éƒ½æœ‰å“ªäº›æ–¹æ³•ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Balancer takes input from gRPC, manages SubConns, and collects and aggregates
</span><span class="c1"></span><span class="c1">// the connectivity states.
</span><span class="c1"></span><span class="c1">//
</span><span class="c1"></span><span class="c1">// It also generates and updates the Picker used by gRPC to pick SubConns for RPCs.
</span><span class="c1"></span><span class="c1">//
</span><span class="c1"></span><span class="c1">// UpdateClientConnState, ResolverError, UpdateSubConnState, and Close are
</span><span class="c1"></span><span class="c1">// guaranteed to be called synchronously from the same goroutine.  There&#39;s no
</span><span class="c1"></span><span class="c1">// guarantee on picker.Pick, it may be called anytime.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Balancer</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// å½“ ClientConn çš„çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶, gRPC ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•
</span><span class="c1"></span>	<span class="c1">// å¦‚æœè¿”å›çš„é”™è¯¯æ˜¯ErrBadResolverState, ClientConn ä¼šç«‹å³ä»¥æŒ‡æ•°é€€é¿çš„æ–¹å¼è°ƒç”¨ Resolver çš„ ResolveNow æ–¹æ³•,
</span><span class="c1"></span>	<span class="c1">// ç›´åˆ°è°ƒç”¨ UpdateClientConnState è¿”å› nil
</span><span class="c1"></span>	<span class="nf">UpdateClientConnState</span><span class="p">(</span><span class="nx">ClientConnState</span><span class="p">)</span> <span class="kt">error</span>
	<span class="c1">// å½“ resolver è§£æå‘ç”Ÿé”™è¯¯æ—¶, gRPC ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•
</span><span class="c1"></span>	<span class="nf">ResolverError</span><span class="p">(</span><span class="kt">error</span><span class="p">)</span>
	<span class="c1">// å½“å­è¿æ¥çŠ¶æ€å‘ç”Ÿå˜åŒ–æ—¶ï¼ŒgRPC ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•
</span><span class="c1"></span>	<span class="nf">UpdateSubConnState</span><span class="p">(</span><span class="nx">SubConn</span><span class="p">,</span> <span class="nx">SubConnState</span><span class="p">)</span>
	
	<span class="nf">Close</span><span class="p">(</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><h3 id="lbbalancerupdateclientconnstate">lbBalancer.UpdateClientConnState</h3>
<p>UpdateClientConnState æ˜¯å¦‚ä½•è¢«è°ƒç”¨çš„å‘¢ï¼ŸåŸæ¥æ˜¯é€šè¿‡å‰æ–‡æåˆ°çš„ <code>bw.updateClientConnState</code> æ¥é—´æ¥è°ƒç”¨çš„ï¼Œç”± Resolver åˆ° ClientConnï¼Œå†åˆ° Balancerï¼Œåœ¨ä¸‹é¢çš„è°ƒç”¨é“¾ä¸­ä¸€è§ˆæ— ä½™ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">ccResolverWrapper</span><span class="p">.</span><span class="nx">UpdateState</span> <span class="o">-</span><span class="p">&gt;</span> <span class="nx">ClientConn</span><span class="p">.</span><span class="nx">updateResolverState</span> <span class="o">-</span><span class="p">&gt;</span> <span class="nx">ccBalancerWrapper</span><span class="p">.</span><span class="nx">updateClientConnState</span> <span class="o">-</span><span class="p">&gt;</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">Balancer</span><span class="p">.</span><span class="nx">UpdateClientConnState</span>
</code></pre></div><p>ä¸Šé¢çš„è°ƒç”¨å…³ç³»ä¸­ä¸æ¶‰åŠåˆ°å…·ä½“çš„å®ç°ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ <code>lbBalancer.UpdateClientConnState</code> æ˜¯å¦‚ä½•å®ç°çš„ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">lb</span> <span class="o">*</span><span class="nx">lbBalancer</span><span class="p">)</span> <span class="nf">UpdateClientConnState</span><span class="p">(</span><span class="nx">ccs</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">ClientConnState</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nx">logger</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">logger</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;lbBalancer: UpdateClientConnState: %+v&#34;</span><span class="p">,</span> <span class="nx">ccs</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="c1">// å¤„ç† balancer é…ç½®
</span><span class="c1"></span>	<span class="nx">gc</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">ccs</span><span class="p">.</span><span class="nx">BalancerConfig</span><span class="p">.</span><span class="p">(</span><span class="o">*</span><span class="nx">grpclbServiceConfig</span><span class="p">)</span>
	<span class="nx">lb</span><span class="p">.</span><span class="nf">handleServiceConfig</span><span class="p">(</span><span class="nx">gc</span><span class="p">)</span>

	<span class="nx">addrs</span> <span class="o">:=</span> <span class="nx">ccs</span><span class="p">.</span><span class="nx">ResolverState</span><span class="p">.</span><span class="nx">Addresses</span>

	<span class="c1">// åŒºåˆ†åœ°å€çš„ç±»å‹, å¹¶ä¸”æŠŠ GRPCLB ç±»å‹çš„åœ°å€æ”¹ä¸ºäº† Backend
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">remoteBalancerAddrs</span><span class="p">,</span> <span class="nx">backendAddrs</span> <span class="p">[</span><span class="p">]</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">Address</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">a</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">addrs</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nx">Type</span> <span class="o">==</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">GRPCLB</span> <span class="p">{</span>
			<span class="nx">a</span><span class="p">.</span><span class="nx">Type</span> <span class="p">=</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">Backend</span>
			<span class="nx">remoteBalancerAddrs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">remoteBalancerAddrs</span><span class="p">,</span> <span class="nx">a</span><span class="p">)</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="nx">backendAddrs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">backendAddrs</span><span class="p">,</span> <span class="nx">a</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">sd</span> <span class="o">:=</span> <span class="nx">grpclbstate</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ccs</span><span class="p">.</span><span class="nx">ResolverState</span><span class="p">)</span><span class="p">;</span> <span class="nx">sd</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="c1">// Override any balancer addresses provided via
</span><span class="c1"></span>		<span class="c1">// ccs.ResolverState.Addresses.
</span><span class="c1"></span>		<span class="nx">remoteBalancerAddrs</span> <span class="p">=</span> <span class="nx">sd</span><span class="p">.</span><span class="nx">BalancerAddresses</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">backendAddrs</span><span class="p">)</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="nx">remoteBalancerAddrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="c1">// There should be at least one address, either grpclb server or
</span><span class="c1"></span>		<span class="c1">// fallback. Empty address is not valid.
</span><span class="c1"></span>		<span class="k">return</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">ErrBadResolverState</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">remoteBalancerAddrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">ccRemoteLB</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">lb</span><span class="p">.</span><span class="nx">ccRemoteLB</span><span class="p">.</span><span class="nb">close</span><span class="p">(</span><span class="p">)</span>
			<span class="nx">lb</span><span class="p">.</span><span class="nx">ccRemoteLB</span> <span class="p">=</span> <span class="kc">nil</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">ccRemoteLB</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="c1">// ç¬¬ä¸€æ¬¡æ”¶åˆ°è§£æåˆ°çš„ remoteBalancerAddrs åœ°å€, å»ºç«‹ä¸è¿œç¨‹è´Ÿè½½å‡è¡¡å™¨çš„è¿æ¥
</span><span class="c1"></span>		<span class="nx">lb</span><span class="p">.</span><span class="nf">newRemoteBalancerCCWrapper</span><span class="p">(</span><span class="p">)</span>
		<span class="c1">// Start the fallback goroutine.
</span><span class="c1"></span>		<span class="k">go</span> <span class="nx">lb</span><span class="p">.</span><span class="nf">fallbackToBackendsAfter</span><span class="p">(</span><span class="nx">lb</span><span class="p">.</span><span class="nx">fallbackTimeout</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">ccRemoteLB</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="c1">// cc to remote balancers uses lb.manualResolver. Send the updated remote
</span><span class="c1"></span>		<span class="c1">// balancer addresses to it through manualResolver.
</span><span class="c1"></span>		<span class="nx">lb</span><span class="p">.</span><span class="nx">manualResolver</span><span class="p">.</span><span class="nf">UpdateState</span><span class="p">(</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">Addresses</span><span class="p">:</span> <span class="nx">remoteBalancerAddrs</span><span class="p">}</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">lb</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">(</span><span class="p">)</span>
	<span class="nx">lb</span><span class="p">.</span><span class="nx">resolvedBackendAddrs</span> <span class="p">=</span> <span class="nx">backendAddrs</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">remoteBalancerAddrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">inFallback</span> <span class="p">{</span>
		<span class="c1">// If there&#39;s no remote balancer address in ClientConn update, grpclb
</span><span class="c1"></span>		<span class="c1">// enters fallback mode immediately.
</span><span class="c1"></span>		<span class="c1">//
</span><span class="c1"></span>		<span class="c1">// If a new update is received while grpclb is in fallback, update the
</span><span class="c1"></span>		<span class="c1">// list of backends being used to the new fallback backends.
</span><span class="c1"></span>		<span class="nx">lb</span><span class="p">.</span><span class="nf">refreshSubConns</span><span class="p">(</span><span class="nx">lb</span><span class="p">.</span><span class="nx">resolvedBackendAddrs</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">usePickFirst</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">lb</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">(</span><span class="p">)</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>lbBalancer æŠŠåœ°å€åˆ†ä¸ºä¸¤ç§ç±»å‹ï¼š<code>resolver.GRPCLB</code>ï¼Œ<code>resolver.Backend</code>ã€‚å½“ dnsResolver ä¼ è¿‡æ¥çš„åœ°å€åˆ—è¡¨ä¸­æœ‰ resolver.GRPCLBï¼ŒlbBalancer ä¼šä¸<code>resolver.GRPCLB</code>çš„è´Ÿè½½å‡è¡¡å™¨å»ºç«‹è¿æ¥ä»¥è·å–çœŸæ­£æœåŠ¡çš„åœ°å€ã€‚ä¸è¿‡ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå¹¶ä¸åšæ·±ç©¶ã€‚</p>
<h3 id="lbbalancernewremotebalancerccwrapper">lbBalancer.newRemoteBalancerCCWrapper</h3>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">lb</span> <span class="o">*</span><span class="nx">lbBalancer</span><span class="p">)</span> <span class="nf">refreshSubConns</span><span class="p">(</span><span class="nx">backendAddrs</span> <span class="p">[</span><span class="p">]</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="nx">fallback</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">pickFirst</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">opts</span> <span class="o">:=</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">NewSubConnOptions</span><span class="p">{</span><span class="p">}</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">fallback</span> <span class="p">{</span>
		<span class="nx">opts</span><span class="p">.</span><span class="nx">CredsBundle</span> <span class="p">=</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">grpclbBackendCreds</span>
	<span class="p">}</span>

	<span class="c1">// æ›´æ–°åç«¯åœ°å€
</span><span class="c1"></span>	<span class="nx">lb</span><span class="p">.</span><span class="nx">backendAddrs</span> <span class="p">=</span> <span class="nx">backendAddrs</span>
	<span class="nx">lb</span><span class="p">.</span><span class="nx">backendAddrsWithoutMetadata</span> <span class="p">=</span> <span class="kc">nil</span>

	<span class="nx">fallbackModeChanged</span> <span class="o">:=</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">inFallback</span> <span class="o">!=</span> <span class="nx">fallback</span>
	<span class="nx">lb</span><span class="p">.</span><span class="nx">inFallback</span> <span class="p">=</span> <span class="nx">fallback</span>
	<span class="k">if</span> <span class="nx">fallbackModeChanged</span> <span class="o">&amp;&amp;</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">inFallback</span> <span class="p">{</span>
		<span class="c1">// Clear previous received list when entering fallback, so if the server
</span><span class="c1"></span>		<span class="c1">// comes back and sends the same list again, the new addresses will be
</span><span class="c1"></span>		<span class="c1">// used.
</span><span class="c1"></span>		<span class="nx">lb</span><span class="p">.</span><span class="nx">fullServerList</span> <span class="p">=</span> <span class="kc">nil</span>
	<span class="p">}</span>

	<span class="c1">// åˆ¤æ–­é€‰å–ç­–ç•¥æ˜¯å¦å˜åŒ–ï¼Œè·å–ç¬¬ä¸€ä¸ªå¯ç”¨è¿æ¥
</span><span class="c1"></span>	<span class="nx">balancingPolicyChanged</span> <span class="o">:=</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">usePickFirst</span> <span class="o">!=</span> <span class="nx">pickFirst</span>
	<span class="nx">oldUsePickFirst</span> <span class="o">:=</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">usePickFirst</span>
	<span class="nx">lb</span><span class="p">.</span><span class="nx">usePickFirst</span> <span class="p">=</span> <span class="nx">pickFirst</span>

	<span class="k">if</span> <span class="nx">fallbackModeChanged</span> <span class="o">||</span> <span class="nx">balancingPolicyChanged</span> <span class="p">{</span>
		<span class="c1">// å¦‚æœç­–ç•¥å‘ç”Ÿå˜åŒ–ï¼Œåˆ é™¤æ‰€æœ‰çš„å·²ç»å»ºç«‹çš„è¿æ¥
</span><span class="c1"></span>		<span class="k">for</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">sc</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">subConns</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">oldUsePickFirst</span> <span class="p">{</span>
				<span class="c1">// If old SubConn were created for pickfirst, bypass cache and
</span><span class="c1"></span>				<span class="c1">// remove directly.
</span><span class="c1"></span>				<span class="nx">lb</span><span class="p">.</span><span class="nx">cc</span><span class="p">.</span><span class="nx">cc</span><span class="p">.</span><span class="nf">RemoveSubConn</span><span class="p">(</span><span class="nx">sc</span><span class="p">)</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="nx">lb</span><span class="p">.</span><span class="nx">cc</span><span class="p">.</span><span class="nf">RemoveSubConn</span><span class="p">(</span><span class="nx">sc</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="nb">delete</span><span class="p">(</span><span class="nx">lb</span><span class="p">.</span><span class="nx">subConns</span><span class="p">,</span> <span class="nx">a</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="c1">// ä½¿ç”¨ pickFirst ç­–ç•¥,åªéœ€è¦è·å–ä¸€ä¸ªå­è¿æ¥å°± ok äº†
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">usePickFirst</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">sc</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">SubConn</span>
		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">sc</span> <span class="p">=</span> <span class="k">range</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">subConns</span> <span class="p">{</span>
			<span class="k">break</span>
		<span class="p">}</span>
		<span class="c1">// æ›´æ–°åç«¯æœåŠ¡åœ°å€å¹¶è§¦å‘è¿æ¥
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">sc</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">sc</span><span class="p">.</span><span class="nf">UpdateAddresses</span><span class="p">(</span><span class="nx">backendAddrs</span><span class="p">)</span>
			<span class="nx">sc</span><span class="p">.</span><span class="nf">Connect</span><span class="p">(</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="p">}</span>
		<span class="c1">// This bypasses the cc wrapper with SubConn cache.
</span><span class="c1"></span>		<span class="c1">// æ–°å»ºä¸€ä¸ª SubConn, å¹¶è¿æ¥
</span><span class="c1"></span>		<span class="nx">sc</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">cc</span><span class="p">.</span><span class="nx">cc</span><span class="p">.</span><span class="nf">NewSubConn</span><span class="p">(</span><span class="nx">backendAddrs</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nx">logger</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;grpclb: failed to create new SubConn: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="p">}</span>
		<span class="nx">sc</span><span class="p">.</span><span class="nf">Connect</span><span class="p">(</span><span class="p">)</span>
		<span class="nx">lb</span><span class="p">.</span><span class="nx">subConns</span><span class="p">[</span><span class="nx">backendAddrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="p">]</span> <span class="p">=</span> <span class="nx">sc</span>
		<span class="nx">lb</span><span class="p">.</span><span class="nx">scStates</span><span class="p">[</span><span class="nx">sc</span><span class="p">]</span> <span class="p">=</span> <span class="nx">connectivity</span><span class="p">.</span><span class="nx">Idle</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="c1">// addrsSet is the set converted from backendAddrsWithoutMetadata, it&#39;s used to quick
</span><span class="c1"></span>	<span class="c1">// lookup for an address.
</span><span class="c1"></span>	<span class="nx">addrsSet</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">Address</span><span class="p">]</span><span class="kd">struct</span><span class="p">{</span><span class="p">}</span><span class="p">)</span>
	<span class="c1">// Create new SubConns.
</span><span class="c1"></span>	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">addr</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">backendAddrs</span> <span class="p">{</span>
		<span class="nx">addrWithoutMD</span> <span class="o">:=</span> <span class="nx">addr</span>
		<span class="nx">addrWithoutMD</span><span class="p">.</span><span class="nx">Metadata</span> <span class="p">=</span> <span class="kc">nil</span>
		<span class="nx">addrsSet</span><span class="p">[</span><span class="nx">addrWithoutMD</span><span class="p">]</span> <span class="p">=</span> <span class="kd">struct</span><span class="p">{</span><span class="p">}</span><span class="p">{</span><span class="p">}</span>
		<span class="nx">lb</span><span class="p">.</span><span class="nx">backendAddrsWithoutMetadata</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">lb</span><span class="p">.</span><span class="nx">backendAddrsWithoutMetadata</span><span class="p">,</span> <span class="nx">addrWithoutMD</span><span class="p">)</span>

		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">subConns</span><span class="p">[</span><span class="nx">addrWithoutMD</span><span class="p">]</span><span class="p">;</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
			<span class="c1">// Use addrWithMD to create the SubConn.
</span><span class="c1"></span>			<span class="nx">sc</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">cc</span><span class="p">.</span><span class="nf">NewSubConn</span><span class="p">(</span><span class="p">[</span><span class="p">]</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">Address</span><span class="p">{</span><span class="nx">addr</span><span class="p">}</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
			<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">logger</span><span class="p">.</span><span class="nf">Warningf</span><span class="p">(</span><span class="s">&#34;grpclb: failed to create new SubConn: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
				<span class="k">continue</span>
			<span class="p">}</span>
			<span class="nx">lb</span><span class="p">.</span><span class="nx">subConns</span><span class="p">[</span><span class="nx">addrWithoutMD</span><span class="p">]</span> <span class="p">=</span> <span class="nx">sc</span> <span class="c1">// Use the addr without MD as key for the map.
</span><span class="c1"></span>			<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">scStates</span><span class="p">[</span><span class="nx">sc</span><span class="p">]</span><span class="p">;</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
				<span class="c1">// Only set state of new sc to IDLE. The state could already be
</span><span class="c1"></span>				<span class="c1">// READY for cached SubConns.
</span><span class="c1"></span>				<span class="nx">lb</span><span class="p">.</span><span class="nx">scStates</span><span class="p">[</span><span class="nx">sc</span><span class="p">]</span> <span class="p">=</span> <span class="nx">connectivity</span><span class="p">.</span><span class="nx">Idle</span>
			<span class="p">}</span>
			<span class="nx">sc</span><span class="p">.</span><span class="nf">Connect</span><span class="p">(</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">sc</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">subConns</span> <span class="p">{</span>
		<span class="c1">// a was removed by resolver.
</span><span class="c1"></span>		<span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">addrsSet</span><span class="p">[</span><span class="nx">a</span><span class="p">]</span><span class="p">;</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
			<span class="nx">lb</span><span class="p">.</span><span class="nx">cc</span><span class="p">.</span><span class="nf">RemoveSubConn</span><span class="p">(</span><span class="nx">sc</span><span class="p">)</span>
			<span class="nb">delete</span><span class="p">(</span><span class="nx">lb</span><span class="p">.</span><span class="nx">subConns</span><span class="p">,</span> <span class="nx">a</span><span class="p">)</span>
			<span class="c1">// Keep the state of this sc in b.scStates until sc&#39;s state becomes Shutdown.
</span><span class="c1"></span>			<span class="c1">// The entry will be deleted in UpdateSubConnState.
</span><span class="c1"></span>		<span class="p">}</span>
	<span class="p">}</span>

	<span class="c1">// Regenerate and update picker after refreshing subconns because with
</span><span class="c1"></span>	<span class="c1">// cache, even if SubConn was newed/removed, there might be no state
</span><span class="c1"></span>	<span class="c1">// changes (the subconn will be kept in cache, not actually
</span><span class="c1"></span>	<span class="c1">// newed/removed).
</span><span class="c1"></span>	<span class="c1">// æ›´æ–° lb çš„çŠ¶æ€, å¹¶ä¸”é‡æ–°ç”Ÿæˆ Picker
</span><span class="c1"></span>	<span class="nx">lb</span><span class="p">.</span><span class="nf">updateStateAndPicker</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><h3 id="lbbalancerupdatestateandpicker">lbBalancer.updateStateAndPicker</h3>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">lb</span> <span class="o">*</span><span class="nx">lbBalancer</span><span class="p">)</span> <span class="nf">updateStateAndPicker</span><span class="p">(</span><span class="nx">forceRegeneratePicker</span> <span class="kt">bool</span><span class="p">,</span> <span class="nx">resetDrop</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">oldAggrState</span> <span class="o">:=</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">state</span>
	<span class="nx">lb</span><span class="p">.</span><span class="nx">state</span> <span class="p">=</span> <span class="nx">lb</span><span class="p">.</span><span class="nf">aggregateSubConnStates</span><span class="p">(</span><span class="p">)</span>
	<span class="c1">// Regenerate picker when one of the following happens:
</span><span class="c1"></span>	<span class="c1">//  - caller wants to regenerate
</span><span class="c1"></span>	<span class="c1">//  - the aggregated state changed
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">forceRegeneratePicker</span> <span class="o">||</span> <span class="p">(</span><span class="nx">lb</span><span class="p">.</span><span class="nx">state</span> <span class="o">!=</span> <span class="nx">oldAggrState</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// é‡æ–°ç”Ÿæˆ picker
</span><span class="c1"></span>		<span class="nx">lb</span><span class="p">.</span><span class="nf">regeneratePicker</span><span class="p">(</span><span class="nx">resetDrop</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="nx">lb</span><span class="p">.</span><span class="nx">cc</span><span class="p">.</span><span class="nf">UpdateState</span><span class="p">(</span><span class="nx">balancer</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">ConnectivityState</span><span class="p">:</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">Picker</span><span class="p">:</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">picker</span><span class="p">}</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><h3 id="lbbalancerregeneratepicker">lbBalancer.regeneratePicker</h3>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">lb</span> <span class="o">*</span><span class="nx">lbBalancer</span><span class="p">)</span> <span class="nf">regeneratePicker</span><span class="p">(</span><span class="nx">resetDrop</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// åˆ›å»º errpicker
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">state</span> <span class="o">==</span> <span class="nx">connectivity</span><span class="p">.</span><span class="nx">TransientFailure</span> <span class="p">{</span>
		<span class="nx">lb</span><span class="p">.</span><span class="nx">picker</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">errPicker</span><span class="p">{</span><span class="nx">err</span><span class="p">:</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">ErrTransientFailure</span><span class="p">}</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="c1">// åˆ›å»º errpicker
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">state</span> <span class="o">==</span> <span class="nx">connectivity</span><span class="p">.</span><span class="nx">Connecting</span> <span class="p">{</span>
		<span class="nx">lb</span><span class="p">.</span><span class="nx">picker</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">errPicker</span><span class="p">{</span><span class="nx">err</span><span class="p">:</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">ErrNoSubConnAvailable</span><span class="p">}</span>
		<span class="k">return</span>
	<span class="p">}</span>
	
  <span class="c1">// å¦‚æœæ˜¯ pickFirstï¼Œ åˆ™è·å–ç¬¬ä¸€ä¸ª subConn å°±è¡Œäº†
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">readySCs</span> <span class="p">[</span><span class="p">]</span><span class="nx">balancer</span><span class="p">.</span><span class="nx">SubConn</span>
	<span class="k">if</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">usePickFirst</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">sc</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">subConns</span> <span class="p">{</span>
			<span class="nx">readySCs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">readySCs</span><span class="p">,</span> <span class="nx">sc</span><span class="p">)</span>
			<span class="k">break</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">a</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">backendAddrsWithoutMetadata</span> <span class="p">{</span>
			<span class="k">if</span> <span class="nx">sc</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">subConns</span><span class="p">[</span><span class="nx">a</span><span class="p">]</span><span class="p">;</span> <span class="nx">ok</span> <span class="p">{</span>
				<span class="k">if</span> <span class="nx">st</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">scStates</span><span class="p">[</span><span class="nx">sc</span><span class="p">]</span><span class="p">;</span> <span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="nx">st</span> <span class="o">==</span> <span class="nx">connectivity</span><span class="p">.</span><span class="nx">Ready</span> <span class="p">{</span>
					<span class="nx">readySCs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">readySCs</span><span class="p">,</span> <span class="nx">sc</span><span class="p">)</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">readySCs</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="c1">// If there&#39;s no ready SubConns, always re-pick. This is to avoid drops
</span><span class="c1"></span>		<span class="c1">// unless at least one SubConn is ready. Otherwise we may drop more
</span><span class="c1"></span>		<span class="c1">// often than want because of drops + re-picks(which become re-drops).
</span><span class="c1"></span>		<span class="c1">//
</span><span class="c1"></span>		<span class="c1">// This doesn&#39;t seem to be necessary after the connecting check above.
</span><span class="c1"></span>		<span class="c1">// Kept for safety.
</span><span class="c1"></span>		<span class="nx">lb</span><span class="p">.</span><span class="nx">picker</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">errPicker</span><span class="p">{</span><span class="nx">err</span><span class="p">:</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">ErrNoSubConnAvailable</span><span class="p">}</span>
		<span class="k">return</span>
	<span class="p">}</span>
  <span class="c1">// å¦‚æœæ˜¯ fallbackï¼Œåˆ™ä½¿ç”¨ RoundRobin
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">inFallback</span> <span class="p">{</span>
		<span class="nx">lb</span><span class="p">.</span><span class="nx">picker</span> <span class="p">=</span> <span class="nf">newRRPicker</span><span class="p">(</span><span class="nx">readySCs</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="p">}</span>
  <span class="c1">// å¦‚æœæ˜¯éœ€è¦é‡ç½®ï¼Œåˆ›å»ºæ–°çš„ Picker
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">resetDrop</span> <span class="p">{</span>
		<span class="nx">lb</span><span class="p">.</span><span class="nx">picker</span> <span class="p">=</span> <span class="nf">newLBPicker</span><span class="p">(</span><span class="nx">lb</span><span class="p">.</span><span class="nx">fullServerList</span><span class="p">,</span> <span class="nx">readySCs</span><span class="p">,</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">clientStats</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="p">}</span>
  <span class="c1">// åŸæ¥çš„ Picker ä¸æ˜¯ lbPickerï¼Œåˆ›å»ºæ–° Picker
</span><span class="c1"></span>	<span class="nx">prevLBPicker</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">picker</span><span class="p">.</span><span class="p">(</span><span class="o">*</span><span class="nx">lbPicker</span><span class="p">)</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
		<span class="nx">lb</span><span class="p">.</span><span class="nx">picker</span> <span class="p">=</span> <span class="nf">newLBPicker</span><span class="p">(</span><span class="nx">lb</span><span class="p">.</span><span class="nx">fullServerList</span><span class="p">,</span> <span class="nx">readySCs</span><span class="p">,</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">clientStats</span><span class="p">)</span>
		<span class="k">return</span>
	<span class="p">}</span>
  <span class="c1">// æ›´æ–° SubConn
</span><span class="c1"></span>	<span class="nx">prevLBPicker</span><span class="p">.</span><span class="nf">updateReadySCs</span><span class="p">(</span><span class="nx">readySCs</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><h2 id="5-åç«¯æœåŠ¡å»ºç«‹è¿æ¥">5. åç«¯æœåŠ¡å»ºç«‹è¿æ¥</h2>
<p>è™½ç„¶å‰é¢å‰–æäº† Balancer çš„å®ç°åŸç†ï¼Œä½†æˆ‘ä»¬å´å¹¶ä¸çŸ¥é“ä¸åç«¯æœåŠ¡çš„è¿æ¥æ˜¯åœ¨å“ªé‡Œå»ºç«‹çš„ï¼Œç­”æ¡ˆå°±åœ¨ <code>ClientConn.NewSubConn</code>ä¸­ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">ccb</span> <span class="o">*</span><span class="nx">ccBalancerWrapper</span><span class="p">)</span> <span class="nf">NewSubConn</span><span class="p">(</span><span class="nx">addrs</span> <span class="p">[</span><span class="p">]</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">NewSubConnOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">balancer</span><span class="p">.</span><span class="nx">SubConn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">addrs</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;grpc: cannot create SubConn with empty address list&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">ccb</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">(</span><span class="p">)</span>
	<span class="k">defer</span> <span class="nx">ccb</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">(</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">ccb</span><span class="p">.</span><span class="nx">subConns</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;grpc: ClientConn balancer wrapper was closed&#34;</span><span class="p">)</span>
	<span class="p">}</span>
  <span class="c1">// è°ƒç”¨ grpc.ClientConn.newAddrConn æ¥åˆ›å»ºäºåç«¯æœåŠ¡çš„è¿æ¥
</span><span class="c1"></span>	<span class="nx">ac</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ccb</span><span class="p">.</span><span class="nx">cc</span><span class="p">.</span><span class="nf">newAddrConn</span><span class="p">(</span><span class="nx">addrs</span><span class="p">,</span> <span class="nx">opts</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">acbw</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">acBalancerWrapper</span><span class="p">{</span><span class="nx">ac</span><span class="p">:</span> <span class="nx">ac</span><span class="p">}</span>
	<span class="nx">acbw</span><span class="p">.</span><span class="nx">ac</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">(</span><span class="p">)</span>
	<span class="nx">ac</span><span class="p">.</span><span class="nx">acbw</span> <span class="p">=</span> <span class="nx">acbw</span>
	<span class="nx">acbw</span><span class="p">.</span><span class="nx">ac</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">(</span><span class="p">)</span>
  <span class="c1">// 
</span><span class="c1"></span>	<span class="nx">ccb</span><span class="p">.</span><span class="nx">subConns</span><span class="p">[</span><span class="nx">acbw</span><span class="p">]</span> <span class="p">=</span> <span class="kd">struct</span><span class="p">{</span><span class="p">}</span><span class="p">{</span><span class="p">}</span>
	<span class="k">return</span> <span class="nx">acbw</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>åœ¨ NewSubConn ä¸­ä¼šè°ƒç”¨ <code>cc.newAddrConn</code> æ¥å»ºç«‹è¿æ¥å¯¹è±¡ <code>acBalancerWrapper</code> å¹¶æŠŠå®ƒæ·»åŠ åˆ° ClientConn çš„ conns è¿æ¥æ± ä¸­ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰çœŸæ­£å»ºç«‹è¿æ¥ï¼Œè€Œåªæ˜¯åˆå§‹åŒ–äº†è¿æ¥çŠ¶æ€ä¸º <code>Idle</code>ï¼Œç„¶åè¿”å›äº†è¿æ¥çš„å®ä¾‹ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// newAddrConn creates an addrConn for addrs and adds it to cc.conns.
</span><span class="c1"></span><span class="c1">//
</span><span class="c1"></span><span class="c1">// Caller needs to make sure len(addrs) &gt; 0.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">cc</span> <span class="o">*</span><span class="nx">ClientConn</span><span class="p">)</span> <span class="nf">newAddrConn</span><span class="p">(</span><span class="nx">addrs</span> <span class="p">[</span><span class="p">]</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">NewSubConnOptions</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">addrConn</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">ac</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">addrConn</span><span class="p">{</span>
		<span class="nx">state</span><span class="p">:</span>        <span class="nx">connectivity</span><span class="p">.</span><span class="nx">Idle</span><span class="p">,</span>	<span class="c1">// åˆå§‹åŒ–çŠ¶æ€ä¸º Idle
</span><span class="c1"></span>		<span class="nx">cc</span><span class="p">:</span>           <span class="nx">cc</span><span class="p">,</span>
		<span class="nx">addrs</span><span class="p">:</span>        <span class="nx">addrs</span><span class="p">,</span>
		<span class="nx">scopts</span><span class="p">:</span>       <span class="nx">opts</span><span class="p">,</span>
		<span class="nx">dopts</span><span class="p">:</span>        <span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">,</span>
		<span class="nx">czData</span><span class="p">:</span>       <span class="nb">new</span><span class="p">(</span><span class="nx">channelzData</span><span class="p">)</span><span class="p">,</span>
		<span class="nx">resetBackoff</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{</span><span class="p">}</span><span class="p">)</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="nx">ac</span><span class="p">.</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">ac</span><span class="p">.</span><span class="nx">cancel</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithCancel</span><span class="p">(</span><span class="nx">cc</span><span class="p">.</span><span class="nx">ctx</span><span class="p">)</span>
	<span class="c1">// Track ac in cc. This needs to be done before any getTransport(...) is called.
</span><span class="c1"></span>	<span class="nx">cc</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">(</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">conns</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">cc</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">(</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">ErrClientConnClosing</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="nx">channelz</span><span class="p">.</span><span class="nf">IsOn</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">ac</span><span class="p">.</span><span class="nx">channelzID</span> <span class="p">=</span> <span class="nx">channelz</span><span class="p">.</span><span class="nf">RegisterSubChannel</span><span class="p">(</span><span class="nx">ac</span><span class="p">,</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">channelzID</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">)</span>
		<span class="nx">channelz</span><span class="p">.</span><span class="nf">AddTraceEvent</span><span class="p">(</span><span class="nx">logger</span><span class="p">,</span> <span class="nx">ac</span><span class="p">.</span><span class="nx">channelzID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">channelz</span><span class="p">.</span><span class="nx">TraceEventDesc</span><span class="p">{</span>
			<span class="nx">Desc</span><span class="p">:</span>     <span class="s">&#34;Subchannel Created&#34;</span><span class="p">,</span>
			<span class="nx">Severity</span><span class="p">:</span> <span class="nx">channelz</span><span class="p">.</span><span class="nx">CtInfo</span><span class="p">,</span>
			<span class="nx">Parent</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">channelz</span><span class="p">.</span><span class="nx">TraceEventDesc</span><span class="p">{</span>
				<span class="nx">Desc</span><span class="p">:</span>     <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;Subchannel(id:%d) created&#34;</span><span class="p">,</span> <span class="nx">ac</span><span class="p">.</span><span class="nx">channelzID</span><span class="p">)</span><span class="p">,</span>
				<span class="nx">Severity</span><span class="p">:</span> <span class="nx">channelz</span><span class="p">.</span><span class="nx">CtInfo</span><span class="p">,</span>
			<span class="p">}</span><span class="p">,</span>
		<span class="p">}</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">cc</span><span class="p">.</span><span class="nx">conns</span><span class="p">[</span><span class="nx">ac</span><span class="p">]</span> <span class="p">=</span> <span class="kd">struct</span><span class="p">{</span><span class="p">}</span><span class="p">{</span><span class="p">}</span>
	<span class="nx">cc</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">(</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">ac</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><h3 id="acbalancerwrapper">acBalancerWrapper</h3>
<p>acBalancerWrapper æ˜¯ addrConn çš„ wrapperï¼Œå®ç°äº† SubConn æ¥å£ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// acBalancerWrapper is a wrapper on top of ac for balancers.
</span><span class="c1"></span><span class="c1">// It implements balancer.SubConn interface.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">acBalancerWrapper</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">mu</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
	<span class="nx">ac</span> <span class="o">*</span><span class="nx">addrConn</span>
<span class="p">}</span>

<span class="c1">// SubConn represents a gRPC sub connection.
</span><span class="c1"></span><span class="c1">// Each sub connection contains a list of addresses. gRPC will
</span><span class="c1"></span><span class="c1">// try to connect to them (in sequence), and stop trying the
</span><span class="c1"></span><span class="c1">// remainder once one connection is successful.
</span><span class="c1"></span><span class="c1">// gRPC ä¼šæŒ‰é¡ºåºå°è¯•è¿æ¥æ‰€æœ‰çš„åœ°å€, åœ¨æˆåŠŸè¿æ¥ä¸€ä¸ªä¹‹ååœæ­¢è¿æ¥
</span><span class="c1"></span><span class="c1">//
</span><span class="c1"></span><span class="c1">// The reconnect backoff will be applied on the list, not a single address.
</span><span class="c1"></span><span class="c1">// For example, try_on_all_addresses -&gt; backoff -&gt; try_on_all_addresses.
</span><span class="c1"></span><span class="c1">//
</span><span class="c1"></span><span class="c1">// All SubConns start in IDLE, and will not try to connect. To trigger
</span><span class="c1"></span><span class="c1">// the connecting, Balancers must call Connect.
</span><span class="c1"></span><span class="c1">// When the connection encounters an error, it will reconnect immediately.
</span><span class="c1"></span><span class="c1">// When the connection becomes IDLE, it will not reconnect unless Connect is
</span><span class="c1"></span><span class="c1">// called.
</span><span class="c1"></span><span class="c1">//
</span><span class="c1"></span><span class="c1">// This interface is to be implemented by gRPC. Users should not need a
</span><span class="c1"></span><span class="c1">// brand new implementation of this interface. For the situations like
</span><span class="c1"></span><span class="c1">// testing, the new implementation should embed this interface. This allows
</span><span class="c1"></span><span class="c1">// gRPC to add new methods to this interface.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">SubConn</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// UpdateAddresses updates the addresses used in this SubConn.
</span><span class="c1"></span>	<span class="c1">// gRPC checks if currently-connected address is still in the new list.
</span><span class="c1"></span>	<span class="c1">// If it&#39;s in the list, the connection will be kept.
</span><span class="c1"></span>	<span class="c1">// If it&#39;s not in the list, the connection will gracefully closed, and
</span><span class="c1"></span>	<span class="c1">// a new connection will be created.
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// This will trigger a state transition for the SubConn.
</span><span class="c1"></span>	<span class="nf">UpdateAddresses</span><span class="p">(</span><span class="p">[</span><span class="p">]</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">Address</span><span class="p">)</span>
	<span class="c1">// Connect starts the connecting for this SubConn.
</span><span class="c1"></span>	<span class="nf">Connect</span><span class="p">(</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>åœ¨å®Œæˆ NewSubConn çš„è°ƒç”¨åï¼Œè¿˜éœ€è¦æ‰‹åŠ¨è°ƒç”¨ <code>SubConn.Connect</code> æ¥å®Œæˆè¿æ¥çš„å»ºç«‹ï¼Œåœ¨ Connect ä¸­åˆä¼šè°ƒç”¨ <code>addrConn.connect</code>ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">acbw</span> <span class="o">*</span><span class="nx">acBalancerWrapper</span><span class="p">)</span> <span class="nf">Connect</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">acbw</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">(</span><span class="p">)</span>
	<span class="k">defer</span> <span class="nx">acbw</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">(</span><span class="p">)</span>
	<span class="nx">acbw</span><span class="p">.</span><span class="nx">ac</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">ac</span> <span class="o">*</span><span class="nx">addrConn</span><span class="p">)</span> <span class="nf">connect</span><span class="p">(</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">ac</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">(</span><span class="p">)</span>
  <span class="c1">// è¿æ¥å·²ç»å…³é—­ï¼Œè¿”å›é”™è¯¯
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">ac</span><span class="p">.</span><span class="nx">state</span> <span class="o">==</span> <span class="nx">connectivity</span><span class="p">.</span><span class="nx">Shutdown</span> <span class="p">{</span>
		<span class="nx">ac</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">(</span><span class="p">)</span>
		<span class="k">return</span> <span class="nx">errConnClosing</span>
	<span class="p">}</span>
  <span class="c1">// è¿æ¥çŠ¶æ€ä¸æ˜¯ Idleï¼Œè¯´æ˜æ­£åœ¨è¿æ¥ä¸­ï¼Œæˆ–è€…å·²ç»åˆ›å»ºäº†è¿æ¥
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">ac</span><span class="p">.</span><span class="nx">state</span> <span class="o">!=</span> <span class="nx">connectivity</span><span class="p">.</span><span class="nx">Idle</span> <span class="p">{</span>
		<span class="nx">ac</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">(</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">nil</span>
	<span class="p">}</span>
	<span class="c1">// Update connectivity state within the lock to prevent subsequent or
</span><span class="c1"></span>	<span class="c1">// concurrent calls from resetting the transport more than once.
</span><span class="c1"></span>  <span class="c1">// æŠŠè¿æ¥çŠ¶æ€æ›´æ–°ä¸ºè¿æ¥ä¸­
</span><span class="c1"></span>	<span class="nx">ac</span><span class="p">.</span><span class="nf">updateConnectivityState</span><span class="p">(</span><span class="nx">connectivity</span><span class="p">.</span><span class="nx">Connecting</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
	<span class="nx">ac</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">(</span><span class="p">)</span>

	<span class="c1">// Start a goroutine connecting to the server asynchronously.
</span><span class="c1"></span>  <span class="c1">// å¼‚æ­¥è¿æ¥æœåŠ¡å™¨
</span><span class="c1"></span>	<span class="k">go</span> <span class="nx">ac</span><span class="p">.</span><span class="nf">resetTransport</span><span class="p">(</span><span class="p">)</span>
	<span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><h3 id="addrconnupdateconnectivitystate">addrConn.updateConnectivityState</h3>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">ac</span> <span class="o">*</span><span class="nx">addrConn</span><span class="p">)</span> <span class="nf">updateConnectivityState</span><span class="p">(</span><span class="nx">s</span> <span class="nx">connectivity</span><span class="p">.</span><span class="nx">State</span><span class="p">,</span> <span class="nx">lastErr</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
   <span class="k">if</span> <span class="nx">ac</span><span class="p">.</span><span class="nx">state</span> <span class="o">==</span> <span class="nx">s</span> <span class="p">{</span>
      <span class="k">return</span>
   <span class="p">}</span>
   <span class="nx">ac</span><span class="p">.</span><span class="nx">state</span> <span class="p">=</span> <span class="nx">s</span>
   <span class="nx">channelz</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="nx">logger</span><span class="p">,</span> <span class="nx">ac</span><span class="p">.</span><span class="nx">channelzID</span><span class="p">,</span> <span class="s">&#34;Subchannel Connectivity change to %v&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
   <span class="nx">ac</span><span class="p">.</span><span class="nx">cc</span><span class="p">.</span><span class="nf">handleSubConnStateChange</span><span class="p">(</span><span class="nx">ac</span><span class="p">.</span><span class="nx">acbw</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">lastErr</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>updateConnectivityState ä¼šè°ƒç”¨ <code>ClientConn.handleSubConnStateChange</code> æ¥é€šçŸ¥ gRPC å­è¿æ¥çŠ¶æ€å‘ç”Ÿå˜åŒ–ï¼Œé‚£ ClientConn åˆæ˜¯å¦‚ä½•é€šçŸ¥ Balancer çš„å‘¢ï¼Ÿ</p>
<p>è°ƒç”¨é“¾å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">addrConn</span><span class="p">.</span><span class="nx">updateConnectivityState</span> <span class="o">-</span><span class="p">&gt;</span> <span class="nx">ClientConn</span><span class="p">.</span><span class="nx">handleSubConnStateChange</span> <span class="o">-</span><span class="p">&gt;</span> <span class="nx">ccBalancerWrapper</span><span class="p">.</span><span class="nx">handleSubConnStateChange</span> <span class="o">-</span><span class="p">&gt;</span> <span class="nx">ccb</span><span class="p">.</span><span class="nx">scBuffer</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">scStateUpdate</span><span class="p">{</span>
		<span class="nx">sc</span><span class="p">:</span>    <span class="nx">sc</span><span class="p">,</span>
		<span class="nx">state</span><span class="p">:</span> <span class="nx">s</span><span class="p">,</span>
		<span class="nx">err</span><span class="p">:</span>   <span class="nx">err</span><span class="p">,</span>
	<span class="p">}</span><span class="p">)</span> <span class="c1">// å‘é€åˆ° channel
</span></code></pre></div><p>è¿˜è®°å¾— watcher å‡½æ•°å—ï¼Ÿåœ¨ Build çš„æ—¶å€™ä¼šå¯åŠ¨ä¸€ä¸ªåç¨‹æ¥æ‰§è¡Œè¿™ä¸ªæ–¹æ³•ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// watcher balancer functions sequentially, so the balancer can be implemented
</span><span class="c1"></span><span class="c1">// lock-free.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">ccb</span> <span class="o">*</span><span class="nx">ccBalancerWrapper</span><span class="p">)</span> <span class="nf">watcher</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="k">select</span> <span class="p">{</span>
		<span class="c1">// handleSubConnStateChangeè§¦å‘
</span><span class="c1"></span>		<span class="k">case</span> <span class="nx">t</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">ccb</span><span class="p">.</span><span class="nx">scBuffer</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="p">)</span><span class="p">:</span>
			<span class="nx">ccb</span><span class="p">.</span><span class="nx">scBuffer</span><span class="p">.</span><span class="nf">Load</span><span class="p">(</span><span class="p">)</span>
			<span class="k">if</span> <span class="nx">ccb</span><span class="p">.</span><span class="nx">done</span><span class="p">.</span><span class="nf">HasFired</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">break</span>
			<span class="p">}</span>
			<span class="nx">ccb</span><span class="p">.</span><span class="nx">balancerMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">(</span><span class="p">)</span>
			<span class="nx">su</span> <span class="o">:=</span> <span class="nx">t</span><span class="p">.</span><span class="p">(</span><span class="o">*</span><span class="nx">scStateUpdate</span><span class="p">)</span>
			<span class="nx">ccb</span><span class="p">.</span><span class="nx">balancer</span><span class="p">.</span><span class="nf">UpdateSubConnState</span><span class="p">(</span><span class="nx">su</span><span class="p">.</span><span class="nx">sc</span><span class="p">,</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">SubConnState</span><span class="p">{</span><span class="nx">ConnectivityState</span><span class="p">:</span> <span class="nx">su</span><span class="p">.</span><span class="nx">state</span><span class="p">,</span> <span class="nx">ConnectionError</span><span class="p">:</span> <span class="nx">su</span><span class="p">.</span><span class="nx">err</span><span class="p">}</span><span class="p">)</span>
			<span class="nx">ccb</span><span class="p">.</span><span class="nx">balancerMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">(</span><span class="p">)</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ccb</span><span class="p">.</span><span class="nx">done</span><span class="p">.</span><span class="nf">Done</span><span class="p">(</span><span class="p">)</span><span class="p">:</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="nx">ccb</span><span class="p">.</span><span class="nx">done</span><span class="p">.</span><span class="nf">HasFired</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">ccb</span><span class="p">.</span><span class="nx">balancer</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="p">)</span>
			<span class="nx">ccb</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">(</span><span class="p">)</span>
			<span class="nx">scs</span> <span class="o">:=</span> <span class="nx">ccb</span><span class="p">.</span><span class="nx">subConns</span>
			<span class="nx">ccb</span><span class="p">.</span><span class="nx">subConns</span> <span class="p">=</span> <span class="kc">nil</span>
			<span class="nx">ccb</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">(</span><span class="p">)</span>
			<span class="k">for</span> <span class="nx">acbw</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">scs</span> <span class="p">{</span>
				<span class="nx">ccb</span><span class="p">.</span><span class="nx">cc</span><span class="p">.</span><span class="nf">removeAddrConn</span><span class="p">(</span><span class="nx">acbw</span><span class="p">.</span><span class="nf">getAddrConn</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="nx">errConnDrain</span><span class="p">)</span>
			<span class="p">}</span>
			<span class="nx">ccb</span><span class="p">.</span><span class="nf">UpdateState</span><span class="p">(</span><span class="nx">balancer</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">ConnectivityState</span><span class="p">:</span> <span class="nx">connectivity</span><span class="p">.</span><span class="nx">Connecting</span><span class="p">,</span> <span class="nx">Picker</span><span class="p">:</span> <span class="kc">nil</span><span class="p">}</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>å“ˆå“ˆï¼Œæˆ‘ä»¬åˆå›åˆ°äº†è¿™é‡Œã€‚çœ‹æ¥ watcher æ–¹æ³•çš„å·¥ä½œå°±æ˜¯ç›‘å¬å­è¿æ¥çš„çŠ¶æ€å˜åŒ–ï¼Œå¹¶ä¸”è°ƒç”¨ <code>balancer.UpdateSubConnState</code> æ¥æ‰§è¡Œæ›´æ–°æ“ä½œã€‚</p>
<h3 id="balancerupdatesubconnstate">balancer.UpdateSubConnState</h3>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">lb</span> <span class="o">*</span><span class="nx">lbBalancer</span><span class="p">)</span> <span class="nf">UpdateSubConnState</span><span class="p">(</span><span class="nx">sc</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">SubConn</span><span class="p">,</span> <span class="nx">scs</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">SubConnState</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">s</span> <span class="o">:=</span> <span class="nx">scs</span><span class="p">.</span><span class="nx">ConnectivityState</span>
	<span class="k">if</span> <span class="nx">logger</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">logger</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;lbBalancer: handle SubConn state change: %p, %v&#34;</span><span class="p">,</span> <span class="nx">sc</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">lb</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">(</span><span class="p">)</span>
	<span class="k">defer</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">(</span><span class="p">)</span>

	<span class="nx">oldS</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">scStates</span><span class="p">[</span><span class="nx">sc</span><span class="p">]</span>
	<span class="k">if</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">logger</span><span class="p">.</span><span class="nf">V</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">logger</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="s">&#34;lbBalancer: got state changes for an unknown SubConn: %p, %v&#34;</span><span class="p">,</span> <span class="nx">sc</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="k">return</span>
	<span class="p">}</span>
	<span class="nx">lb</span><span class="p">.</span><span class="nx">scStates</span><span class="p">[</span><span class="nx">sc</span><span class="p">]</span> <span class="p">=</span> <span class="nx">s</span>
	<span class="k">switch</span> <span class="nx">s</span> <span class="p">{</span>
	<span class="k">case</span> <span class="nx">connectivity</span><span class="p">.</span><span class="nx">Idle</span><span class="p">:</span>	<span class="c1">// Idleï¼Œåˆ™é‡æ–°å»ºç«‹è¿æ¥
</span><span class="c1"></span>		<span class="nx">sc</span><span class="p">.</span><span class="nf">Connect</span><span class="p">(</span><span class="p">)</span>
	<span class="k">case</span> <span class="nx">connectivity</span><span class="p">.</span><span class="nx">Shutdown</span><span class="p">:</span>	<span class="c1">// Shutdownï¼Œ åˆ é™¤å½“å‰è¿æ¥
</span><span class="c1"></span>		<span class="c1">// When an address was removed by resolver, b called RemoveSubConn but
</span><span class="c1"></span>		<span class="c1">// kept the sc&#39;s state in scStates. Remove state for this sc here.
</span><span class="c1"></span>		<span class="nb">delete</span><span class="p">(</span><span class="nx">lb</span><span class="p">.</span><span class="nx">scStates</span><span class="p">,</span> <span class="nx">sc</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="c1">// Force regenerate picker if
</span><span class="c1"></span>	<span class="c1">//  - this sc became ready from not-ready
</span><span class="c1"></span>	<span class="c1">//  - this sc became not-ready from ready
</span><span class="c1"></span>  <span class="c1">// æ›´æ–°çŠ¶æ€ï¼Œå·²ç»é‡æ–°ç”Ÿæˆ picker
</span><span class="c1"></span>	<span class="nx">lb</span><span class="p">.</span><span class="nf">updateStateAndPicker</span><span class="p">(</span><span class="p">(</span><span class="nx">oldS</span> <span class="o">==</span> <span class="nx">connectivity</span><span class="p">.</span><span class="nx">Ready</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="nx">s</span> <span class="o">==</span> <span class="nx">connectivity</span><span class="p">.</span><span class="nx">Ready</span><span class="p">)</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>

	<span class="c1">// Enter fallback when the aggregated state is not Ready and the connection
</span><span class="c1"></span>	<span class="c1">// to remote balancer is lost.
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">state</span> <span class="o">!=</span> <span class="nx">connectivity</span><span class="p">.</span><span class="nx">Ready</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">!</span><span class="nx">lb</span><span class="p">.</span><span class="nx">inFallback</span> <span class="o">&amp;&amp;</span> <span class="p">!</span><span class="nx">lb</span><span class="p">.</span><span class="nx">remoteBalancerConnected</span> <span class="p">{</span>
			<span class="c1">// Enter fallback.
</span><span class="c1"></span>			<span class="nx">lb</span><span class="p">.</span><span class="nf">refreshSubConns</span><span class="p">(</span><span class="nx">lb</span><span class="p">.</span><span class="nx">resolvedBackendAddrs</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="nx">lb</span><span class="p">.</span><span class="nx">usePickFirst</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h2 id="6-æ€»ç»“">6. æ€»ç»“</h2>
<p>è®¾è®¡è€…ä¸ºäº†è®© Resolver ï¼ŒBalancer å®ç°è§£è€¦ï¼Œå¯è°“æ˜¯ç…è´¹è‹¦å¿ƒï¼Œè€Œä¸”ä¹Ÿå®ç°çš„ååˆ†ä¼˜ç§€ã€‚å½“ç„¶ dnsBalancer çš„å®ç°ç›¸å¯¹æ¥è¯´æœ‰ç‚¹å¤æ‚ï¼Œå¦‚æœæ²¡æœ‰ä½¿ç”¨è¿‡ grpclb çš„è¯ï¼Œç†è§£èµ·æ¥ä¼šæœ‰ç‚¹å›°éš¾ï¼Œä¸è¿‡è¿™å¹¶ä¸å½±å“æˆ‘ä»¬å­¦ä¹  Balancer çš„è®¾è®¡æ€æƒ³ï¼Œä¸‹é¢æ˜¯è°ƒç”¨å…³ç³»æ€»ç»“ï¼š</p>
<p><img src="https://blog-wero.oss-cn-shanghai.aliyuncs.com/img/resolver-balancer-clientconn%E4%BA%A4%E4%BA%92%E6%B5%81%E7%A8%8B.png" alt=""></p>
<p>å’±ä»¬ä¸‹ç¯‡æ–‡ç« è§ï¼</p>
]]></content>
		</item>
		
		<item>
			<title>go-zero æºç åˆ†æè®¡åˆ’</title>
			<link>https://wangzeping722.github.io/posts/go-zero/</link>
			<pubDate>Fri, 06 Nov 2020 13:03:49 +0800</pubDate>
			
			<guid>https://wangzeping722.github.io/posts/go-zero/</guid>
			<description>go-zero æ˜¯ä¸€ä¸ªé›†æˆäº†å„ç§å·¥ç¨‹å®è·µçš„ web å’Œ rpc æ¡†æ¶ã€‚é€šè¿‡å¼¹æ€§è®¾è®¡ä¿éšœäº†å¤§å¹¶å‘æœåŠ¡ç«¯çš„ç¨³å®šæ€§ï¼Œç»å—äº†å……åˆ†çš„å®æˆ˜æ£€éªŒã€‚ go-zero åŒ…å«æç®€çš„ API å®šä¹‰å’Œç”Ÿæˆå·¥å…· goctl</description>
			<content type="html"><![CDATA[<p><a href="https://github.com/tal-tech/go-zero">go-zero</a> æ˜¯ä¸€ä¸ªé›†æˆäº†å„ç§å·¥ç¨‹å®è·µçš„ web å’Œ rpc æ¡†æ¶ã€‚é€šè¿‡å¼¹æ€§è®¾è®¡ä¿éšœäº†å¤§å¹¶å‘æœåŠ¡ç«¯çš„ç¨³å®šæ€§ï¼Œç»å—äº†å……åˆ†çš„å®æˆ˜æ£€éªŒã€‚</p>
<p>go-zero åŒ…å«æç®€çš„ API å®šä¹‰å’Œç”Ÿæˆå·¥å…· goctlï¼Œå¯ä»¥æ ¹æ®å®šä¹‰çš„ api æ–‡ä»¶ä¸€é”®ç”Ÿæˆ Go, iOS, Android, Kotlin, Dart, TypeScript, JavaScript ä»£ç ï¼Œå¹¶å¯ç›´æ¥è¿è¡Œã€‚</p>
<p>ä½¿ç”¨ go-zero çš„å¥½å¤„ï¼š</p>
<ul>
<li>è½»æ¾è·å¾—æ”¯æ’‘åƒä¸‡æ—¥æ´»æœåŠ¡çš„ç¨³å®šæ€§</li>
<li>å†…å»ºçº§è”è¶…æ—¶æ§åˆ¶ã€é™æµã€è‡ªé€‚åº”ç†”æ–­ã€è‡ªé€‚åº”é™è½½ç­‰å¾®æœåŠ¡æ²»ç†èƒ½åŠ›ï¼Œæ— éœ€é…ç½®å’Œé¢å¤–ä»£ç </li>
<li>å¾®æœåŠ¡æ²»ç†ä¸­é—´ä»¶å¯æ— ç¼é›†æˆåˆ°å…¶å®ƒç°æœ‰æ¡†æ¶ä½¿ç”¨</li>
<li>æç®€çš„ API æè¿°ï¼Œä¸€é”®ç”Ÿæˆå„ç«¯ä»£ç </li>
<li>è‡ªåŠ¨æ ¡éªŒå®¢æˆ·ç«¯è¯·æ±‚å‚æ•°åˆæ³•æ€§</li>
<li>å¤§é‡å¾®æœåŠ¡æ²»ç†å’Œå¹¶å‘å·¥å…·åŒ…</li>
</ul>
<h2 id="è®¡åˆ’">è®¡åˆ’</h2>
<p>go-zero æ˜¯ä¸€ä¸ªé›†å¤§æˆè€…ï¼Œä½†åˆä¸å¤±ä¼˜é›…çš„å¾®æœåŠ¡æ¡†æ¶ï¼Œæˆ‘è®¡åˆ’åœ¨ä¸šä½™æ—¶é—´ç ”ç©¶å®ƒçš„æºç ã€‚æˆ‘æŠŠæ„Ÿå…´è¶£çš„æ¨¡å—éƒ½å†™åœ¨äº†ä¸‹é¢çš„ TODO åˆ—è¡¨ï¼š</p>
<ul>
<li>Balancer&ndash;åŸºäº p2c è´Ÿè½½å‡è¡¡</li>
<li>Bloom å¸ƒéš†è¿‡æ»¤å™¨çš„å®ç°</li>
<li>go-zero çš„ç†”æ–­å™¨</li>
<li>go-zero çš„æœåŠ¡æ³¨å†Œä¸å‘ç°</li>
</ul>
]]></content>
		</item>
		
		<item>
			<title>gRPC Resolver åˆ†æ</title>
			<link>https://wangzeping722.github.io/posts/grpc-resolver/</link>
			<pubDate>Thu, 29 Oct 2020 09:56:05 +0800</pubDate>
			
			<guid>https://wangzeping722.github.io/posts/grpc-resolver/</guid>
			<description>1. å‰è¨€ gRPC Resolver æ˜¯ gRPC çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œä¸ gRPC Balancer ä¸€èµ·è´Ÿè´£ gRPC è°ƒç”¨å…¶å®ƒæœåŠ¡æ—¶çš„è´Ÿè½½å‡è¡¡ã€‚gRPC è´Ÿè½½å‡è¡¡æ˜¯é’ˆå¯¹æ¯æ¬¡è¯·æ±‚ï¼Œè€Œä¸æ˜¯è¿æ¥ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æœåŠ¡ç«¯è´Ÿè½½çš„</description>
			<content type="html"><![CDATA[<h2 id="1-å‰è¨€">1. å‰è¨€</h2>
<p>gRPC Resolver æ˜¯ gRPC çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œä¸ gRPC Balancer ä¸€èµ·è´Ÿè´£ gRPC è°ƒç”¨å…¶å®ƒæœåŠ¡æ—¶çš„è´Ÿè½½å‡è¡¡ã€‚gRPC è´Ÿè½½å‡è¡¡æ˜¯é’ˆå¯¹æ¯æ¬¡è¯·æ±‚ï¼Œè€Œä¸æ˜¯è¿æ¥ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æœåŠ¡ç«¯è´Ÿè½½çš„å‡è¡¡æ€§ï¼Œæ‰€æœ‰ gRPC è´Ÿè½½å‡è¡¡ç®—æ³•å®ç°éƒ½åœ¨å®¢æˆ·ç«¯ã€‚</p>
<h2 id="2-resolver">2. Resolver</h2>
<p>ä¸‹å›¾æ˜¯ gRPC å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡çš„æ¶æ„å›¾ï¼š</p>
<p><!-- raw HTML omitted --></p>
<p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼ŒResolver ä½äºå›¾ç‰‡çš„å·¦æ–¹ï¼ŒgRPC è´Ÿè½½ä¸ Resolver äº¤äº’ï¼š</p>
<ol>
<li>é¦–å…ˆä¼š Build ä¸€ä¸ª Resolver å®ä¾‹ï¼Œå¹¶ä¸” watch åç«¯æœåŠ¡åˆ—è¡¨çš„å˜åŒ–</li>
<li>å½“æœåŠ¡åˆ—è¡¨å‘ç”Ÿå˜åŒ–åï¼ŒResolver é€šè¿‡ gRPC é€šçŸ¥ Balancer</li>
</ol>
<h2 id="3-åŸºæœ¬æ¦‚å¿µ">3. åŸºæœ¬æ¦‚å¿µ</h2>
<p><code>ClientConn</code> å¯¹è±¡æ˜¯è¿æ¥ç®¡ç†çš„å…¥å£ï¼Œè¡¨ç¤ºåˆ°æœåŠ¡ç«¯çš„ä¸€ä¸ªé€»è¾‘çš„è¿æ¥ï¼Œä¼šåšåå­—è§£æã€è´Ÿè½½å‡è¡¡ã€KeepAlive ç­‰è¿æ¥ç®¡ç†æ–¹é¢çš„æ“ä½œï¼Œæ˜¯ä¸ªçº¿ç¨‹å®‰å…¨çš„å¯¹è±¡ã€‚</p>
<p>æ¯ä¸ª <code>ClientConn</code> å¯¹åº”æœ‰å¤šä¸ª <code>SubConn</code>ï¼Œ<code>ClientConn</code> ä¼šåŸºäºæœåŠ¡å‘ç°ï¼ˆresolverï¼‰å¾—åˆ°å¤šä¸ª SubConnï¼Œå¹¶åœ¨å¤šä¸ª <code>SubConn</code> ä¹‹é—´å®ç°è´Ÿè½½å‡è¡¡ï¼ˆbalancerï¼‰ã€‚</p>
<h2 id="4-æºç åˆ†æ">4. æºç åˆ†æ</h2>
<p>Resolver çš„ä»£ç ä¸»è¦é›†ä¸­åœ¨ resolver åŒ…ä¸­ï¼Œé‡Œé¢ä¸»è¦åŒ…å«äº†æœåŠ¡è§£æçš„æ¥å£å®šä¹‰ï¼Œæˆ‘ä»¬æ—¢å¯ä»¥è‡ªå·±é€šè¿‡å®ç° resolver ä¸­çš„æ¥å£æ¥è‡ªå®šä¹‰è‡ªå·±çš„ Resolverï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ gRPC å®ç°çš„ <a href="https://github.com/grpc/grpc-go/blob/master/internal/resolver/dns/dns_resolver.go">DNSResolver</a>ã€‚</p>
<h3 id="address">Address</h3>
<p>Address ç”¨æ¥ä»£è¡¨ä¸€ä¸ªå½“å‰å®¢æˆ·ç«¯å³å°†è¿æ¥åˆ°çš„æœåŠ¡ç«¯çš„åœ°å€ï¼Œä¸€ä¸ªæœåŠ¡ä¸€èˆ¬ä¼šæœ‰å¤šä¸ªåœ°å€ï¼Œæ‰€æœ‰æˆ‘ä»¬åœ¨ç›‘å¬çš„æ—¶å€™ä¸€èˆ¬ä¼šè·å–åˆ° Address çš„åˆ‡ç‰‡ã€‚å…¶ä¸­çš„ <code>Addr</code> å­—æ®µæ˜¯æœåŠ¡å™¨çš„åœ°å€, <code>Attributes</code>  å’Œ <code>Metadata</code> ç”¨æ¥å­˜å‚¨æœåŠ¡ç«¯çš„é¢å¤–çš„ä¿¡æ¯ï¼Œä¸€èˆ¬è¢«è´Ÿè½½å‡è¡¡å™¨ç”¨æ¥å†³å®š pick å“ªä¸€æ¡è¿æ¥ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Address represents a server the client connects to.
</span><span class="c1"></span><span class="c1">//
</span><span class="c1"></span><span class="c1">// Experimental
</span><span class="c1"></span><span class="c1">//
</span><span class="c1"></span><span class="c1">// Notice: This type is EXPERIMENTAL and may be changed or removed in a
</span><span class="c1"></span><span class="c1">// later release.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Address</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="c1">// Addr is the server address on which a connection will be established.
</span><span class="c1"></span>	<span class="nx">Addr</span> <span class="kt">string</span>

	<span class="c1">// ServerName is the name of this address.
</span><span class="c1"></span>	<span class="c1">// If non-empty, the ServerName is used as the transport certification authority for
</span><span class="c1"></span>	<span class="c1">// the address, instead of the hostname from the Dial target string. In most cases,
</span><span class="c1"></span>	<span class="c1">// this should not be set.
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// If Type is GRPCLB, ServerName should be the name of the remote load
</span><span class="c1"></span>	<span class="c1">// balancer, not the name of the backend.
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// WARNING: ServerName must only be populated with trusted values. It
</span><span class="c1"></span>	<span class="c1">// is insecure to populate it with data from untrusted inputs since untrusted
</span><span class="c1"></span>	<span class="c1">// values could be used to bypass the authority checks performed by TLS.
</span><span class="c1"></span>	<span class="nx">ServerName</span> <span class="kt">string</span>

	<span class="c1">// Attributes contains arbitrary data about this address intended for
</span><span class="c1"></span>	<span class="c1">// consumption by the load balancing policy.
</span><span class="c1"></span>	<span class="nx">Attributes</span> <span class="o">*</span><span class="nx">attributes</span><span class="p">.</span><span class="nx">Attributes</span>

	<span class="c1">// Type is the type of this address.
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// Deprecated: use Attributes instead.
</span><span class="c1"></span>	<span class="nx">Type</span> <span class="nx">AddressType</span>

	<span class="c1">// Metadata is the information associated with Addr, which may be used
</span><span class="c1"></span>	<span class="c1">// to make load balancing decision.
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// Deprecated: use Attributes instead.
</span><span class="c1"></span>	<span class="nx">Metadata</span> <span class="kd">interface</span><span class="p">{</span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div><h3 id="clientconn">ClientConn</h3>
<p>ClientConn ä¸º resolver æä¾›äº†é€šçŸ¥ ClientConn æ›´æ–°æœåŠ¡ç«¯åˆ—è¡¨çš„å›è°ƒæ–¹æ³•ã€‚è¿™ä¸ªæ¥å£ä¸æ¨èç”¨æˆ·è‡ªå·±å®ç°ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// ClientConn contains the callbacks for resolver to notify any updates
</span><span class="c1"></span><span class="c1">// to the gRPC ClientConn.
</span><span class="c1"></span><span class="c1">//
</span><span class="c1"></span><span class="c1">// This interface is to be implemented by gRPC. Users should not need a
</span><span class="c1"></span><span class="c1">// brand new implementation of this interface. For the situations like
</span><span class="c1"></span><span class="c1">// testing, the new implementation should embed this interface. This allows
</span><span class="c1"></span><span class="c1">// gRPC to add new methods to this interface.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ClientConn</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// UpdateState updates the state of the ClientConn appropriately.
</span><span class="c1"></span>	<span class="nf">UpdateState</span><span class="p">(</span><span class="nx">State</span><span class="p">)</span>
	<span class="c1">// ReportError notifies the ClientConn that the Resolver encountered an
</span><span class="c1"></span>	<span class="c1">// error.  The ClientConn will notify the load balancer and begin calling
</span><span class="c1"></span>	<span class="c1">// ResolveNow on the Resolver with exponential backoff.
</span><span class="c1"></span>	<span class="nf">ReportError</span><span class="p">(</span><span class="kt">error</span><span class="p">)</span>
	<span class="c1">// NewAddress is called by resolver to notify ClientConn a new list
</span><span class="c1"></span>	<span class="c1">// of resolved addresses.
</span><span class="c1"></span>	<span class="c1">// The address list should be the complete list of resolved addresses.
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// Deprecated: Use UpdateState instead.
</span><span class="c1"></span>	<span class="nf">NewAddress</span><span class="p">(</span><span class="nx">addresses</span> <span class="p">[</span><span class="p">]</span><span class="nx">Address</span><span class="p">)</span>
	<span class="c1">// NewServiceConfig is called by resolver to notify ClientConn a new
</span><span class="c1"></span>	<span class="c1">// service config. The service config should be provided as a json string.
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// Deprecated: Use UpdateState instead.
</span><span class="c1"></span>	<span class="nf">NewServiceConfig</span><span class="p">(</span><span class="nx">serviceConfig</span> <span class="kt">string</span><span class="p">)</span>
	<span class="c1">// ParseServiceConfig parses the provided service config and returns an
</span><span class="c1"></span>	<span class="c1">// object that provides the parsed config.
</span><span class="c1"></span>	<span class="nf">ParseServiceConfig</span><span class="p">(</span><span class="nx">serviceConfigJSON</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="nx">serviceconfig</span><span class="p">.</span><span class="nx">ParseResult</span>
<span class="p">}</span>
</code></pre></div><p>ä¸€èˆ¬æˆ‘ä»¬çš„ Resolver ä¸­éƒ½ä¼šç”¨ä¸€ä¸ªæˆå‘˜å˜é‡æ¥å­˜å‚¨ ClientConnï¼Œç„¶åå†éœ€è¦æ›´æ–°æœåŠ¡ç«¯åœ°å€çš„æ—¶å€™è°ƒç”¨ <code>UpdateState</code>ã€‚ä¾‹å¦‚ dnsResolver ä¸­å­˜å‚¨äº† <code>cc</code>ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">dnsResolver</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="o">...</span>
	<span class="nx">cc</span>       <span class="nx">resolver</span><span class="p">.</span><span class="nx">ClientConn</span>
	<span class="o">...</span>
<span class="p">}</span>
</code></pre></div><h3 id="target">Target</h3>
<p>Target æ˜¯ä¸€ä¸ªå­˜å‚¨æ³¨å†Œä¸­å¿ƒä¿¡æ¯å’Œåç«¯æœåŠ¡ä¿¡æ¯çš„ç»“æ„ä½“, å¹¶ä¸”é€šè¿‡ Scheme æŒ‡å®šäº† gRPC ä½¿ç”¨çš„è§£æå™¨çš„åç§°ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Target represents a target for gRPC, as specified in:
</span><span class="c1"></span><span class="c1">// https://github.com/grpc/grpc/blob/master/doc/naming.md.
</span><span class="c1"></span><span class="c1">// It is parsed from the target string that gets passed into Dial or DialContext by the user. And
</span><span class="c1"></span><span class="c1">// grpc passes it to the resolver and the balancer.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Target</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Scheme</span>    <span class="kt">string</span>	<span class="c1">// æ³¨å†Œåœ¨ gRPC ä¸­çš„åç§°
</span><span class="c1"></span>	<span class="nx">Authority</span> <span class="kt">string</span>	<span class="c1">// æœåŠ¡å‘ç°çš„æƒå¨æœåŠ¡å™¨
</span><span class="c1"></span>	<span class="nx">Endpoint</span>  <span class="kt">string</span>	<span class="c1">// ä¸€èˆ¬æ˜¯æœåŠ¡åæˆ–è€…HOST
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div><p>ä¾‹å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ª Target æ˜¯ <code>dns://some_authority/foo.bar</code>ï¼Œ é‚£ä¹ˆå¯¹åº”çš„è¢«è§£æå‡ºæ¥å°±åº”è¯¥æ˜¯</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">Scheme</span> <span class="p">=</span> <span class="nx">dns</span>
<span class="nx">Authority</span> <span class="p">=</span> <span class="nx">some_authority</span>
<span class="nx">Endpoint</span> <span class="p">=</span> <span class="nx">foo</span><span class="p">.</span><span class="nx">bar</span>
</code></pre></div><h3 id="builder">Builder</h3>
<p>Builder æ¥å£ä¸ºæˆ‘ä»¬æä¾›äº†åˆ›å»º Resolver çš„ Build æ–¹æ³•ï¼Œå¹¶ä¸”æŒç»­ç›‘å¬æœåŠ¡ç«¯åœ°å€çš„å˜åŒ–ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Builder creates a resolver that will be used to watch name resolution updates.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Builder</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// Build creates a new resolver for the given target.
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// gRPC dial calls Build synchronously, and fails if the returned error is
</span><span class="c1"></span>	<span class="c1">// not nil.
</span><span class="c1"></span>	<span class="nf">Build</span><span class="p">(</span><span class="nx">target</span> <span class="nx">Target</span><span class="p">,</span> <span class="nx">cc</span> <span class="nx">ClientConn</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">BuildOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">Resolver</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
	<span class="c1">// Scheme returns the scheme supported by this resolver.
</span><span class="c1"></span>	<span class="c1">// Scheme is defined at https://github.com/grpc/grpc/blob/master/doc/naming.md.
</span><span class="c1"></span>	<span class="nf">Scheme</span><span class="p">(</span><span class="p">)</span> <span class="kt">string</span>
<span class="p">}</span>
</code></pre></div><p>ä»æ³¨é‡Šä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç†è§£åˆ°ï¼šå½“å‘ gRPC æ³¨å†Œè§£æå™¨çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ³¨å†Œçš„æ˜¯ Builderï¼Œé€šè¿‡ Build æ–¹æ³•æ¥åˆ›å»º Resolverï¼Œå¹¶ä¸”ä¸€èˆ¬ä¼šåœ¨ Build æ–¹æ³•ä¸­å¼€å¯ goroutine æ¥ watch æœåŠ¡ç«¯çš„å˜åŒ–ã€‚</p>
<p>Build æ–¹æ³•çš„å‚æ•°å°±åŒ…å«äº†ä¸ŠèŠ‚æåˆ°çš„ <code>cc ClientConn</code>ï¼Œç„¶åå¦‚ä¸Šæ–‡è¯´çš„ï¼ŒæŠŠ cc å­˜å‚¨åˆ° Resolver ä¸­ï¼Œåœ¨è§‚å¯Ÿåˆ°æœåŠ¡åœ°å€å‘ç”Ÿå˜åŒ–çš„æ—¶å€™</p>
<p>é€šè¿‡ <code>cc.UpdateState(resolver.State{Addresses: addr})</code> æ¥é€šçŸ¥ ClientConn æœåŠ¡å™¨åˆ—è¡¨å‘ç”Ÿå˜åŒ–ã€‚</p>
<h3 id="resolver">Resolver</h3>
<p>Resolver è¢« Builder åˆ›å»ºå‡ºæ¥ï¼Œå®ç°äº†ç›‘å¬æœåŠ¡åæ˜ å°„åˆ°çš„åœ°å€å˜åŒ–çš„é€»è¾‘ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Resolver watches for the updates on the specified target.
</span><span class="c1"></span><span class="c1">// Updates include address updates and service config updates.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Resolver</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// ResolveNow will be called by gRPC to try to resolve the target name
</span><span class="c1"></span>	<span class="c1">// again. It&#39;s just a hint, resolver can ignore this if it&#39;s not necessary.
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// It could be called multiple times concurrently.
</span><span class="c1"></span>	<span class="nf">ResolveNow</span><span class="p">(</span><span class="nx">ResolveNowOptions</span><span class="p">)</span>
	<span class="c1">// Close closes the resolver.
</span><span class="c1"></span>	<span class="nf">Close</span><span class="p">(</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><h3 id="å°ç»“">å°ç»“</h3>
<p>resolver åŒ…çš„ä½¿ç”¨æµç¨‹æ˜¯ï¼Œé€šè¿‡ Builder æ¥å£æ¥åˆ›å»º Resolverï¼Œæˆ‘ä»¬å¯ä»¥å† Resolver ä¸­å®ç°è‡ªå·±æœåŠ¡å‘ç°çš„é€»è¾‘ï¼Œå¹¶ä¸”æ›´æ–°åˆ° ClientConn ä¸­ã€‚</p>
<h2 id="5-resolver-åº”ç”¨">5. Resolver åº”ç”¨</h2>
<p>ä¸‹é¢æˆ‘ä»¬å†™ä¸€ä¸ªå®Œæ•´çš„ä¾‹å­ï¼Œç”¨æ¥åˆ†æ Resolver çš„å·¥ä½œæµç¨‹ï¼Œæˆ‘ä»¬ç¨‹åºçš„ç›®çš„å°±æ˜¯å®¢æˆ·ç«¯é€šè¿‡ rpc è°ƒç”¨æœåŠ¡å™¨çš„æ¥å£å¹¶æ‰“å°å‡ºç»“æœã€‚ä¸ºäº†å‡å°‘ç¯‡å¹…ï¼Œæˆ‘å°±ä¸è´´å‡ºæ‰€æœ‰çš„ä»£ç ï¼Œå®Œæ•´çš„ä»£ç å¯ä»¥åœ¨æˆ‘çš„ <a href="https://github.com/wangzeping722/gRPC-resolver-demo">github</a> è·å–ã€‚</p>
<h3 id="servermaingo">server/main.go</h3>
<p>é€šè¿‡ NewGreeterService å‘ etcd æ³¨å†Œäº†æœåŠ¡çš„åœ°å€ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">g</span> <span class="o">*</span><span class="nx">greeterService</span><span class="p">)</span> <span class="nf">Register</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">target</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s&#34;</span><span class="p">,</span> <span class="nx">serviceName</span><span class="p">)</span>
	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>

	<span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">g</span><span class="p">.</span><span class="nx">cli</span><span class="p">.</span><span class="nf">Put</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="s">&#34;127.0.0.1:8000&#34;</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>ç„¶åï¼Œç›‘å¬åœ¨ 8000 è¿™ä¸ªç«¯å£ä¸Šï¼Œç­‰å¾…æä¾›æœåŠ¡ã€‚</p>
<h3 id="clientmaingo">client/main.go</h3>
<p>ç”±äºæœ¬æ–‡çš„é‡å¿ƒåœ¨äºåˆ†æ Resolverï¼Œé‚£ä¹ˆ client çš„ä»£ç å®ç°æ‰æ˜¯æˆ‘ä»¬éœ€è¦è¯¦ç»†è§£æçš„ã€‚ä¸ºäº†èƒ½å¤Ÿä» etcd è·å–æˆ‘ä»¬åç«¯æœåŠ¡çš„åœ°å€ï¼Œå¹¶ä¸” gRPC åªæä¾›äº† dnsResolverï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¦å®ç°è‡ªå·±è‡ªå®šä¹‰çš„ Resolverï¼Œè¿™é‡Œæˆ‘ä»¬åªå®ç°äº†ä¸€ä¸ªåŠŸèƒ½éå¸¸ç®€å•ï¼Œå¹¶ä¸”æ²¡æœ‰ watchï¼ˆå³æŒç»­çš„æœåŠ¡å‘ç°ï¼‰çš„ Resolverï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">type</span> <span class="nx">exampleResolver</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">target</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">Target</span>
	<span class="nx">cc</span>     <span class="nx">resolver</span><span class="p">.</span><span class="nx">ClientConn</span>
	<span class="nx">cli</span>    <span class="o">*</span><span class="nx">clientv3</span><span class="p">.</span><span class="nx">Client</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">exampleResolver</span><span class="p">)</span> <span class="nf">ResolveNow</span><span class="p">(</span><span class="nx">_</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">ResolveNowOptions</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;ResolverNow&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">exampleResolver</span><span class="p">)</span> <span class="nf">Close</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Close&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">e</span> <span class="o">*</span><span class="nx">exampleResolver</span><span class="p">)</span> <span class="nf">resolve</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">once</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">clientConfig</span> <span class="o">:=</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
			<span class="nx">Endpoints</span><span class="p">:</span>   <span class="p">[</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">Authority</span><span class="p">}</span><span class="p">,</span>
			<span class="nx">DialTimeout</span><span class="p">:</span> <span class="mi">120</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
		<span class="p">}</span>
		<span class="nx">cli</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">clientConfig</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
		<span class="nx">e</span><span class="p">.</span><span class="nx">cli</span> <span class="p">=</span> <span class="nx">cli</span>
	<span class="p">}</span><span class="p">)</span>
	<span class="nx">addList</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="p">[</span><span class="p">]</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
  <span class="c1">// è·å–æœåŠ¡å¯¹åº”çš„æ‰€æœ‰çš„åç«¯åœ°å€ï¼Œå¹¶ä¸”æ·»åŠ åˆ° addList
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">result</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">e</span><span class="p">.</span><span class="nx">cli</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">Endpoint</span><span class="p">,</span> <span class="nx">clientv3</span><span class="p">.</span><span class="nf">WithPrefix</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">;</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">kvs</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">result</span><span class="p">.</span><span class="nx">Kvs</span> <span class="p">{</span>
			<span class="nx">addList</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">addList</span><span class="p">,</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">Address</span><span class="p">{</span>
				<span class="nx">Addr</span><span class="p">:</span> <span class="nb">string</span><span class="p">(</span><span class="nx">kvs</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span><span class="p">,</span>
			<span class="p">}</span><span class="p">)</span>
			<span class="nx">fmt</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;resolved addr: %s\n&#34;</span><span class="p">,</span> <span class="nb">string</span><span class="p">(</span><span class="nx">kvs</span><span class="p">.</span><span class="nx">Value</span><span class="p">)</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="nx">e</span><span class="p">.</span><span class="nx">cc</span><span class="p">.</span><span class="nf">UpdateState</span><span class="p">(</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">State</span><span class="p">{</span><span class="nx">Addresses</span><span class="p">:</span> <span class="nx">addList</span><span class="p">}</span><span class="p">)</span>
<span class="p">}</span>

</code></pre></div><p>å®ç° exampleResolverï¼Œ å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åœ¨ resolver æ–¹æ³•ä¸­å®ç°äº†æœåŠ¡å‘ç°çš„ä»£ç ï¼Œè·å¾—äº†æœåŠ¡å¯¹åº”çš„åç«¯åœ°å€ï¼Œç„¶åé€šè¿‡ <code>cc.UpdateState(resolver.State{Addresses: addList})</code> æ›´æ–°ï¼ˆæ·»åŠ ã€åˆ é™¤ï¼‰æœ¬åœ°çš„åç«¯æœåŠ¡å™¨åˆ—è¡¨ã€‚</p>
<p>åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å®ç°ä¸€ä¸ª Builderï¼Œç”¨æ¥åˆ›å»º Resolver å®ä¾‹ï¼ŒåŒæ—¶æˆ‘ä»¬è¿˜éœ€è¦æŠŠ Builder æ³¨å†Œåˆ° gRPC ä¸­ï¼Œé€šè¿‡ <code>Scheme</code> æ¥æ ‡è¯†æˆ‘ä»¬è‡ªå®šä¹‰çš„ Resolverï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">init</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">resolver</span><span class="p">.</span><span class="nf">Register</span><span class="p">(</span><span class="nf">newBuilder</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">exampleBuilder</span> <span class="kd">struct</span> <span class="p">{</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">newBuilder</span><span class="p">(</span><span class="p">)</span> <span class="o">*</span><span class="nx">exampleBuilder</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">exampleBuilder</span><span class="p">{</span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">exampleBuilder</span><span class="p">)</span> <span class="nf">Build</span><span class="p">(</span><span class="nx">target</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">Target</span><span class="p">,</span> <span class="nx">cc</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">ClientConn</span><span class="p">,</span> <span class="nx">opts</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">BuildOptions</span><span class="p">)</span> <span class="p">(</span><span class="nx">resolver</span><span class="p">.</span><span class="nx">Resolver</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">r</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">exampleResolver</span><span class="p">{</span><span class="nx">cc</span><span class="p">:</span> <span class="nx">cc</span><span class="p">,</span> <span class="nx">target</span><span class="p">:</span> <span class="nx">target</span><span class="p">}</span>
	<span class="nx">r</span><span class="p">.</span><span class="nf">resolve</span><span class="p">(</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">r</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">b</span> <span class="o">*</span><span class="nx">exampleBuilder</span><span class="p">)</span> <span class="nf">Scheme</span><span class="p">(</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">scheme</span>
<span class="p">}</span>
</code></pre></div><p>å†æ¥çœ‹çœ‹ main å‡½æ•°åšäº†ä»€ä¹ˆå·¥ä½œï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">target</span> <span class="o">:=</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Sprintf</span><span class="p">(</span><span class="s">&#34;%s://%s/%s&#34;</span><span class="p">,</span> <span class="nx">scheme</span><span class="p">,</span> <span class="s">&#34;127.0.0.1:2379&#34;</span><span class="p">,</span> <span class="nx">serviceName</span><span class="p">)</span>
	<span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>
	<span class="k">defer</span> <span class="nf">cancel</span><span class="p">(</span><span class="p">)</span>
	<span class="nx">clientConn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">DialContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">target</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">WithInsecure</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>

  <span class="c1">// è°ƒç”¨è¿œç¨‹æœåŠ¡
</span><span class="c1"></span>	<span class="nx">reply</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">hello</span><span class="p">.</span><span class="nf">NewGreeterClient</span><span class="p">(</span><span class="nx">clientConn</span><span class="p">)</span><span class="p">.</span><span class="nf">SayHello</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">hello</span><span class="p">.</span><span class="nx">HelloRequest</span><span class="p">{</span>
		<span class="nx">Name</span><span class="p">:</span> <span class="s">&#34;wero&#34;</span><span class="p">,</span>
	<span class="p">}</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">fmt</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;get reply:&#34;</span><span class="p">,</span> <span class="nx">reply</span><span class="p">.</span><span class="nx">Message</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>é¦–å…ˆï¼Œæˆ‘ä»¬é€šè¿‡ <code>target</code> æŒ‡å‡ºéœ€è¦è°ƒç”¨çš„è¿œç¨‹æœåŠ¡ï¼Œç„¶åè°ƒç”¨  <code>grpc.DialContext</code>ï¼ŒgRPC ä¾¿å¯ä»¥è‡ªåŠ¨å‘ç°æœåŠ¡çš„åœ°å€äº†ï¼Œå¹¶åœ¨æˆ‘ä»¬è°ƒç”¨è¿œç¨‹æœåŠ¡çš„æ—¶å€™å®ç°äº†è´Ÿè½½å‡è¡¡ã€‚ä¸è¿‡æˆ‘ä»¬ä¸ä»…è¦çŸ¥å…¶ç„¶ï¼Œæ›´è¦çŸ¥å…¶æ‰€ä»¥ç„¶ã€‚</p>
<h3 id="dialcontext-æµç¨‹åˆ†æ">DialContext æµç¨‹åˆ†æ</h3>
<p>æœ€é‡è¦çš„ä¾¿æ˜¯ DialContext è¿™ä¸ªå‡½æ•°äº†ï¼Œé‚£æˆ‘ä»¬ä¾¿ä»è¿™ä¸ªå‡½æ•°å…¥æ‰‹ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">DialContext</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">target</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">opts</span> <span class="o">...</span><span class="nx">DialOption</span><span class="p">)</span> <span class="p">(</span><span class="nx">conn</span> <span class="o">*</span><span class="nx">ClientConn</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">cc</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">ClientConn</span><span class="p">{</span>
		<span class="nx">target</span><span class="p">:</span>            <span class="nx">target</span><span class="p">,</span>
		<span class="nx">csMgr</span><span class="p">:</span>             <span class="o">&amp;</span><span class="nx">connectivityStateManager</span><span class="p">{</span><span class="p">}</span><span class="p">,</span>
		<span class="nx">conns</span><span class="p">:</span>             <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="o">*</span><span class="nx">addrConn</span><span class="p">]</span><span class="kd">struct</span><span class="p">{</span><span class="p">}</span><span class="p">)</span><span class="p">,</span>	<span class="c1">// å­˜å‚¨è¿æ¥çš„ map
</span><span class="c1"></span>		<span class="nx">dopts</span><span class="p">:</span>             <span class="nf">defaultDialOptions</span><span class="p">(</span><span class="p">)</span><span class="p">,</span>
		<span class="nx">blockingpicker</span><span class="p">:</span>    <span class="nf">newPickerWrapper</span><span class="p">(</span><span class="p">)</span><span class="p">,</span>				<span class="c1">// è´Ÿè½½å‡è¡¡çš„é€‰æ‹©å™¨
</span><span class="c1"></span>		<span class="nx">czData</span><span class="p">:</span>            <span class="nb">new</span><span class="p">(</span><span class="nx">channelzData</span><span class="p">)</span><span class="p">,</span>
		<span class="nx">firstResolveEvent</span><span class="p">:</span> <span class="nx">grpcsync</span><span class="p">.</span><span class="nf">NewEvent</span><span class="p">(</span><span class="p">)</span><span class="p">,</span>
	<span class="p">}</span>
  
	<span class="o">...</span>
	<span class="c1">// åˆå§‹åŒ–æ‹¦æˆªå™¨
</span><span class="c1"></span>	<span class="nf">chainUnaryClientInterceptors</span><span class="p">(</span><span class="nx">cc</span><span class="p">)</span>
	<span class="nf">chainStreamClientInterceptors</span><span class="p">(</span><span class="nx">cc</span><span class="p">)</span>
	
  <span class="o">...</span>
  
	<span class="c1">// Determine the resolver to use.
</span><span class="c1"></span>	<span class="c1">// æ ¹æ® target ä¸Šé¢ç½®é¡¶çš„ scheme æŒ‡å®šéœ€è¦ä½¿ç”¨çš„ resolver
</span><span class="c1"></span>	<span class="nx">cc</span><span class="p">.</span><span class="nx">parsedTarget</span> <span class="p">=</span> <span class="nx">grpcutil</span><span class="p">.</span><span class="nf">ParseTarget</span><span class="p">(</span><span class="nx">cc</span><span class="p">.</span><span class="nx">target</span><span class="p">)</span>
	<span class="nx">unixScheme</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nf">HasPrefix</span><span class="p">(</span><span class="nx">cc</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span> <span class="s">&#34;unix:&#34;</span><span class="p">)</span>
	<span class="nx">channelz</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="nx">logger</span><span class="p">,</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">channelzID</span><span class="p">,</span> <span class="s">&#34;parsed scheme: %q&#34;</span><span class="p">,</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">parsedTarget</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">)</span>
	<span class="c1">// NameResolver æ ¸å¿ƒé€»è¾‘, åˆå§‹åŒ– resolverBuilder, å¦‚æœä¼ å…¥çš„ scheme æ‰¾ä¸åˆ°å¯¹åº”çš„ resolverBuilder, å°±ä½¿ç”¨é»˜è®¤çš„
</span><span class="c1"></span>	<span class="nx">resolverBuilder</span> <span class="o">:=</span> <span class="nx">cc</span><span class="p">.</span><span class="nf">getResolver</span><span class="p">(</span><span class="nx">cc</span><span class="p">.</span><span class="nx">parsedTarget</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">resolverBuilder</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="c1">// If resolver builder is still nil, the parsed target&#39;s scheme is
</span><span class="c1"></span>		<span class="c1">// not registered. Fallback to default resolver and set Endpoint to
</span><span class="c1"></span>		<span class="c1">// the original target.
</span><span class="c1"></span>		<span class="nx">channelz</span><span class="p">.</span><span class="nf">Infof</span><span class="p">(</span><span class="nx">logger</span><span class="p">,</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">channelzID</span><span class="p">,</span> <span class="s">&#34;scheme %q not registered, fallback to default scheme&#34;</span><span class="p">,</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">parsedTarget</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">)</span>
		<span class="nx">cc</span><span class="p">.</span><span class="nx">parsedTarget</span> <span class="p">=</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">Target</span><span class="p">{</span>
			<span class="nx">Scheme</span><span class="p">:</span>   <span class="nx">resolver</span><span class="p">.</span><span class="nf">GetDefaultScheme</span><span class="p">(</span><span class="p">)</span><span class="p">,</span>
			<span class="nx">Endpoint</span><span class="p">:</span> <span class="nx">target</span><span class="p">,</span>
		<span class="p">}</span>
		<span class="nx">resolverBuilder</span> <span class="p">=</span> <span class="nx">cc</span><span class="p">.</span><span class="nf">getResolver</span><span class="p">(</span><span class="nx">cc</span><span class="p">.</span><span class="nx">parsedTarget</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">resolverBuilder</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;could not get resolver for default scheme: %q&#34;</span><span class="p">,</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">parsedTarget</span><span class="p">.</span><span class="nx">Scheme</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>
  
	<span class="o">...</span>
  
	<span class="nx">cc</span><span class="p">.</span><span class="nx">balancerBuildOpts</span> <span class="p">=</span> <span class="nx">balancer</span><span class="p">.</span><span class="nx">BuildOptions</span><span class="p">{</span>
		<span class="nx">DialCreds</span><span class="p">:</span>        <span class="nx">credsClone</span><span class="p">,</span>
		<span class="nx">CredsBundle</span><span class="p">:</span>      <span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">copts</span><span class="p">.</span><span class="nx">CredsBundle</span><span class="p">,</span>
		<span class="nx">Dialer</span><span class="p">:</span>           <span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">copts</span><span class="p">.</span><span class="nx">Dialer</span><span class="p">,</span>
		<span class="nx">ChannelzParentID</span><span class="p">:</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">channelzID</span><span class="p">,</span>
		<span class="nx">Target</span><span class="p">:</span>           <span class="nx">cc</span><span class="p">.</span><span class="nx">parsedTarget</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="c1">// Build the resolver.
</span><span class="c1"></span>	<span class="c1">// ä½¿ç”¨ä¸Šé¢åˆå§‹åŒ–çš„ resolverBuilder æ„å»º resolver
</span><span class="c1"></span>	<span class="nx">rWrapper</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">newCCResolverWrapper</span><span class="p">(</span><span class="nx">cc</span><span class="p">,</span> <span class="nx">resolverBuilder</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;failed to build resolver: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">cc</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">(</span><span class="p">)</span>
	<span class="nx">cc</span><span class="p">.</span><span class="nx">resolverWrapper</span> <span class="p">=</span> <span class="nx">rWrapper</span>
	<span class="nx">cc</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">(</span><span class="p">)</span>
  
	<span class="o">...</span>
  
	<span class="k">return</span> <span class="nx">cc</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>ä»£ç ä¸­çœç•¥äº†ä¸€éƒ¨åˆ†ç›®å‰ä¸å…³æ³¨çš„å†…å®¹ï¼Œå¯ä»¥çœ‹è§çš„æ˜¯ï¼Œæˆ‘ä»¬éœ€è¦å…ˆé€šè¿‡ <code>target</code> æŒ‡å®šçš„ <code>scheme</code> æ¥è·å– resolverBuilderï¼Œ ç„¶åå†é€šè¿‡ builder æ¥æ„å»ºå‡º resolver å®ä¾‹ã€‚åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ <code>scheme = test</code> ï¼Œå…¶å¯¹åº”çš„ builder å°±æ˜¯ä¸Šé¢çš„ <code>exampleBuilder</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="p">(</span><span class="nx">cc</span> <span class="o">*</span><span class="nx">ClientConn</span><span class="p">)</span> <span class="nf">getResolver</span><span class="p">(</span><span class="nx">scheme</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">Builder</span> <span class="p">{</span>
	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">rb</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">resolvers</span> <span class="p">{</span>
		<span class="k">if</span> <span class="nx">scheme</span> <span class="o">==</span> <span class="nx">rb</span><span class="p">.</span><span class="nf">Scheme</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">rb</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">resolver</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="nx">scheme</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>åœ¨è·å–åˆ° builder ä¹‹åï¼Œç´§æ¥ç€å°±éœ€è¦æ„å»ºå‡ºç”¨äºæœåŠ¡å‘ç°çš„ <code>Resolver</code>ï¼Œæˆ‘ä»¬æ¥å¾€ä¸‹çœ‹ï¼Œå‘ç° <code>newCCResolverWrapper(cc, resolverBuilder)</code> ä¼šæŠŠè·å–åˆ°çš„ builder ä¼ å…¥å‡½æ•°ä¸­ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">newCCResolverWrapper</span><span class="p">(</span><span class="nx">cc</span> <span class="o">*</span><span class="nx">ClientConn</span><span class="p">,</span> <span class="nx">rb</span> <span class="nx">resolver</span><span class="p">.</span><span class="nx">Builder</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">ccResolverWrapper</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">ccr</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">ccResolverWrapper</span><span class="p">{</span>
		<span class="nx">cc</span><span class="p">:</span>   <span class="nx">cc</span><span class="p">,</span>
		<span class="nx">done</span><span class="p">:</span> <span class="nx">grpcsync</span><span class="p">.</span><span class="nf">NewEvent</span><span class="p">(</span><span class="p">)</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="o">...</span>
	<span class="nx">rbo</span> <span class="o">:=</span> <span class="nx">resolve</span> <span class="nx">r</span><span class="p">.</span><span class="nx">BuildOptions</span><span class="p">{</span>
		<span class="nx">DisableServiceConfig</span><span class="p">:</span> <span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">disableServiceConfig</span><span class="p">,</span>
		<span class="nx">DialCreds</span><span class="p">:</span>            <span class="nx">credsClone</span><span class="p">,</span>
		<span class="nx">CredsBundle</span><span class="p">:</span>          <span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">copts</span><span class="p">.</span><span class="nx">CredsBundle</span><span class="p">,</span>
		<span class="nx">Dialer</span><span class="p">:</span>               <span class="nx">cc</span><span class="p">.</span><span class="nx">dopts</span><span class="p">.</span><span class="nx">copts</span><span class="p">.</span><span class="nx">Dialer</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
	<span class="c1">// We need to hold the lock here while we assign to the ccr.resolver field
</span><span class="c1"></span>	<span class="c1">// to guard against a data race caused by the following code path,
</span><span class="c1"></span>	<span class="c1">// rb.Build--&gt;ccr.ReportError--&gt;ccr.poll--&gt;ccr.resolveNow, would end up
</span><span class="c1"></span>	<span class="c1">// accessing ccr.resolver which is being assigned here.
</span><span class="c1"></span>	<span class="nx">ccr</span><span class="p">.</span><span class="nx">resolverMu</span><span class="p">.</span><span class="nf">Lock</span><span class="p">(</span><span class="p">)</span>
	<span class="k">defer</span> <span class="nx">ccr</span><span class="p">.</span><span class="nx">resolverMu</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">(</span><span class="p">)</span>
	<span class="nx">ccr</span><span class="p">.</span><span class="nx">resolver</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">rb</span><span class="p">.</span><span class="nf">Build</span><span class="p">(</span><span class="nx">cc</span><span class="p">.</span><span class="nx">parsedTarget</span><span class="p">,</span> <span class="nx">ccr</span><span class="p">,</span> <span class="nx">rbo</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">ccr</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>æœç„¶ï¼Œè¿™ä¸ªå‡½æ•°ä¼šè°ƒç”¨ä¼ å…¥çš„ Builderï¼Œè€Œè¿™ä¸ª Builder æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…·ä½“çš„å®ç°æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„ <code>exampleBuilder</code>ï¼Œåœ¨ Build æ–¹æ³•é‡Œé¢ï¼Œæˆ‘ä»¬ä¸€èˆ¬ä¼šå¼€å¯ä¸€ä¸ªåç¨‹æŒç»­çš„è·å–åç«¯æœåŠ¡å™¨åˆ—è¡¨çš„çŠ¶æ€ï¼Œå¹¶é€šè¿‡ <code>	UpdateState(State)</code> ï¼Œæ¥æ›´æ–°åˆ° ClientConn ä¸­ï¼ˆä¸è¿‡ï¼Œåœ¨æˆ‘è¿™ä¸ªå»ºè®®çš„å®ç°ä¸­ï¼Œå¹¶æ²¡æœ‰å¼€å¯åç¨‹æ¥å¤„ç†æœåŠ¡å‘ç°ï¼Œè€Œæ˜¯ä¸€æ¬¡æ€§çš„è·å–ï¼Œå‡è®¾åç«¯æœåŠ¡æ°¸è¿œä¸å‡ºæ•…éšœï¼‰ã€‚</p>
<h3 id="æ€»ç»“">æ€»ç»“</h3>
<p>åˆ°è¿™é‡Œï¼Œå¯¹ Resolver çš„åˆ†æåŸºæœ¬å®Œæˆï¼Œä¸‹ä¸€ç¯‡æ–‡ç« ä¼šåˆ†æ gRPC Balancerã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>DNSå­¦ä¹ æ€»ç»“</title>
			<link>https://wangzeping722.github.io/posts/dns-recording/</link>
			<pubDate>Mon, 23 Dec 2019 10:36:05 +0800</pubDate>
			
			<guid>https://wangzeping722.github.io/posts/dns-recording/</guid>
			<description>DNS æœ‰å¤šç§è®°å½•ç±»å‹ï¼Œæ¯ç§è®°å½•éƒ½æœ‰ä¸åŒçš„ä½œç”¨ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦æ€»ç»“äº†å¸¸ç”¨çš„è®°å½•ã€‚ A Aï¼ˆAddressï¼‰è®°å½•ç”¨æ¥æŒ‡å®šä¸»æœºåï¼ˆåŸŸåï¼‰å¯¹åº”çš„ IPv4 åœ°å€è®°å½•ã€‚æ¯”</description>
			<content type="html"><![CDATA[<p>DNS æœ‰å¤šç§è®°å½•ç±»å‹ï¼Œæ¯ç§è®°å½•éƒ½æœ‰ä¸åŒçš„ä½œç”¨ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦æ€»ç»“äº†å¸¸ç”¨çš„è®°å½•ã€‚</p>
<h4 id="a">A</h4>
<p>Aï¼ˆAddressï¼‰è®°å½•ç”¨æ¥æŒ‡å®šä¸»æœºåï¼ˆåŸŸåï¼‰å¯¹åº”çš„ IPv4 åœ°å€è®°å½•ã€‚æ¯”å¦‚ï¼Œå½“ä½ æµè§ˆä¸€ä¸ªç½‘é¡µæ—¶å€™ä¼šï¼Œæµè§ˆå™¨å°±ä¼šå…ˆå»æŸ¥æ‰¾å¯¹åº”åŸŸåçš„ A è®°å½•ï¼Œæ¥è·å– IP åœ°å€ï¼Œè·å¾—äº† IP åœ°å€ï¼Œæ‰èƒ½ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥ã€‚</p>
<blockquote>
<p>æˆ‘ä»¬å¯ä»¥ä¸ºåŒä¸€ä¸ªåŸŸåæ·»åŠ å¤šä¸ª A è®°å½•ï¼Œè§£æçš„æ—¶å€™ï¼Œä¼šå¾—åˆ°å¤šä¸ª IPï¼Œä¼šéšæœºé€‰æ‹©ä¸€ä¸ªä½¿ç”¨ã€‚</p>
</blockquote>
<p><em>åŸŸåä¸åŒºåˆ†å¤§å°å†™ã€‚è®°å½•çš„åç§°åº”è¯¥æ˜¯ç”± ASCII ç å­—æ¯ã€æ•°å­—å’Œ - ç»„æˆã€‚</em></p>
<h4 id="aaaa">AAAA</h4>
<p>AAAA è®°å½•ç”¨æ¥æŒ‡å®šä¸»æœºåï¼ˆåŸŸåï¼‰å¯¹åº”çš„ IPv6 åœ°å€è®°å½•ï¼Œå…¶ä»–ä¸ A ç›¸åŒã€‚</p>
<h4 id="cname-canonical-names">CNAME ï¼ˆcanonical namesï¼‰</h4>
<p>CNAMEï¼ˆè§„èŒƒåç§°ï¼‰ï¼Œä¹Ÿå°±æ˜¯åˆ«åè®°å½•ï¼Œå®ƒèƒ½å¤Ÿè®©æˆ‘ä»¬æŠŠå¤šä¸ªåå­—æ˜ å°„åˆ°åŒä¸€ä¸ªä¸»æœºã€‚</p>
<p>åº”ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>ä½¿ç”¨ CDN æœåŠ¡æ—¶ã€‚</li>
<li>å‡å¦‚ä¸€ä¸ªæœåŠ¡å™¨è¿è¡Œç€ 100 ä¸ªç½‘ç«™ï¼Œè¿™ 100 ä¸ªç½‘ç«™ CNAME åˆ° <code>a.example.com</code>ã€‚å½“è¯¥æœåŠ¡å™¨ IP æ”¹å˜æ—¶ï¼Œä½ åªéœ€æ”¹å˜ <code>a.example.com</code>çš„ IP å°±å¯ä»¥äº†ã€‚</li>
</ul>
<p>æ³¨æ„ï¼šç”±äº<code>CNAME</code>è®°å½•å°±æ˜¯ä¸€ä¸ªæ›¿æ¢ï¼Œæ‰€ä»¥åŸŸåä¸€æ—¦è®¾ç½®<code>CNAME</code>è®°å½•ä»¥åï¼Œå°±ä¸èƒ½å†è®¾ç½®å…¶ä»–è®°å½•äº†ï¼ˆæ¯”å¦‚<code>A</code>è®°å½•å’Œ<code>MX</code>è®°å½•ï¼‰ï¼Œè¿™æ˜¯ä¸ºäº†é˜²æ­¢äº§ç”Ÿå†²çªã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œ<code>foo.com</code>æŒ‡å‘<code>bar.com</code>ï¼Œè€Œä¸¤ä¸ªåŸŸåå„æœ‰è‡ªå·±çš„<code>MX</code>è®°å½•ï¼Œå¦‚æœä¸¤è€…ä¸ä¸€è‡´ï¼Œå°±ä¼šäº§ç”Ÿé—®é¢˜ã€‚ç”±äºé¡¶çº§åŸŸåé€šå¸¸è¦è®¾ç½®<code>MX</code>è®°å½•ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸å…è®¸ç”¨æˆ·å¯¹é¡¶çº§åŸŸåè®¾ç½®<code>CNAME</code>è®°å½•ã€‚</p>
<p>Aè®°å½•æ˜¯æŠŠåŸŸåè§£æåˆ°IPåœ°å€ï¼Œè€ŒCNAMEè®°å½•æ˜¯æŠŠåŸŸåè§£æåˆ°å¦å¤–ä¸€ä¸ªåŸŸåï¼Œè€Œè¿™ä¸ªåŸŸåæœ€ç»ˆä¼šæŒ‡å‘Aè®°å½•ï¼Œåœ¨åŠŸèƒ½å®ç°åœ¨ä¸ŠAè®°å½•ä¸CNAMEè®°å½•æ²¡æœ‰åŒºåˆ«ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<pre><code class="language-dns" data-lang="dns">a.example.com       IN      A       192.168.1.101
b.example.com       IN      CNAME   a.example.comï¼ˆè§„èŒƒåç§°ï¼‰
</code></pre><p>ä½ åœ¨è¯·æ±‚ b.example.com çš„æ—¶å€™ï¼Œä»–ä¼šå…ˆè¿”å›ç»™ä½ ä¸€ä¸ª CNAME ï¼Œç„¶åä½ åœ¨ç”¨ CNAME å»æŸ¥è¯¢ã€‚</p>
<h4 id="ns">NS</h4>
<p>NSï¼ˆName Serverï¼‰ï¼ŒåŸŸåæœåŠ¡å™¨è®°å½•ï¼Œè¿”å›ä¿å­˜ä¸‹ä¸€çº§åŸŸåä¿¡æ¯çš„æœåŠ¡å™¨åœ°å€ã€‚è¯¥è®°å½•åªèƒ½è®¾ç½®ä¸ºåŸŸåï¼Œä¸èƒ½è®¾ç½®ä¸ºIPåœ°å€ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œä¸ºäº†æœåŠ¡çš„å®‰å…¨å¯é ï¼Œè‡³å°‘åº”è¯¥æœ‰ä¸¤æ¡<code>NS</code>è®°å½•ï¼Œè€Œ<code>A</code>è®°å½•å’Œ<code>MX</code>è®°å½•ä¹Ÿå¯ä»¥æœ‰å¤šæ¡ï¼Œè¿™æ ·å°±æä¾›äº†æœåŠ¡çš„å†—ä½™æ€§ï¼Œé˜²æ­¢å‡ºç°å•ç‚¹å¤±è´¥ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ dig NS google.com
google.com.		777	IN	NS	ns4.google.com.
google.com.		777	IN	NS	ns3.google.com.
google.com.		777	IN	NS	ns2.google.com.
google.com.		777	IN	NS	ns1.google.com.
</code></pre></div><p>æˆ‘ä»¬å¯ä»¥çœ‹è§ï¼Œgoogle çš„æƒå¨ NS æœåŠ¡å™¨æœ‰å››ä¸ªã€‚</p>
<h4 id="mx">MX</h4>
<p>MXï¼ˆMX recordï¼‰ï¼Œé‚®ä»¶äº¤æ¢è®°å½•ï¼Œç”¨äºé‚®ä»¶æœåŠ¡å™¨çš„åœ°å€ã€‚MX è®°å½•å…è®¸è®¾ç½®ä¼˜å…ˆçº§ï¼Œå½“å¤šä¸ªé‚®ä»¶æœåŠ¡å™¨å¯ç”¨æ—¶ï¼Œä¼šæ ¹æ®è¯¥å€¼å†³å®šæŠ•é€’é‚®ä»¶çš„æœåŠ¡å™¨ï¼ˆå€¼å°çš„ä¼˜å…ˆï¼‰ï¼Œä¸‹é¢çš„<code>20, 10, 40 ...</code>å°±è¡¨ç¤ºä¼˜å…ˆçº§ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ dig MX google.com
google.com.		306	IN	MX	<span class="m">20</span> alt1.aspmx.l.google.com.
google.com.		306	IN	MX	<span class="m">10</span> aspmx.l.google.com.
google.com.		306	IN	MX	<span class="m">40</span> alt3.aspmx.l.google.com.
google.com.		306	IN	MX	<span class="m">30</span> alt2.aspmx.l.google.com.
google.com.		306	IN	MX	<span class="m">50</span> alt4.aspmx.l.google.com.
</code></pre></div><h4 id="soa">SOA</h4>
<p>SOA å«åšèµ·å§‹æˆæƒæœºæ„è®°å½•ï¼ŒNSç”¨äºæ ‡è¯†å¤šå°åŸŸåè§£ææœåŠ¡å™¨ï¼ŒSOAè®°å½•ç”¨äºåœ¨ä¼—å¤šNSè®°å½•ä¸­çš„<strong>ä¸»æœåŠ¡å™¨</strong>ã€‚SOA è®°å½•è¡¨ç¤ºæ­¤åŸŸåçš„æƒå¨è§£ææœåŠ¡å™¨åœ°å€ã€‚ å½“è¦æŸ¥è¯¢çš„åŸŸååœ¨æ‰€æœ‰é€’å½’è§£ææœåŠ¡å™¨ä¸­æ²¡æœ‰åŸŸåè§£æçš„ç¼“å­˜æ—¶ï¼Œå°±ä¼šå›æºæ¥è¯·æ±‚æ­¤åŸŸåçš„SOAè®°å½•ï¼Œä¹Ÿå«æƒå¨è§£æè®°å½•ã€‚</p>
<p>æ²¡æœ‰SOAè®°å½•çš„ zone ä¸ç¬¦åˆ RFC 1035 è¦æ±‚çš„æ ‡å‡†ã€‚</p>
<pre><code>$TTL 86400
@   IN  SOA     startech60serve root.startech60serve.com. (
        2018110201  ;Serial
        3600        ;Refresh
        1800        ;Retry
        604800      ;Expire
        86400       ;Minimum TTL
)
        IN  NS      startech60serve
        IN  A       192.168.1.3
        IN  MX 10   startech60serve
startech60serve     IN  A       192.168.1.3
</code></pre><p><code>root.startech60serve.com. </code>å…¶ä¸­ç¬¬ä¸€ä¸ªç‚¹è¡¨ç¤ºæ˜¯@</p>
<h4 id="txt">TXT</h4>
<p>TXTï¼ˆTXT recordï¼‰ï¼Œæ–‡æœ¬è®°å½•ï¼Œä¸€èˆ¬ç”¨æ¥æè¿°ä¸€ä¸ªåŸŸåï¼Œæˆ–è€…ç”¨æ¥åšæŸç§éªŒè¯åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ dig TXT google.com
google.com.		300	IN	TXT	<span class="s2">&#34;docusign=05958488-4752-4ef2-95eb-aa7ba8a3bd0e&#34;</span>
google.com.		3600	IN	TXT	<span class="s2">&#34;facebook-domain-verification=22rm551cu4k0ab0bxsw536tlds4h95&#34;</span>
google.com.		300	IN	TXT	<span class="s2">&#34;docusign=1b0a6754-49b1-4db5-8540-d2c12664b289&#34;</span>
google.com.		3600	IN	TXT	<span class="s2">&#34;globalsign-smime-dv=CDYX+XFHUw2wml6/Gb8+59BsH31KzUr6c1l2BPvqKX8=&#34;</span>
google.com.		3600	IN	TXT	<span class="s2">&#34;v=spf1 include:_spf.google.com ~all&#34;</span>
</code></pre></div><h4 id="ptr">PTR</h4>
<p>PTR è®°å½•æ˜¯ A è®°å½•çš„é€†å‘è®°å½•ï¼Œåˆç§°åš IP åæŸ¥è®°å½•æˆ–æŒ‡é’ˆè®°å½•ï¼Œè´Ÿè´£å°† IP åå‘è§£æä¸ºåŸŸåï¼Œå³åå‘åŸŸåè§£æã€‚</p>
<p>å‚è€ƒï¼š</p>
<p><a href="https://skyao.io/learning-dns/dns/">https://skyao.io/learning-dns/dns/</a></p>
<p><a href="https://deepzz.com/post/dns-recording-type.html">https://deepzz.com/post/dns-recording-type.html</a></p>
]]></content>
		</item>
		
		<item>
			<title>å¦‚ä½•è®¾è®¡ä¸å®ç° WebConsole</title>
			<link>https://wangzeping722.github.io/posts/how-to-write-webconsole/</link>
			<pubDate>Wed, 04 Dec 2019 09:13:51 +0800</pubDate>
			
			<guid>https://wangzeping722.github.io/posts/how-to-write-webconsole/</guid>
			<description>1. è°ƒç ” å‰ç«¯ï¼šäº†è§£åˆ°æœ‰ä¸€ä¸ªéå¸¸ä¼˜ç§€çš„å¼€æºwebç»ˆç«¯åº“ï¼š xterm.js , ä½¿ç”¨èµ·æ¥ä¹Ÿæ¯”è¾ƒç®€å•ã€‚ åç«¯ï¼šä½¿ç”¨ go è¯­è¨€å®ç°ï¼Œå› ä¸º go è¯­è¨€æ‹¥æœ‰è®¸å¤šä¼˜ç§€çš„å¼€æºsshåº“ï¼Œèƒ½å¤Ÿ</description>
			<content type="html"><![CDATA[<h3 id="1-è°ƒç ”">1. è°ƒç ”</h3>
<p>å‰ç«¯ï¼šäº†è§£åˆ°æœ‰ä¸€ä¸ªéå¸¸ä¼˜ç§€çš„å¼€æºwebç»ˆç«¯åº“ï¼š <strong>xterm.js</strong> , ä½¿ç”¨èµ·æ¥ä¹Ÿæ¯”è¾ƒç®€å•ã€‚</p>
<p>åç«¯ï¼šä½¿ç”¨ go è¯­è¨€å®ç°ï¼Œå› ä¸º go è¯­è¨€æ‹¥æœ‰è®¸å¤šä¼˜ç§€çš„å¼€æºsshåº“ï¼Œèƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚</p>
<p>éš¾ç‚¹ï¼š</p>
<pre><code>1. å¦‚ä½•ä¸ cf(cloud foundry) è¿›è¡Œäº¤äº’å¾—åˆ° `ssh code` ï¼Ÿ
2. å¦‚ä½•æŠŠ ssh å‘½ä»¤è¡Œè½¬æ¢æˆ websocket é€šè®¯, å¹¶è¾“å‡ºåˆ° xterm.js ä¸­ï¼Ÿ
3. å¦‚ä½•æ§åˆ¶è®¿é—®æƒé™ï¼Ÿ
</code></pre>
<h3 id="2-åŸç†">2. åŸç†</h3>
<p><img src="webconsole1.png" alt="webconsoleåŸç†å›¾"></p>
<p>â€‹	1. æµè§ˆå™¨å‘æœåŠ¡å™¨å‘èµ· websocket è¯·æ±‚</p>
<p>â€‹	2. æœåŠ¡å™¨é€šè¿‡ ssh è¿æ¥åˆ° cf å®¹å™¨</p>
<p>â€‹	3. è¿æ¥å»ºç«‹ï¼ŒæœåŠ¡å™¨è´Ÿè´£è½¬å‘æ¶ˆæ¯</p>
<p>åœ¨åç«¯å’Œæµè§ˆå™¨ä¹‹é—´å»ºç«‹websocketè¿æ¥åï¼Œå°†ç”¨æˆ·åœ¨æµè§ˆå™¨ä¸­è¾“å…¥çš„å‘½ä»¤é€šè¿‡ websocket åè®®å‘é€åˆ°åç«¯ï¼Œåç«¯ä½¿ç”¨ ssh åè®®å°†å‘½ä»¤è¾“å…¥åˆ°å®¹å™¨sshè¿›ç¨‹çš„ stdinï¼Œå‘½ä»¤æ‰§è¡Œåï¼Œå†ä» stdout ä¸­è¯»å–è¾“å‡ºï¼Œé€šè¿‡websocketåè®®è¿”å›æµè§ˆå™¨æ˜¾ç¤ºç»™ç”¨æˆ·ï¼Œè¾¾åˆ°äº¤äº’çš„ç›®çš„ã€‚</p>
<h3 id="3-é—®é¢˜è§£å†³ä»¥åŠæœåŠ¡ç«¯å®ç°">3. é—®é¢˜è§£å†³ä»¥åŠæœåŠ¡ç«¯å®ç°</h3>
<p>åœ¨å‰ä¸¤ä¸ªæ­¥éª¤ä¸­ï¼Œæˆ‘å·²ç»é€šè¿‡åˆ†ææŠŠåŸç†å’Œéš¾ç‚¹æ¢³ç†æ¸…æ¥šäº†ï¼Œç›®å‰å°±éœ€è¦ç€æ‰‹è§£å†³è¿™äº›é—®é¢˜ã€‚</p>
<h4 id="31-å¦‚ä½•è·å–-ssh-code">3.1 å¦‚ä½•è·å– ssh code</h4>
<p>cf æœ‰ä¸€ä¸ªè‡ªå¸¦çš„å‘½ä»¤ <code>cf ssh-code</code> èƒ½å¤Ÿè·å–è¿æ¥åˆ°å®¹å™¨ç”¨çš„ <code>ssh code</code>ï¼Œä½†æ˜¯æˆ‘å¹¶æ²¡æœ‰åœ¨ cf å¼€æºçš„ go è¯­è¨€å®¢æˆ·ç«¯ <code>cfclient</code> ä¸­å‘ç°ç›¸å…³çš„ APIï¼Œæ‰€ä»¥æˆ‘å»æŸ¥çœ‹äº† cf cli çš„æºç ï¼Œå¹¶åœ¨é‡Œé¢å‘ç°äº† <strong>cc</strong> æš´éœ²å‡ºæ¥çš„æ¥å£ï¼Œæœ‰äº†è¿™ä¸ªæ¥å£ä¹‹åï¼Œå°±èƒ½å¤Ÿé€šè¿‡ http è¯·æ±‚çš„æ–¹å¼è·å– <code>ssh-code</code>ã€‚ç”±äº <code>cfclient</code> ä¸­å¹¶æ²¡æœ‰ç›¸å…³çš„ä»£ç ï¼Œæ‰€ä»¥ä¸å¾—ä¸è‡ªå·±å®ç°ä¸€äº›æ–¹æ¥è·å– <code>ssh-code</code>, äºæ˜¯è¿™ä¸ªé—®é¢˜è§£å†³äº†ã€‚</p>
<h4 id="32-å¦‚ä½•å°†-websocket-å’Œ-ssh-è¿™ä¸¤ä¸ªåè®®çš„æ¶ˆæ¯è¿›è¡Œè½¬æ¢">3.2 å¦‚ä½•å°† websocket å’Œ ssh è¿™ä¸¤ä¸ªåè®®çš„æ¶ˆæ¯è¿›è¡Œè½¬æ¢</h4>
<p><strong>è¿æ¥å»ºç«‹</strong>ï¼š</p>
<p><img src="webconsole2.png" alt=""></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">WS</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// åˆå§‹åŒ–websocketè¿æ¥
</span><span class="c1"></span>	<span class="nx">upgrader</span> <span class="o">:=</span> <span class="nx">websocket</span><span class="p">.</span><span class="nx">Upgrader</span><span class="p">{</span>
		<span class="nx">ReadBufferSize</span><span class="p">:</span>  <span class="mi">1024</span><span class="p">,</span>
		<span class="nx">WriteBufferSize</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="nx">ws</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">upgrader</span><span class="p">.</span><span class="nf">Upgrade</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Writer</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
	<span class="k">defer</span> <span class="nx">ws</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="p">)</span>
  
	<span class="c1">// åˆå§‹åŒ–sshè¿æ¥
</span><span class="c1"></span>	<span class="nx">cl</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;claims&#34;</span><span class="p">)</span>
	<span class="nx">s</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;session&#34;</span><span class="p">)</span>
	<span class="nx">claims</span> <span class="o">:=</span> <span class="nx">cl</span><span class="p">.</span><span class="p">(</span><span class="o">*</span><span class="nx">utils</span><span class="p">.</span><span class="nx">Claims</span><span class="p">)</span>
	<span class="nx">session</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="p">(</span><span class="o">*</span><span class="nx">utils</span><span class="p">.</span><span class="nx">Session</span><span class="p">)</span>

	<span class="nx">sshShell</span> <span class="o">:=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">SSHShellSession</span><span class="p">{</span>
		<span class="nx">Node</span><span class="p">:</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">Node</span><span class="p">{</span>
			<span class="nx">Host</span><span class="p">:</span> <span class="nx">claims</span><span class="p">.</span><span class="nx">Host</span><span class="p">,</span>
			<span class="nx">Port</span><span class="p">:</span> <span class="nx">claims</span><span class="p">.</span><span class="nx">Port</span><span class="p">,</span>
		<span class="p">}</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="kd">var</span> <span class="nx">wsBuff</span> <span class="nx">WebSocketBufferWriter</span>
	<span class="nx">sshShell</span><span class="p">.</span><span class="nx">StdoutPipe</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">wsBuff</span>
	<span class="nx">err</span> <span class="p">=</span> <span class="nx">sshConn</span><span class="p">.</span><span class="nf">Connect</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span>
	<span class="k">defer</span> <span class="nx">sshConn</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="p">)</span>
	<span class="k">defer</span> <span class="nx">wsBuff</span><span class="p">.</span><span class="nf">Flush</span><span class="p">(</span><span class="nx">websocket</span><span class="p">.</span><span class="nx">TextMessage</span><span class="p">,</span> <span class="nx">ws</span><span class="p">)</span>
	<span class="o">...</span><span class="o">...</span>
  <span class="o">...</span><span class="o">...</span>
<span class="p">}</span>
</code></pre></div><p><strong>è¿æ¥ä¿æŒï¼š</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">WS</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
  <span class="o">...</span><span class="o">...</span>
  <span class="o">...</span><span class="o">...</span>
	<span class="nx">done</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
	<span class="nx">setDone</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span> <span class="nx">done</span> <span class="o">&lt;-</span> <span class="kc">true</span> <span class="p">}</span>

	<span class="c1">// æ•°æ®è½¬æ¢ï¼šwebsocket ----&gt; SSH
</span><span class="c1"></span>	<span class="nx">writeMessageToSSHServer</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">wc</span> <span class="nx">io</span><span class="p">.</span><span class="nx">WriteCloser</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">defer</span> <span class="nf">setDone</span><span class="p">(</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">{</span>
			<span class="c1">// ä»websocketè¯»å–æ•°æ®
</span><span class="c1"></span>			<span class="nx">msgType</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ws</span><span class="p">.</span><span class="nf">ReadMessage</span><span class="p">(</span><span class="p">)</span>

			<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">DispatchMessage</span><span class="p">(</span><span class="nx">sshShell</span><span class="p">.</span><span class="nx">Session</span><span class="p">,</span> <span class="nx">msgType</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">wc</span><span class="p">)</span><span class="p">;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Error: error write data to ssh server:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
				<span class="k">return</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="nx">stopper</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span>
	<span class="c1">// æ•°æ®è½¬æ¢ï¼šSSH ----&gt; websocket
</span><span class="c1"></span>	<span class="nx">writeBufferToWebSocket</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">defer</span> <span class="nf">setDone</span><span class="p">(</span><span class="p">)</span>
		<span class="nx">tick</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTicker</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">utils</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">SSH</span><span class="p">.</span><span class="nx">BufferCheckerCycleTime</span><span class="p">)</span><span class="p">)</span>
		<span class="k">defer</span> <span class="nx">tick</span><span class="p">.</span><span class="nf">Stop</span><span class="p">(</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">{</span>
			<span class="k">select</span> <span class="p">{</span>
			<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">tick</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
				<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">wsBuff</span><span class="p">.</span><span class="nf">Flush</span><span class="p">(</span><span class="nx">websocket</span><span class="p">.</span><span class="nx">TextMessage</span><span class="p">,</span> <span class="nx">ws</span><span class="p">)</span><span class="p">;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
					<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Error: error sending data via webSocket:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
					<span class="k">return</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">stopper</span><span class="p">:</span>
				<span class="k">return</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">go</span> <span class="nf">writeMessageToSSHServer</span><span class="p">(</span><span class="nx">sshShell</span><span class="p">.</span><span class="nx">StdinPipe</span><span class="p">)</span>
	<span class="k">go</span> <span class="nf">writeBufferToWebSocket</span><span class="p">(</span><span class="p">)</span>
	<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">defer</span> <span class="nf">setDone</span><span class="p">(</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sshShell</span><span class="p">.</span><span class="nx">Session</span><span class="p">.</span><span class="nf">Wait</span><span class="p">(</span><span class="p">)</span><span class="p">;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;ssh exist from server&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span><span class="p">(</span><span class="p">)</span>

	<span class="o">&lt;-</span><span class="nx">done</span>
	<span class="nx">stopper</span> <span class="o">&lt;-</span> <span class="kc">true</span> 
	<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Info: websocket finished!&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p><strong>æ§åˆ¶è®¿é—®æƒé™</strong>ï¼š</p>
<p>åˆ©ç”¨ cf è‡ªå¸¦çš„æƒé™è®¤è¯æœºåˆ¶å®ç°ã€‚</p>
]]></content>
		</item>
		
	</channel>
</rss>
