<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
	<channel>
		<title>Posts on 小王的杂货铺</title>
		<link>https://wangzeping722.github.io/posts/</link>
		<description>Recent content in Posts on 小王的杂货铺</description>
		<generator>Hugo -- gohugo.io</generator>
		<language>zh</language>
		<copyright>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</copyright>
		<lastBuildDate>Mon, 23 Dec 2019 10:36:05 +0800</lastBuildDate>
		<atom:link href="https://wangzeping722.github.io/posts/index.xml" rel="self" type="application/rss+xml" />
		
		<item>
			<title>DNS学习总结</title>
			<link>https://wangzeping722.github.io/posts/dns-recording/</link>
			<pubDate>Mon, 23 Dec 2019 10:36:05 +0800</pubDate>
			
			<guid>https://wangzeping722.github.io/posts/dns-recording/</guid>
			<description>DNS 有多种记录类型，每种记录都有不同的作用，这篇文章主要总结了常用的记录。 A A（Address）记录用来指定主机名（域名）对应的 IPv4 地址记录。比</description>
			<content type="html"><![CDATA[<p>DNS 有多种记录类型，每种记录都有不同的作用，这篇文章主要总结了常用的记录。</p>
<h4 id="a">A</h4>
<p>A（Address）记录用来指定主机名（域名）对应的 IPv4 地址记录。比如，当你浏览一个网页时候会，浏览器就会先去查找对应域名的 A 记录，来获取 IP 地址，获得了 IP 地址，才能与服务器建立连接。</p>
<blockquote>
<p>我们可以为同一个域名添加多个 A 记录，解析的时候，会得到多个 IP，会随机选择一个使用。</p>
</blockquote>
<p><em>域名不区分大小写。记录的名称应该是由 ASCII 码字母、数字和 - 组成。</em></p>
<h4 id="aaaa">AAAA</h4>
<p>AAAA 记录用来指定主机名（域名）对应的 IPv6 地址记录，其他与 A 相同。</p>
<h4 id="cname-canonical-names">CNAME （canonical names）</h4>
<p>CNAME（规范名称），也就是别名记录，它能够让我们把多个名字映射到同一个主机。</p>
<p>应用场景：</p>
<ul>
<li>使用 CDN 服务时。</li>
<li>假如一个服务器运行着 100 个网站，这 100 个网站 CNAME 到 <code>a.example.com</code>。当该服务器 IP 改变时，你只需改变 <code>a.example.com</code>的 IP 就可以了。</li>
</ul>
<p>注意：由于<code>CNAME</code>记录就是一个替换，所以域名一旦设置<code>CNAME</code>记录以后，就不能再设置其他记录了（比如<code>A</code>记录和<code>MX</code>记录），这是为了防止产生冲突。举例来说，<code>foo.com</code>指向<code>bar.com</code>，而两个域名各有自己的<code>MX</code>记录，如果两者不一致，就会产生问题。由于顶级域名通常要设置<code>MX</code>记录，所以一般不允许用户对顶级域名设置<code>CNAME</code>记录。</p>
<p>A记录是把域名解析到IP地址，而CNAME记录是把域名解析到另外一个域名，而这个域名最终会指向A记录，在功能实现在上A记录与CNAME记录没有区别。</p>
<p>例如：</p>
<pre><code class="language-dns" data-lang="dns">a.example.com       IN      A       192.168.1.101
b.example.com       IN      CNAME   a.example.com（规范名称）
</code></pre><p>你在请求 b.example.com 的时候，他会先返回给你一个 CNAME ，然后你在用 CNAME 去查询。</p>
<h4 id="ns">NS</h4>
<p>NS（Name Server），域名服务器记录，返回保存下一级域名信息的服务器地址。该记录只能设置为域名，不能设置为IP地址。</p>
<p>一般来说，为了服务的安全可靠，至少应该有两条<code>NS</code>记录，而<code>A</code>记录和<code>MX</code>记录也可以有多条，这样就提供了服务的冗余性，防止出现单点失败。</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ dig NS google.com
google.com.		777	IN	NS	ns4.google.com.
google.com.		777	IN	NS	ns3.google.com.
google.com.		777	IN	NS	ns2.google.com.
google.com.		777	IN	NS	ns1.google.com.
</code></pre></div><p>我们可以看见，google 的权威 NS 服务器有四个。</p>
<h4 id="mx">MX</h4>
<p>MX（MX record），邮件交换记录，用于邮件服务器的地址。MX 记录允许设置优先级，当多个邮件服务器可用时，会根据该值决定投递邮件的服务器（值小的优先），下面的<code>20, 10, 40 ...</code>就表示优先级。</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ dig MX google.com
google.com.		306	IN	MX	<span class="m">20</span> alt1.aspmx.l.google.com.
google.com.		306	IN	MX	<span class="m">10</span> aspmx.l.google.com.
google.com.		306	IN	MX	<span class="m">40</span> alt3.aspmx.l.google.com.
google.com.		306	IN	MX	<span class="m">30</span> alt2.aspmx.l.google.com.
google.com.		306	IN	MX	<span class="m">50</span> alt4.aspmx.l.google.com.
</code></pre></div><h4 id="soa">SOA</h4>
<p>SOA 叫做起始授权机构记录，NS用于标识多台域名解析服务器，SOA记录用于在众多NS记录中的<strong>主服务器</strong>。SOA 记录表示此域名的权威解析服务器地址。 当要查询的域名在所有递归解析服务器中没有域名解析的缓存时，就会回源来请求此域名的SOA记录，也叫权威解析记录。</p>
<p>没有SOA记录的 zone 不符合 RFC 1035 要求的标准。</p>
<pre><code>$TTL 86400
@   IN  SOA     startech60serve root.startech60serve.com. (
        2018110201  ;Serial
        3600        ;Refresh
        1800        ;Retry
        604800      ;Expire
        86400       ;Minimum TTL
)
        IN  NS      startech60serve
        IN  A       192.168.1.3
        IN  MX 10   startech60serve
startech60serve     IN  A       192.168.1.3
</code></pre><p><code>root.startech60serve.com. </code>其中第一个点表示是@</p>
<h4 id="txt">TXT</h4>
<p>TXT（TXT record），文本记录，一般用来描述一个域名，或者用来做某种验证功能，例如：</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ dig TXT google.com
google.com.		300	IN	TXT	<span class="s2">&#34;docusign=05958488-4752-4ef2-95eb-aa7ba8a3bd0e&#34;</span>
google.com.		3600	IN	TXT	<span class="s2">&#34;facebook-domain-verification=22rm551cu4k0ab0bxsw536tlds4h95&#34;</span>
google.com.		300	IN	TXT	<span class="s2">&#34;docusign=1b0a6754-49b1-4db5-8540-d2c12664b289&#34;</span>
google.com.		3600	IN	TXT	<span class="s2">&#34;globalsign-smime-dv=CDYX+XFHUw2wml6/Gb8+59BsH31KzUr6c1l2BPvqKX8=&#34;</span>
google.com.		3600	IN	TXT	<span class="s2">&#34;v=spf1 include:_spf.google.com ~all&#34;</span>
</code></pre></div><h4 id="ptr">PTR</h4>
<p>PTR 记录是 A 记录的逆向记录，又称做 IP 反查记录或指针记录，负责将 IP 反向解析为域名，即反向域名解析。</p>
<p>参考：</p>
<p><a href="https://skyao.io/learning-dns/dns/">https://skyao.io/learning-dns/dns/</a></p>
<p><a href="https://deepzz.com/post/dns-recording-type.html">https://deepzz.com/post/dns-recording-type.html</a></p>
]]></content>
		</item>
		
		<item>
			<title>Coredns 启动流程分析</title>
			<link>https://wangzeping722.github.io/posts/coredns-startup/</link>
			<pubDate>Thu, 12 Dec 2019 11:03:08 +0800</pubDate>
			
			<guid>https://wangzeping722.github.io/posts/coredns-startup/</guid>
			<description>最近在看coredns的实现，它是基于 caddy 框架实现的，充分利用了 caddy 的插件功能。由于 coredns 大多数功能都是利用插件功能来实现的，所以整个项目的代码理解</description>
			<content type="html"><![CDATA[<p>最近在看<code>coredns</code>的实现，它是基于 <a href="https://github.com/caddyserver/caddy">caddy</a> 框架实现的，充分利用了 caddy 的插件功能。由于 coredns 大多数功能都是利用插件功能来实现的，所以整个项目的代码理解起来都比较简单。</p>
<h4 id="coredns-的实现">CoreDNS 的实现</h4>
<p>首先来看根目录下的 <code>Makefile</code> ，其中有自动生成 <code>core/plugin/zplugin.go</code> 文件和 <code>core/dnsserver/zdirectives.go</code> 文件的命令：</p>
<div class="highlight"><pre class="chroma"><code class="language-makefile" data-lang="makefile"><span class="nf">core/plugin/zplugin.go core/dnsserver/zdirectives.go</span><span class="o">:</span> <span class="n">plugin</span>.<span class="n">cfg</span>
	go generate coredns.go
</code></pre></div><p>该命令可以通过 <code>plugin.cfg</code> 中列出的插件列表自动生成 zplugin.go 和 zdirectives.go 中的代码：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// generated by directives_generate.go; DO NOT EDIT
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">plugin</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="c1">// Include all plugins.
</span><span class="c1"></span>	<span class="nx">_</span> <span class="s">&#34;github.com/caddyserver/caddy/onevent&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/acl&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/any&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/auto&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/autopath&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/azure&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/bind&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/bufsize&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/cache&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/cancel&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/chaos&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/clouddns&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/debug&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/dnssec&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/dnstap&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/erratic&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/errors&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/etcd&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/file&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/forward&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/grpc&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/health&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/hosts&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/k8s_external&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/kubernetes&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/loadbalance&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/log&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/loop&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/metadata&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/metrics&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/nsid&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/pprof&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/ready&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/reload&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/rewrite&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/root&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/route53&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/secondary&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/sign&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/template&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/tls&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/trace&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/transfer&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/plugin/whoami&#34;</span>
	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/federation&#34;</span>
<span class="p">)</span>
</code></pre></div><div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// generated by directives_generate.go; DO NOT EDIT
</span><span class="c1"></span>
<span class="kn">package</span> <span class="nx">dnsserver</span>

<span class="kd">var</span> <span class="nx">Directives</span> <span class="p">=</span> <span class="p">[</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
	<span class="s">&#34;metadata&#34;</span><span class="p">,</span>
	<span class="s">&#34;cancel&#34;</span><span class="p">,</span>
	<span class="s">&#34;tls&#34;</span><span class="p">,</span>
	<span class="s">&#34;reload&#34;</span><span class="p">,</span>
	<span class="s">&#34;nsid&#34;</span><span class="p">,</span>
	<span class="s">&#34;bufsize&#34;</span><span class="p">,</span>
	<span class="s">&#34;root&#34;</span><span class="p">,</span>
	<span class="s">&#34;bind&#34;</span><span class="p">,</span>
	<span class="s">&#34;debug&#34;</span><span class="p">,</span>
	<span class="s">&#34;trace&#34;</span><span class="p">,</span>
	<span class="s">&#34;ready&#34;</span><span class="p">,</span>
	<span class="s">&#34;health&#34;</span><span class="p">,</span>
	<span class="s">&#34;pprof&#34;</span><span class="p">,</span>
	<span class="s">&#34;prometheus&#34;</span><span class="p">,</span>
	<span class="s">&#34;errors&#34;</span><span class="p">,</span>
	<span class="s">&#34;log&#34;</span><span class="p">,</span>
	<span class="s">&#34;dnstap&#34;</span><span class="p">,</span>
	<span class="s">&#34;acl&#34;</span><span class="p">,</span>
	<span class="s">&#34;any&#34;</span><span class="p">,</span>
	<span class="s">&#34;chaos&#34;</span><span class="p">,</span>
	<span class="s">&#34;loadbalance&#34;</span><span class="p">,</span>
	<span class="s">&#34;cache&#34;</span><span class="p">,</span>
	<span class="s">&#34;rewrite&#34;</span><span class="p">,</span>
	<span class="s">&#34;dnssec&#34;</span><span class="p">,</span>
	<span class="s">&#34;autopath&#34;</span><span class="p">,</span>
	<span class="s">&#34;template&#34;</span><span class="p">,</span>
	<span class="s">&#34;transfer&#34;</span><span class="p">,</span>
	<span class="s">&#34;hosts&#34;</span><span class="p">,</span>
	<span class="s">&#34;route53&#34;</span><span class="p">,</span>
	<span class="s">&#34;azure&#34;</span><span class="p">,</span>
	<span class="s">&#34;clouddns&#34;</span><span class="p">,</span>
	<span class="s">&#34;federation&#34;</span><span class="p">,</span>
	<span class="s">&#34;k8s_external&#34;</span><span class="p">,</span>
	<span class="s">&#34;kubernetes&#34;</span><span class="p">,</span>
	<span class="s">&#34;file&#34;</span><span class="p">,</span>
	<span class="s">&#34;auto&#34;</span><span class="p">,</span>
	<span class="s">&#34;secondary&#34;</span><span class="p">,</span>
	<span class="s">&#34;etcd&#34;</span><span class="p">,</span>
	<span class="s">&#34;loop&#34;</span><span class="p">,</span>
	<span class="s">&#34;forward&#34;</span><span class="p">,</span>
	<span class="s">&#34;grpc&#34;</span><span class="p">,</span>
	<span class="s">&#34;erratic&#34;</span><span class="p">,</span>
	<span class="s">&#34;whoami&#34;</span><span class="p">,</span>
	<span class="s">&#34;on&#34;</span><span class="p">,</span>
	<span class="s">&#34;sign&#34;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div><p>这些代码的作用将在后面解释。</p>
<h5 id="main函数">main函数</h5>
<p>我们先看 <code>coredns.go</code> 中的 main 函数：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">main</span>

<span class="c1">//go:generate go run directives_generate.go
</span><span class="c1"></span><span class="c1">//go:generate go run owners_generate.go
</span><span class="c1"></span>
<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;github.com/coredns/coredns/coremain&#34;</span>

	<span class="c1">// 初始化所有插件
</span><span class="c1"></span>	<span class="nx">_</span> <span class="s">&#34;github.com/coredns/coredns/core/plugin&#34;</span>
<span class="p">)</span>

<span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">coremain</span><span class="p">.</span><span class="nf">Run</span><span class="p">(</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>想必大家都很熟悉 <code>_ &quot;github.com/coredns/coredns/core/plugin&quot;</code> 这一用法，目的就是想执行包 github.com/coredns/coredns/core/plugin 里的 <strong>init</strong> 函数。这时再回头看看 <code>core/plugin/zplugin.go</code> 中的代码，原来它又接着导入了所有在 <strong>plugin.cfg</strong> 中声明的插件的包，并且执行包里的 <strong>init</strong> 函数。这就使得所有的插件都会在 caddy 中注册自己，例如插件 file 的注册如下：</p>
<p><img src="file-init.png" alt="file-init"></p>
<p><img src="register.png" alt="register plugin"></p>
<p><code>caddy.Plugin</code> 结构包含了被注册的插件的基本信息,包括注册的服务类型(在CoreDNS中的服务类型是 <code>dns</code> )和请求这个插件时,这个插件该做的 Action。</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Plugin is a type which holds information about a plugin.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Plugin</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="c1">// ServerType is the type of server this plugin is for.
</span><span class="c1"></span>	<span class="c1">// Can be empty if not applicable, or if the plugin
</span><span class="c1"></span>	<span class="c1">// can associate with any server type.
</span><span class="c1"></span>	<span class="nx">ServerType</span> <span class="kt">string</span>

	<span class="c1">// Action is the plugin&#39;s setup function, if associated
</span><span class="c1"></span>	<span class="c1">// with a directive in the Caddyfile.
</span><span class="c1"></span>	<span class="nx">Action</span> <span class="nx">SetupFunc</span>
<span class="p">}</span>
</code></pre></div><p>caddy.RegisterPlugin方法的作用:</p>
<p>将指定plugin name(本示例:kubernetes)注册到服务类型为DNS的CoreDNS服务中。最终所有被注册plugin的存储结构为:</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// plugins is a map of server type to map of plugin name to
</span><span class="c1"></span><span class="c1">// Plugin. These are the &#34;general&#34; plugins that may or may
</span><span class="c1"></span><span class="c1">// not be associated with a specific server type. If it&#39;s
</span><span class="c1"></span><span class="c1">// applicable to multiple server types or the server type is
</span><span class="c1"></span><span class="c1">// irrelevant, the key is empty string (&#34;&#34;). But all plugins
</span><span class="c1"></span><span class="c1">// must have a name.
</span><span class="c1"></span><span class="nx">plugins</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">Plugin</span><span class="p">)</span>
</code></pre></div><p>因此，通过上面的这个过程就把CoreDNS需要的所有的plugin都注册到了 <code>plugins = make(map[string]map[string]Plugin)</code> 结构中，用于后续的使用。</p>
<p>注册完所有的 plugin 之后，就开始执行 main 方法。接着会去调用 <code>coremain.Run()</code> 函数，通过 <code>Run</code> 方法进入 CoreDNS 的初始化过程。需要注意的是，run.go 引入了包 <code>github.com/coredns/coredns/core/dnsserver</code> ，里面也包含了<strong>init</strong> 方法：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">const</span> <span class="nx">serverType</span> <span class="p">=</span> <span class="s">&#34;dns&#34;</span>

<span class="c1">// Any flags defined here, need to be namespaced to the serverType other
</span><span class="c1"></span><span class="c1">// wise they potentially clash with other server types.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">init</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">Port</span><span class="p">,</span> <span class="nx">serverType</span><span class="o">+</span><span class="s">&#34;.port&#34;</span><span class="p">,</span> <span class="nx">DefaultPort</span><span class="p">,</span> <span class="s">&#34;Default port&#34;</span><span class="p">)</span>

	<span class="nx">caddy</span><span class="p">.</span><span class="nf">RegisterServerType</span><span class="p">(</span><span class="nx">serverType</span><span class="p">,</span> <span class="nx">caddy</span><span class="p">.</span><span class="nx">ServerType</span><span class="p">{</span>
		<span class="nx">Directives</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">[</span><span class="p">]</span><span class="kt">string</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">Directives</span> <span class="p">}</span><span class="p">,</span>
		<span class="nx">DefaultInput</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="nx">caddy</span><span class="p">.</span><span class="nx">Input</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">caddy</span><span class="p">.</span><span class="nx">CaddyfileInput</span><span class="p">{</span>
				<span class="nx">Filepath</span><span class="p">:</span>       <span class="s">&#34;Corefile&#34;</span><span class="p">,</span>
				<span class="nx">Contents</span><span class="p">:</span>       <span class="p">[</span><span class="p">]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&#34;.:&#34;</span> <span class="o">+</span> <span class="nx">Port</span> <span class="o">+</span> <span class="s">&#34; {\nwhoami\nlog\n}\n&#34;</span><span class="p">)</span><span class="p">,</span>
				<span class="nx">ServerTypeName</span><span class="p">:</span> <span class="nx">serverType</span><span class="p">,</span>
			<span class="p">}</span>
		<span class="p">}</span><span class="p">,</span>
		<span class="nx">NewContext</span><span class="p">:</span> <span class="nx">newContext</span><span class="p">,</span>
	<span class="p">}</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>这里会向 caddy 注册一个名为 <code>dns</code> 的服务类型，并关联与这个 dns 服务类型相关的一些操作和信息，包括：</p>
<ul>
<li>插件的执行顺序</li>
<li>默认配置文件</li>
<li><code>newContext</code>就是<code>dnsContext</code>对象，实现了 caddy 的 Context 接口</li>
</ul>
<p>进入 run.go 的 init 函数，这里以注释的形式展示：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">init</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// 默认配置文件
</span><span class="c1"></span>	<span class="nx">caddy</span><span class="p">.</span><span class="nx">DefaultConfigFile</span> <span class="p">=</span> <span class="s">&#34;Corefile&#34;</span>
	<span class="nx">caddy</span><span class="p">.</span><span class="nx">Quiet</span> <span class="p">=</span> <span class="kc">true</span> <span class="c1">// don&#39;t show init stuff from caddy
</span><span class="c1"></span>	<span class="nf">setVersion</span><span class="p">(</span><span class="p">)</span>	<span class="c1">// 设置版本信息
</span><span class="c1"></span>
	<span class="c1">// 指定需要加载的配置文件
</span><span class="c1"></span>	<span class="nx">flag</span><span class="p">.</span><span class="nf">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">conf</span><span class="p">,</span> <span class="s">&#34;conf&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;Corefile to load (default \&#34;&#34;</span><span class="o">+</span><span class="nx">caddy</span><span class="p">.</span><span class="nx">DefaultConfigFile</span><span class="o">+</span><span class="s">&#34;\&#34;)&#34;</span><span class="p">)</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">BoolVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">plugins</span><span class="p">,</span> <span class="s">&#34;plugins&#34;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s">&#34;List installed plugins&#34;</span><span class="p">)</span>
	<span class="c1">// 需要将PIDfile写入的地址
</span><span class="c1"></span>	<span class="nx">flag</span><span class="p">.</span><span class="nf">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">caddy</span><span class="p">.</span><span class="nx">PidFile</span><span class="p">,</span> <span class="s">&#34;pidfile&#34;</span><span class="p">,</span> <span class="s">&#34;&#34;</span><span class="p">,</span> <span class="s">&#34;Path to write pid file&#34;</span><span class="p">)</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">BoolVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">version</span><span class="p">,</span> <span class="s">&#34;version&#34;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s">&#34;Show version&#34;</span><span class="p">)</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">BoolVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">dnsserver</span><span class="p">.</span><span class="nx">Quiet</span><span class="p">,</span> <span class="s">&#34;quiet&#34;</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="s">&#34;Quiet mode (no initialization output)&#34;</span><span class="p">)</span>

  <span class="c1">// 与加载配置文件有关
</span><span class="c1"></span>	<span class="nx">caddy</span><span class="p">.</span><span class="nf">RegisterCaddyfileLoader</span><span class="p">(</span><span class="s">&#34;flag&#34;</span><span class="p">,</span> <span class="nx">caddy</span><span class="p">.</span><span class="nf">LoaderFunc</span><span class="p">(</span><span class="nx">confLoader</span><span class="p">)</span><span class="p">)</span>
	<span class="nx">caddy</span><span class="p">.</span><span class="nf">SetDefaultCaddyfileLoader</span><span class="p">(</span><span class="s">&#34;default&#34;</span><span class="p">,</span> <span class="nx">caddy</span><span class="p">.</span><span class="nf">LoaderFunc</span><span class="p">(</span><span class="nx">defaultLoader</span><span class="p">)</span><span class="p">)</span>

	<span class="nx">caddy</span><span class="p">.</span><span class="nx">AppName</span> <span class="p">=</span> <span class="nx">coreName</span>
	<span class="nx">caddy</span><span class="p">.</span><span class="nx">AppVersion</span> <span class="p">=</span> <span class="nx">CoreVersion</span>
<span class="p">}</span>
</code></pre></div><p>做了那么多准备工作，终于要进入主方法了，我们来看 run.go 中的 Run 方法：</p>
<p>其他的代码我们就不关心了，直接看 :</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">corefile</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">caddy</span><span class="p">.</span><span class="nf">LoadCaddyfile</span><span class="p">(</span><span class="nx">serverType</span><span class="p">)</span>
</code></pre></div><p>该函数主要就是利用 coredns 注册的两个方法解析并加载配置文件到 <code>corefile</code>中，corefile 对应的结构体定义如下：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Input represents a Caddyfile; its contents and file path
</span><span class="c1"></span><span class="c1">// (which should include the file name at the end of the path).
</span><span class="c1"></span><span class="c1">// If path does not apply (e.g. piped input) you may use
</span><span class="c1"></span><span class="c1">// any understandable value. The path is mainly used for logging,
</span><span class="c1"></span><span class="c1">// error messages, and debugging.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Input</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// Gets the Caddyfile contents
</span><span class="c1"></span>	<span class="nf">Body</span><span class="p">(</span><span class="p">)</span> <span class="p">[</span><span class="p">]</span><span class="kt">byte</span>

	<span class="c1">// Gets the path to the origin file
</span><span class="c1"></span>	<span class="nf">Path</span><span class="p">(</span><span class="p">)</span> <span class="kt">string</span>

	<span class="c1">// The type of server this input is intended for
</span><span class="c1"></span>	<span class="nf">ServerType</span><span class="p">(</span><span class="p">)</span> <span class="kt">string</span>
<span class="p">}</span>
</code></pre></div><p>有了 <code>corefile</code> 我们就能够启动服务器啦：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">instance</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">caddy</span><span class="p">.</span><span class="nf">Start</span><span class="p">(</span><span class="nx">corefile</span><span class="p">)</span>
</code></pre></div><p>Start 的细节我们接下来再说，我们先把主流程看完，Start 会返回一个 instance 结构，其包含了服务的状态，并且可以用来控制和访问这些服务：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Instance contains the state of servers created as a result of
</span><span class="c1"></span><span class="c1">// calling Start and can be used to access or control those servers.
</span><span class="c1"></span><span class="c1">// It is literally an instance of a server type. Instance values
</span><span class="c1"></span><span class="c1">// should NOT be copied. Use *Instance for safety.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">Instance</span> <span class="kd">struct</span> <span class="p">{</span>
   <span class="c1">// serverType is the name of the instance&#39;s server type
</span><span class="c1"></span>   <span class="nx">serverType</span> <span class="kt">string</span>

   <span class="c1">// caddyfileInput is the input configuration text used for this process
</span><span class="c1"></span>   <span class="nx">caddyfileInput</span> <span class="nx">Input</span>

   <span class="c1">// wg is used to wait for all servers to shut down
</span><span class="c1"></span>   <span class="nx">wg</span> <span class="o">*</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span>

   <span class="c1">// context is the context created for this instance,
</span><span class="c1"></span>   <span class="c1">// used to coordinate the setting up of the server type
</span><span class="c1"></span>   <span class="nx">context</span> <span class="nx">Context</span>

   <span class="c1">// servers is the list of servers with their listeners
</span><span class="c1"></span>   <span class="nx">servers</span> <span class="p">[</span><span class="p">]</span><span class="nx">ServerListener</span>

   <span class="c1">// these callbacks execute when certain events occur
</span><span class="c1"></span>   <span class="nx">OnFirstStartup</span>  <span class="p">[</span><span class="p">]</span><span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="kt">error</span> <span class="c1">// starting, not as part of a restart
</span><span class="c1"></span>   <span class="nx">OnStartup</span>       <span class="p">[</span><span class="p">]</span><span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="kt">error</span> <span class="c1">// starting, even as part of a restart
</span><span class="c1"></span>   <span class="nx">OnRestart</span>       <span class="p">[</span><span class="p">]</span><span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="kt">error</span> <span class="c1">// before restart commences
</span><span class="c1"></span>   <span class="nx">OnRestartFailed</span> <span class="p">[</span><span class="p">]</span><span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="kt">error</span> <span class="c1">// if restart failed
</span><span class="c1"></span>   <span class="nx">OnShutdown</span>      <span class="p">[</span><span class="p">]</span><span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="kt">error</span> <span class="c1">// stopping, even as part of a restart
</span><span class="c1"></span>   <span class="nx">OnFinalShutdown</span> <span class="p">[</span><span class="p">]</span><span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="kt">error</span> <span class="c1">// stopping, not as part of a restart
</span><span class="c1"></span>
   <span class="c1">// storing values on an instance is preferable to
</span><span class="c1"></span>   <span class="c1">// global state because these will get garbage-
</span><span class="c1"></span>   <span class="c1">// collected after in-process reloads when the
</span><span class="c1"></span>   <span class="c1">// old instances are destroyed; use StorageMu
</span><span class="c1"></span>   <span class="c1">// to access this value safely
</span><span class="c1"></span>   <span class="nx">Storage</span>   <span class="kd">map</span><span class="p">[</span><span class="kd">interface</span><span class="p">{</span><span class="p">}</span><span class="p">]</span><span class="kd">interface</span><span class="p">{</span><span class="p">}</span>
   <span class="nx">StorageMu</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
<span class="p">}</span>

<span class="c1">// ServerListener pairs a server to its listener and/or packetconn.
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ServerListener</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">server</span>   <span class="nx">Server</span>
	<span class="nx">listener</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span>
	<span class="nx">packet</span>   <span class="nx">net</span><span class="p">.</span><span class="nx">PacketConn</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">Server</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="nx">TCPServer</span>
	<span class="nx">UDPServer</span>
<span class="p">}</span>
</code></pre></div><ul>
<li>serverType：表示该 instance 的服务类型，在 coredns 中是 <code>dns</code></li>
<li>caddyfileInput：表示配置文件</li>
<li>wg：wg 用来等待所有的服务器关闭</li>
<li>context：启动服务时需要的一些上下文配置，在 coredns 中，这个 context 就是 <code>dnsContext</code></li>
<li>servers：该 instance 需要启动的服务列表，从上面的代码中可以看出，主要是 <code>TCP</code> 和 <code>UDP</code> 服务。</li>
<li>Onxxx：on 开头的方法可以看成当特定事件发生时候的回调函数</li>
<li>Storage：用来存储全局状态</li>
</ul>
<p>然后主函数阻塞在instance.Wait()上面。</p>
<hr>
<p>接下来，我们来看 Start 函数：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// Start starts Caddy with the given Caddyfile.
</span><span class="c1"></span><span class="c1">//
</span><span class="c1"></span><span class="c1">// This function blocks until all the servers are listening.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">Start</span><span class="p">(</span><span class="nx">cdyfile</span> <span class="nx">Input</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Instance</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">inst</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Instance</span><span class="p">{</span><span class="nx">serverType</span><span class="p">:</span> <span class="nx">cdyfile</span><span class="p">.</span><span class="nf">ServerType</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="nx">wg</span><span class="p">:</span> <span class="nb">new</span><span class="p">(</span><span class="nx">sync</span><span class="p">.</span><span class="nx">WaitGroup</span><span class="p">)</span><span class="p">,</span> <span class="nx">Storage</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kd">interface</span><span class="p">{</span><span class="p">}</span><span class="p">]</span><span class="kd">interface</span><span class="p">{</span><span class="p">}</span><span class="p">)</span><span class="p">}</span>
	<span class="nx">err</span> <span class="o">:=</span> <span class="nf">startWithListenerFds</span><span class="p">(</span><span class="nx">cdyfile</span><span class="p">,</span> <span class="nx">inst</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="nx">inst</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nf">signalSuccessToParent</span><span class="p">(</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">pidErr</span> <span class="o">:=</span> <span class="nf">writePidFile</span><span class="p">(</span><span class="p">)</span><span class="p">;</span> <span class="nx">pidErr</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Printf</span><span class="p">(</span><span class="s">&#34;[ERROR] Could not write pidfile: %v&#34;</span><span class="p">,</span> <span class="nx">pidErr</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// Execute instantiation events
</span><span class="c1"></span>	<span class="nf">EmitEvent</span><span class="p">(</span><span class="nx">InstanceStartupEvent</span><span class="p">,</span> <span class="nx">inst</span><span class="p">)</span>

	<span class="k">return</span> <span class="nx">inst</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>可以看见，他首先初始化了一个 Instance 结构体，在该函数中主要调用三个函数分别是:</p>
<ul>
<li>startWithListenerFds: 用于解析 Corefile 配置文件及校验指令执行的是否正确，并启动CoreDNS服务。</li>
<li>signalSuccessToParent: 向父进程报告服务启动状态。</li>
<li>writePidFile: 将启动服务的进程 ID(PID) 写入到指定的文件。</li>
</ul>
<p>从上面的解释中即可知道 startWithListenerFds 是最为核心的函数调用了，接下来直接详细的分析startWithListenerFds 函数。在该函数中首先会调用</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">err</span> <span class="p">=</span> <span class="nf">ValidateAndExecuteDirectives</span><span class="p">(</span><span class="nx">cdyfile</span><span class="p">,</span> <span class="nx">inst</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
</code></pre></div><p>从名字就可以看出这个函数的主要功能就是验证和执行指令（也就是插件），首先他会调用</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">sblocks</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">loadServerBlocks</span><span class="p">(</span><span class="nx">stypeName</span><span class="p">,</span> <span class="nx">cdyfile</span><span class="p">.</span><span class="nf">Path</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="nx">bytes</span><span class="p">.</span><span class="nf">NewReader</span><span class="p">(</span><span class="nx">cdyfile</span><span class="p">.</span><span class="nf">Body</span><span class="p">(</span><span class="p">)</span><span class="p">)</span><span class="p">)</span>
</code></pre></div><p>来解析配置文件中的内容，如果配置文件中出现了coredns无法识别的插件，那么就会直接返回错误，程序终止，如果解析成功，那么就会把配置文件中的内容映射到 ServerBlock 结构体中：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// ServerBlock associates any number of keys (usually addresses
</span><span class="c1"></span><span class="c1">// of some sort) with tokens (grouped by directive name).
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">ServerBlock</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">Keys</span>   <span class="p">[</span><span class="p">]</span><span class="kt">string</span>
	<span class="nx">Tokens</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="p">[</span><span class="p">]</span><span class="nx">Token</span>
<span class="p">}</span>
</code></pre></div><p>其中，keys 用来存储配置文件中 Zone 的相关数据，而 Tokens 则用来存储该 server 中的插件的相关信息，其中 Tokens 的 key 是 plugin name , []Token 存储的是该 plugin 在 Corefile 中的位置，便于后续的解析操作。可能不太好理解，但是对应配置文件就非常好理解啦：</p>
<pre><code class="language-Corefile" data-lang="Corefile">// coredns.io:5300 为 keys
coredns.io:5300 {
    file db.coredns.io
}

example.io:53 {
    log
    errors
    file db.example.io
}

example.net:53 {
    file db.example.net
}

.:53 {
    kubernetes
    proxy . 8.8.8.8
    log
    errors
    cache
}
</code></pre><p><img src="debug.png" alt=""></p>
<p>如上图，对应的 zone 就是 <code>example.io:53</code>，其中包含三个插件，所以 Tokens 有三个元素，其中 file 插件对应的value 的长度为 2。</p>
<p>接着，会调用</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">inst</span><span class="p">.</span><span class="nx">context</span> <span class="p">=</span> <span class="nx">stype</span><span class="p">.</span><span class="nf">NewContext</span><span class="p">(</span><span class="nx">inst</span><span class="p">)</span>
</code></pre></div><p>这里的 stype.NewContext 就是在初始化阶段赋值给他的 <code>newContext</code>函数：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">newContext</span><span class="p">(</span><span class="nx">i</span> <span class="o">*</span><span class="nx">caddy</span><span class="p">.</span><span class="nx">Instance</span><span class="p">)</span> <span class="nx">caddy</span><span class="p">.</span><span class="nx">Context</span> <span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="nx">dnsContext</span><span class="p">{</span><span class="nx">keysToConfigs</span><span class="p">:</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">Config</span><span class="p">)</span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// dnsContext
</span><span class="c1"></span><span class="c1">// 实现了caddy.Context接口
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">dnsContext</span> <span class="kd">struct</span> <span class="p">{</span>
	<span class="nx">keysToConfigs</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">Config</span>

	<span class="c1">// configs is the master list of all site configs.
</span><span class="c1"></span>	<span class="c1">// configs是所有站点配置的主列表。
</span><span class="c1"></span>	<span class="nx">configs</span> <span class="p">[</span><span class="p">]</span><span class="o">*</span><span class="nx">Config</span>
<span class="p">}</span>

<span class="nx">Context</span> <span class="kd">interface</span> <span class="p">{</span>
	<span class="c1">// Called after the Caddyfile is parsed into server
</span><span class="c1"></span>	<span class="c1">// blocks but before the directives are executed,
</span><span class="c1"></span>	<span class="c1">// this method gives you an opportunity to inspect
</span><span class="c1"></span>	<span class="c1">// the server blocks and prepare for the execution
</span><span class="c1"></span>	<span class="c1">// of directives. Return the server blocks (which
</span><span class="c1"></span>	<span class="c1">// you may modify, if desired) and an error, if any.
</span><span class="c1"></span>	<span class="c1">// The first argument is the name or path to the
</span><span class="c1"></span>	<span class="c1">// configuration file (Caddyfile).
</span><span class="c1"></span>	<span class="c1">//
</span><span class="c1"></span>	<span class="c1">// This function can be a no-op and simply return its
</span><span class="c1"></span>	<span class="c1">// input if there is nothing to do here.
</span><span class="c1"></span>	<span class="nf">InspectServerBlocks</span><span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="p">[</span><span class="p">]</span><span class="nx">caddyfile</span><span class="p">.</span><span class="nx">ServerBlock</span><span class="p">)</span> <span class="p">(</span><span class="p">[</span><span class="p">]</span><span class="nx">caddyfile</span><span class="p">.</span><span class="nx">ServerBlock</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>

	<span class="c1">// This is what Caddy calls to make server instances.
</span><span class="c1"></span>	<span class="c1">// By this time, all directives have been executed and,
</span><span class="c1"></span>	<span class="c1">// presumably, the context has enough state to produce
</span><span class="c1"></span>	<span class="c1">// server instances for Caddy to start.
</span><span class="c1"></span>	<span class="nf">MakeServers</span><span class="p">(</span><span class="p">)</span> <span class="p">(</span><span class="p">[</span><span class="p">]</span><span class="nx">Server</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>所以，创建一个实现了 <code>caddy.Context</code> 接口的 <code>dnsContext</code>结构体，并赋值给 <code>instance.Context</code>，然后调用 Context 的接口方法 InspectServerBlocks ，这个函数会在解析完Corefile文件之后，执行Corefile中的指令之前会被调用，用于进一步的对 sblocks 进行检查并进行进一步的参数完善。：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">sblocks</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">inst</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nf">InspectServerBlocks</span><span class="p">(</span><span class="nx">cdyfile</span><span class="p">.</span><span class="nf">Path</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="nx">sblocks</span><span class="p">)</span>
</code></pre></div><p>等上面的准备工作准备完成之后，会调用<code>executeDirectives</code>去遍历所有的指令<code>directives</code>,并执行每个 sblocks 中的指令,并设置相应的 Controller 去执行相关 plugin 的 action 动作, 每个 serverblock 中的插件的 setup 只执行一次:</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">executeDirectives</span><span class="p">(</span><span class="nx">inst</span> <span class="o">*</span><span class="nx">Instance</span><span class="p">,</span> <span class="nx">filename</span> <span class="kt">string</span><span class="p">,</span>
   <span class="nx">directives</span> <span class="p">[</span><span class="p">]</span><span class="kt">string</span><span class="p">,</span> <span class="nx">sblocks</span> <span class="p">[</span><span class="p">]</span><span class="nx">caddyfile</span><span class="p">.</span><span class="nx">ServerBlock</span><span class="p">,</span> <span class="nx">justValidate</span> <span class="kt">bool</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
   <span class="c1">// map of server block ID to map of directive name to whatever.
</span><span class="c1"></span>   <span class="nx">storages</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{</span><span class="p">}</span><span class="p">)</span>

   <span class="c1">// It is crucial that directives are executed in the proper order.
</span><span class="c1"></span>   <span class="c1">// We loop with the directives on the outer loop so we execute
</span><span class="c1"></span>   <span class="c1">// a directive for all server blocks before going to the next directive.
</span><span class="c1"></span>   <span class="c1">// This is important mainly due to the parsing callbacks (below).
</span><span class="c1"></span>   <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">dir</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">directives</span> <span class="p">{</span>
      <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">sb</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">sblocks</span> <span class="p">{</span>
         <span class="kd">var</span> <span class="nx">once</span> <span class="nx">sync</span><span class="p">.</span><span class="nx">Once</span>
         <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">storages</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="p">;</span> <span class="p">!</span><span class="nx">ok</span> <span class="p">{</span>
            <span class="nx">storages</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{</span><span class="p">}</span><span class="p">)</span>
         <span class="p">}</span>

         <span class="k">for</span> <span class="nx">j</span><span class="p">,</span> <span class="nx">key</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">Keys</span> <span class="p">{</span>
            <span class="c1">// Execute directive if it is in the server block
</span><span class="c1"></span>            <span class="k">if</span> <span class="nx">tokens</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">sb</span><span class="p">.</span><span class="nx">Tokens</span><span class="p">[</span><span class="nx">dir</span><span class="p">]</span><span class="p">;</span> <span class="nx">ok</span> <span class="p">{</span>
               <span class="nx">controller</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Controller</span><span class="p">{</span>
                  <span class="nx">instance</span><span class="p">:</span>  <span class="nx">inst</span><span class="p">,</span>
                  <span class="nx">Key</span><span class="p">:</span>       <span class="nx">key</span><span class="p">,</span>
                  <span class="nx">Dispenser</span><span class="p">:</span> <span class="nx">caddyfile</span><span class="p">.</span><span class="nf">NewDispenserTokens</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span> <span class="nx">tokens</span><span class="p">)</span><span class="p">,</span>
                  <span class="nx">OncePerServerBlock</span><span class="p">:</span> <span class="kd">func</span><span class="p">(</span><span class="nx">f</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
                     <span class="kd">var</span> <span class="nx">err</span> <span class="kt">error</span>
                     <span class="nx">once</span><span class="p">.</span><span class="nf">Do</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
                        <span class="nx">err</span> <span class="p">=</span> <span class="nf">f</span><span class="p">(</span><span class="p">)</span>
                     <span class="p">}</span><span class="p">)</span>
                     <span class="k">return</span> <span class="nx">err</span>
                  <span class="p">}</span><span class="p">,</span>
                  <span class="nx">ServerBlockIndex</span><span class="p">:</span>    <span class="nx">i</span><span class="p">,</span>
                  <span class="nx">ServerBlockKeyIndex</span><span class="p">:</span> <span class="nx">j</span><span class="p">,</span>
                  <span class="nx">ServerBlockKeys</span><span class="p">:</span>     <span class="nx">sb</span><span class="p">.</span><span class="nx">Keys</span><span class="p">,</span>
                  <span class="nx">ServerBlockStorage</span><span class="p">:</span>  <span class="nx">storages</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="p">[</span><span class="nx">dir</span><span class="p">]</span><span class="p">,</span>
               <span class="p">}</span>

               <span class="nx">setup</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">DirectiveAction</span><span class="p">(</span><span class="nx">inst</span><span class="p">.</span><span class="nx">serverType</span><span class="p">,</span> <span class="nx">dir</span><span class="p">)</span>
               <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="nx">err</span>
               <span class="p">}</span>

               <span class="nx">err</span> <span class="p">=</span> <span class="nf">setup</span><span class="p">(</span><span class="nx">controller</span><span class="p">)</span>
               <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="nx">err</span>
               <span class="p">}</span>

               <span class="nx">storages</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="p">[</span><span class="nx">dir</span><span class="p">]</span> <span class="p">=</span> <span class="nx">controller</span><span class="p">.</span><span class="nx">ServerBlockStorage</span> <span class="c1">// persist for this server block
</span><span class="c1"></span>            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">!</span><span class="nx">justValidate</span> <span class="p">{</span>
         <span class="c1">// See if there are any callbacks to execute after this directive
</span><span class="c1"></span>         <span class="k">if</span> <span class="nx">allCallbacks</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">parsingCallbacks</span><span class="p">[</span><span class="nx">inst</span><span class="p">.</span><span class="nx">serverType</span><span class="p">]</span><span class="p">;</span> <span class="nx">ok</span> <span class="p">{</span>
            <span class="nx">callbacks</span> <span class="o">:=</span> <span class="nx">allCallbacks</span><span class="p">[</span><span class="nx">dir</span><span class="p">]</span>
            <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">callback</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">callbacks</span> <span class="p">{</span>
               <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">callback</span><span class="p">(</span><span class="nx">inst</span><span class="p">.</span><span class="nx">context</span><span class="p">)</span><span class="p">;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
                  <span class="k">return</span> <span class="nx">err</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>执行完了 <code>ValidateAndExecuteDirectives</code> 函数，就意味着所有的插件都已经准备完毕，接着调用 <code>MakeServers</code>返回一个服务器列表：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="nx">slist</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">inst</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nf">MakeServers</span><span class="p">(</span><span class="p">)</span>
</code></pre></div><p>我们深入进去会发现，这个方法其实非常简单：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">// MakeServers uses the newly-created siteConfigs to create and return a list of server instances.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">h</span> <span class="o">*</span><span class="nx">dnsContext</span><span class="p">)</span> <span class="nf">MakeServers</span><span class="p">(</span><span class="p">)</span> <span class="p">(</span><span class="p">[</span><span class="p">]</span><span class="nx">caddy</span><span class="p">.</span><span class="nx">Server</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>

   <span class="c1">// Now that all Keys and Directives are parsed and initialized
</span><span class="c1"></span>   <span class="c1">// lets verify that there is no overlap on the zones and addresses to listen for
</span><span class="c1"></span>   <span class="nx">errValid</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nf">validateZonesAndListeningAddresses</span><span class="p">(</span><span class="p">)</span>
   <span class="k">if</span> <span class="nx">errValid</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">errValid</span>
   <span class="p">}</span>

   <span class="c1">// we must map (group) each config to a bind address
</span><span class="c1"></span>   <span class="nx">groups</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">groupConfigsByListenAddr</span><span class="p">(</span><span class="nx">h</span><span class="p">.</span><span class="nx">configs</span><span class="p">)</span>
   <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
   <span class="p">}</span>
   <span class="c1">// then we create a server for each group
</span><span class="c1"></span>   <span class="kd">var</span> <span class="nx">servers</span> <span class="p">[</span><span class="p">]</span><span class="nx">caddy</span><span class="p">.</span><span class="nx">Server</span>
   <span class="k">for</span> <span class="nx">addr</span><span class="p">,</span> <span class="nx">group</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">groups</span> <span class="p">{</span>
      <span class="c1">// switch on addr
</span><span class="c1"></span>      <span class="k">switch</span> <span class="nx">tr</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">parse</span><span class="p">.</span><span class="nf">Transport</span><span class="p">(</span><span class="nx">addr</span><span class="p">)</span><span class="p">;</span> <span class="nx">tr</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nx">transport</span><span class="p">.</span><span class="nx">DNS</span><span class="p">:</span>
         <span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewServer</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">group</span><span class="p">)</span>
         <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
         <span class="p">}</span>
         <span class="nx">servers</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">servers</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>

      <span class="k">case</span> <span class="nx">transport</span><span class="p">.</span><span class="nx">TLS</span><span class="p">:</span>
         <span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewServerTLS</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">group</span><span class="p">)</span>
         <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
         <span class="p">}</span>
         <span class="nx">servers</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">servers</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>

      <span class="k">case</span> <span class="nx">transport</span><span class="p">.</span><span class="nx">GRPC</span><span class="p">:</span>
         <span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewServergRPC</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">group</span><span class="p">)</span>
         <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
         <span class="p">}</span>
         <span class="nx">servers</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">servers</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>

      <span class="k">case</span> <span class="nx">transport</span><span class="p">.</span><span class="nx">HTTPS</span><span class="p">:</span>
         <span class="nx">s</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewServerHTTPS</span><span class="p">(</span><span class="nx">addr</span><span class="p">,</span> <span class="nx">group</span><span class="p">)</span>
         <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
         <span class="p">}</span>
         <span class="nx">servers</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">servers</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
      <span class="p">}</span>

   <span class="p">}</span>

   <span class="k">return</span> <span class="nx">servers</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>首先，它验证是否有端口冲突（同一zone，并且同一端口才算冲突），然后再根据 dnsContext 中的 <code>configs</code>生成不同的 <code>group</code>，根据监听的端口不同被分到不同的 group，最后返回一个 <code>groups</code>，之后遍历该 <code>groups</code>, 然后根据不同的 transport 去启动相应的服务，当前 CoreDNS 支持4种类型的 transport，默认情况下都是 DNS 。</p>
<p>但是，无论哪种 transport 最终都会调用 <code>NewServer</code>：</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">NewServer</span><span class="p">(</span><span class="nx">addr</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">group</span> <span class="p">[</span><span class="p">]</span><span class="o">*</span><span class="nx">Config</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Server</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>

   <span class="nx">s</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">Server</span><span class="p">{</span>
      <span class="nx">Addr</span><span class="p">:</span>         <span class="nx">addr</span><span class="p">,</span>
      <span class="nx">zones</span><span class="p">:</span>        <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">Config</span><span class="p">)</span><span class="p">,</span>
      <span class="nx">graceTimeout</span><span class="p">:</span> <span class="mi">5</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
   <span class="p">}</span>
   <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">site</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">group</span> <span class="p">{</span>
      
      <span class="nx">s</span><span class="p">.</span><span class="nx">zones</span><span class="p">[</span><span class="nx">site</span><span class="p">.</span><span class="nx">Zone</span><span class="p">]</span> <span class="p">=</span> <span class="nx">site</span>

      <span class="c1">// compile custom plugin for everything
</span><span class="c1"></span>      <span class="kd">var</span> <span class="nx">stack</span> <span class="nx">plugin</span><span class="p">.</span><span class="nx">Handler</span>
      <span class="k">for</span> <span class="nx">i</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="nx">site</span><span class="p">.</span><span class="nx">Plugin</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">--</span> <span class="p">{</span>
         <span class="nx">stack</span> <span class="p">=</span> <span class="nx">site</span><span class="p">.</span><span class="nx">Plugin</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="p">(</span><span class="nx">stack</span><span class="p">)</span>

         <span class="c1">// register the *handler* also
</span><span class="c1"></span>         <span class="nx">site</span><span class="p">.</span><span class="nf">registerHandler</span><span class="p">(</span><span class="nx">stack</span><span class="p">)</span>

         <span class="k">if</span> <span class="nx">s</span><span class="p">.</span><span class="nx">trace</span> <span class="o">==</span> <span class="kc">nil</span> <span class="o">&amp;&amp;</span> <span class="nx">stack</span><span class="p">.</span><span class="nf">Name</span><span class="p">(</span><span class="p">)</span> <span class="o">==</span> <span class="s">&#34;trace&#34;</span> <span class="p">{</span>
            <span class="c1">// we have to stash away the plugin, not the
</span><span class="c1"></span>            <span class="c1">// Tracer object, because the Tracer won&#39;t be initialized yet
</span><span class="c1"></span>            <span class="k">if</span> <span class="nx">t</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">stack</span><span class="p">.</span><span class="p">(</span><span class="nx">trace</span><span class="p">.</span><span class="nx">Trace</span><span class="p">)</span><span class="p">;</span> <span class="nx">ok</span> <span class="p">{</span>
               <span class="nx">s</span><span class="p">.</span><span class="nx">trace</span> <span class="p">=</span> <span class="nx">t</span>
            <span class="p">}</span>
         <span class="p">}</span>
         <span class="c1">// Unblock CH class queries when any of these plugins are loaded.
</span><span class="c1"></span>         <span class="k">if</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">EnableChaos</span><span class="p">[</span><span class="nx">stack</span><span class="p">.</span><span class="nf">Name</span><span class="p">(</span><span class="p">)</span><span class="p">]</span><span class="p">;</span> <span class="nx">ok</span> <span class="p">{</span>
            <span class="nx">s</span><span class="p">.</span><span class="nx">classChaos</span> <span class="p">=</span> <span class="kc">true</span>
         <span class="p">}</span>
      <span class="p">}</span>
      <span class="nx">site</span><span class="p">.</span><span class="nx">pluginChain</span> <span class="p">=</span> <span class="nx">stack</span>
   <span class="p">}</span>

   <span class="k">return</span> <span class="nx">s</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>由于代码过长，只看重点部分，先创建了一个 <code>Server</code> 变量，然后遍历 group ，并将每个 site 对应的 plugins 以栈的形式组成  <code>pluginChain</code>，最后返回。</p>
<p>上面只是make了CoreDNS需要启动的<code>Server</code>结构,但是真正的服务进程到现在这个阶段还没有真正的启动。当所有的 plugin 需要的准备工作都处理完成之后，就调用<code>startServers</code>来启动CoreDNS服务,<code>startServers</code>函数的定义如下:</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">startServers</span><span class="p">(</span><span class="nx">serverList</span> <span class="p">[</span><span class="p">]</span><span class="nx">Server</span><span class="p">,</span> <span class="nx">inst</span> <span class="o">*</span><span class="nx">Instance</span><span class="p">,</span> <span class="nx">restartFds</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="nx">restartTriple</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
   <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">s</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">serverList</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="p">(</span>
         <span class="nx">ln</span>  <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span>
         <span class="nx">pc</span>  <span class="nx">net</span><span class="p">.</span><span class="nx">PacketConn</span>
         <span class="nx">err</span> <span class="kt">error</span>
      <span class="p">)</span>

 			<span class="o">...</span><span class="o">...</span>
      <span class="o">...</span><span class="o">...</span>
      <span class="k">if</span> <span class="nx">ln</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
         <span class="nx">ln</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">Listen</span><span class="p">(</span><span class="p">)</span>
         <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;Listen: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
         <span class="p">}</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="nx">pc</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
         <span class="nx">pc</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">s</span><span class="p">.</span><span class="nf">ListenPacket</span><span class="p">(</span><span class="p">)</span>
         <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nf">Errorf</span><span class="p">(</span><span class="s">&#34;ListenPacket: %v&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
         <span class="p">}</span>
      <span class="p">}</span>

      <span class="nx">inst</span><span class="p">.</span><span class="nx">servers</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">inst</span><span class="p">.</span><span class="nx">servers</span><span class="p">,</span> <span class="nx">ServerListener</span><span class="p">{</span><span class="nx">server</span><span class="p">:</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">listener</span><span class="p">:</span> <span class="nx">ln</span><span class="p">,</span> <span class="nx">packet</span><span class="p">:</span> <span class="nx">pc</span><span class="p">}</span><span class="p">)</span>
   <span class="p">}</span>

   <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">s</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">inst</span><span class="p">.</span><span class="nx">servers</span> <span class="p">{</span>
      <span class="nx">inst</span><span class="p">.</span><span class="nx">wg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
      <span class="nx">stopWg</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
      <span class="kd">func</span><span class="p">(</span><span class="nx">s</span> <span class="nx">Server</span><span class="p">,</span> <span class="nx">ln</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">,</span> <span class="nx">pc</span> <span class="nx">net</span><span class="p">.</span><span class="nx">PacketConn</span><span class="p">,</span> <span class="nx">inst</span> <span class="o">*</span><span class="nx">Instance</span><span class="p">)</span> <span class="p">{</span>
         <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">defer</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">inst</span><span class="p">.</span><span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">(</span><span class="p">)</span>
               <span class="nx">stopWg</span><span class="p">.</span><span class="nf">Done</span><span class="p">(</span><span class="p">)</span>
            <span class="p">}</span><span class="p">(</span><span class="p">)</span>
            <span class="nx">errChan</span> <span class="o">&lt;-</span> <span class="nx">s</span><span class="p">.</span><span class="nf">Serve</span><span class="p">(</span><span class="nx">ln</span><span class="p">)</span>
         <span class="p">}</span><span class="p">(</span><span class="p">)</span>

         <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">defer</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
               <span class="nx">inst</span><span class="p">.</span><span class="nx">wg</span><span class="p">.</span><span class="nf">Done</span><span class="p">(</span><span class="p">)</span>
               <span class="nx">stopWg</span><span class="p">.</span><span class="nf">Done</span><span class="p">(</span><span class="p">)</span>
            <span class="p">}</span><span class="p">(</span><span class="p">)</span>
            <span class="nx">errChan</span> <span class="o">&lt;-</span> <span class="nx">s</span><span class="p">.</span><span class="nf">ServePacket</span><span class="p">(</span><span class="nx">pc</span><span class="p">)</span>
         <span class="p">}</span><span class="p">(</span><span class="p">)</span>
      <span class="p">}</span><span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">server</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">listener</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">packet</span><span class="p">,</span> <span class="nx">inst</span><span class="p">)</span>
   <span class="p">}</span>

   <span class="c1">// Log errors that may be returned from Serve() calls,
</span><span class="c1"></span>   <span class="c1">// these errors should only be occurring in the server loop.
</span><span class="c1"></span>   <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">for</span> <span class="p">{</span>
         <span class="k">select</span> <span class="p">{</span>
         <span class="k">case</span> <span class="nx">err</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">errChan</span><span class="p">:</span>
            <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
               <span class="k">if</span> <span class="p">!</span><span class="nx">strings</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="s">&#34;use of closed network connection&#34;</span><span class="p">)</span> <span class="p">{</span>
                  <span class="c1">// this error is normal when closing the listener; see https://github.com/golang/go/issues/4373
</span><span class="c1"></span>                  <span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
               <span class="p">}</span>
            <span class="p">}</span>
         <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">stopChan</span><span class="p">:</span>
            <span class="k">return</span>
         <span class="p">}</span>
      <span class="p">}</span>
   <span class="p">}</span><span class="p">(</span><span class="p">)</span>

   <span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">stopWg</span><span class="p">.</span><span class="nf">Wait</span><span class="p">(</span><span class="p">)</span>
      <span class="nx">stopChan</span> <span class="o">&lt;-</span> <span class="kd">struct</span><span class="p">{</span><span class="p">}</span><span class="p">{</span><span class="p">}</span>
   <span class="p">}</span><span class="p">(</span><span class="p">)</span>

   <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>


<span class="c1">// Serve starts the server with an existing listener. It blocks until the server stops.
</span><span class="c1"></span><span class="c1">// This implements caddy.TCPServer interface.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">Serve</span><span class="p">(</span><span class="nx">l</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">Lock</span><span class="p">(</span><span class="p">)</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">server</span><span class="p">[</span><span class="nx">tcp</span><span class="p">]</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">dns</span><span class="p">.</span><span class="nx">Server</span><span class="p">{</span><span class="nx">Listener</span><span class="p">:</span> <span class="nx">l</span><span class="p">,</span> <span class="nx">Net</span><span class="p">:</span> <span class="s">&#34;tcp&#34;</span><span class="p">,</span> <span class="nx">Handler</span><span class="p">:</span> <span class="nx">dns</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">dns</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">dns</span><span class="p">.</span><span class="nx">Msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithValue</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="nx">Key</span><span class="p">{</span><span class="p">}</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
		<span class="nx">s</span><span class="p">.</span><span class="nf">ServeDNS</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
	<span class="p">}</span><span class="p">)</span><span class="p">}</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">(</span><span class="p">)</span>

	<span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">server</span><span class="p">[</span><span class="nx">tcp</span><span class="p">]</span><span class="p">.</span><span class="nf">ActivateAndServe</span><span class="p">(</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// ServePacket starts the server with an existing packetconn. It blocks until the server stops.
</span><span class="c1"></span><span class="c1">// This implements caddy.UDPServer interface.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">s</span> <span class="o">*</span><span class="nx">Server</span><span class="p">)</span> <span class="nf">ServePacket</span><span class="p">(</span><span class="nx">p</span> <span class="nx">net</span><span class="p">.</span><span class="nx">PacketConn</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">Lock</span><span class="p">(</span><span class="p">)</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">server</span><span class="p">[</span><span class="nx">udp</span><span class="p">]</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">dns</span><span class="p">.</span><span class="nx">Server</span><span class="p">{</span><span class="nx">PacketConn</span><span class="p">:</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">Net</span><span class="p">:</span> <span class="s">&#34;udp&#34;</span><span class="p">,</span> <span class="nx">Handler</span><span class="p">:</span> <span class="nx">dns</span><span class="p">.</span><span class="nf">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">dns</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">dns</span><span class="p">.</span><span class="nx">Msg</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">ctx</span> <span class="o">:=</span> <span class="nx">context</span><span class="p">.</span><span class="nf">WithValue</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nf">Background</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="nx">Key</span><span class="p">{</span><span class="p">}</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
		<span class="nx">s</span><span class="p">.</span><span class="nf">ServeDNS</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">w</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
	<span class="p">}</span><span class="p">)</span><span class="p">}</span>
	<span class="nx">s</span><span class="p">.</span><span class="nx">m</span><span class="p">.</span><span class="nf">Unlock</span><span class="p">(</span><span class="p">)</span>

	<span class="k">return</span> <span class="nx">s</span><span class="p">.</span><span class="nx">server</span><span class="p">[</span><span class="nx">udp</span><span class="p">]</span><span class="p">.</span><span class="nf">ActivateAndServe</span><span class="p">(</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>同样省略部分代码，首先遍历 serverList ，并且生成 <code>inst.servers</code> 列表，然后再遍历 <code>inst.servers</code> 列表，启动协程分别监听 TCP 和 UDP，并且分别调用各自内部的 ServeDNS 来进行服务。</p>
<p>走到这里，启动流程算是彻底走完了。</p>
<h5 id="总结">总结</h5>
<p>CoreDNS 代码的结构非常清晰，通过初始化时加载自定义的插件顺序，依次注入到 caddy 中去，并在执行的时候，按照定义的插件顺序依次执行，形成一个链式的调用结构。CoreDNS 同样还支持多种协议供使用者选择，这是一个非常好的实现。</p>
<p><strong>参考</strong>：</p>
<ol>
<li><a href="https://xigang.github.io/2019/08/25/coredns/">CoreDNS源码分析</a></li>
<li><a href="https://juejin.im/post/5d11d262e51d4556f76e80ca">CoreDNS源码分析</a></li>
</ol>
]]></content>
		</item>
		
		<item>
			<title>如何设计与实现WebCosole</title>
			<link>https://wangzeping722.github.io/posts/how-to-write-webconsole/</link>
			<pubDate>Wed, 04 Dec 2019 09:13:51 +0800</pubDate>
			
			<guid>https://wangzeping722.github.io/posts/how-to-write-webconsole/</guid>
			<description>1. 调研 前端：了解到有一个非常优秀的开源web终端库： xterm.js , 使用起来也比较简单。 后端：使用 go 语言实现，因为 go 语言拥有许多优秀的开源ssh库，能够</description>
			<content type="html"><![CDATA[<h3 id="1-调研">1. 调研</h3>
<p>前端：了解到有一个非常优秀的开源web终端库： <strong>xterm.js</strong> , 使用起来也比较简单。</p>
<p>后端：使用 go 语言实现，因为 go 语言拥有许多优秀的开源ssh库，能够满足我们的需求。</p>
<p>难点：</p>
<pre><code>1. 如何与 cf(cloud foundry) 进行交互得到 `ssh code` ？
2. 如何把 ssh 命令行转换成 websocket 通讯, 并输出到 xterm.js 中？
3. 如何控制访问权限？
</code></pre>
<h3 id="2-原理">2. 原理</h3>
<p><img src="webconsole1.png" alt="webconsole原理图"></p>
<p>​	1. 浏览器向服务器发起 websocket 请求</p>
<p>​	2. 服务器通过 ssh 连接到 cf 容器</p>
<p>​	3. 连接建立，服务器负责转发消息</p>
<p>在后端和浏览器之间建立websocket连接后，将用户在浏览器中输入的命令通过 websocket 协议发送到后端，后端使用 ssh 协议将命令输入到容器ssh进程的 stdin，命令执行后，再从 stdout 中读取输出，通过websocket协议返回浏览器显示给用户，达到交互的目的。</p>
<h3 id="3-问题解决以及服务端实现">3. 问题解决以及服务端实现</h3>
<p>在前两个步骤中，我已经通过分析把原理和难点梳理清楚了，目前就需要着手解决这些问题。</p>
<h4 id="31-如何获取-ssh-code">3.1 如何获取 ssh code</h4>
<p>cf 有一个自带的命令 <code>cf ssh-code</code> 能够获取连接到容器用的 <code>ssh code</code>，但是我并没有在 cf 开源的 go 语言客户端 <code>cfclient</code> 中发现相关的 API，所以我去查看了 cf cli 的源码，并在里面发现了 <strong>cc</strong> 暴露出来的接口，有了这个接口之后，就能够通过 http 请求的方式获取 <code>ssh-code</code>。由于 <code>cfclient</code> 中并没有相关的代码，所以不得不自己实现一些方来获取 <code>ssh-code</code>, 于是这个问题解决了。</p>
<h4 id="32-如何将-websocket-和-ssh-这两个协议的消息进行转换">3.2 如何将 websocket 和 ssh 这两个协议的消息进行转换</h4>
<p><strong>连接建立</strong>：</p>
<p><img src="webconsole2.png" alt=""></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">WS</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// 初始化websocket连接
</span><span class="c1"></span>	<span class="nx">upgrader</span> <span class="o">:=</span> <span class="nx">websocket</span><span class="p">.</span><span class="nx">Upgrader</span><span class="p">{</span>
		<span class="nx">ReadBufferSize</span><span class="p">:</span>  <span class="mi">1024</span><span class="p">,</span>
		<span class="nx">WriteBufferSize</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="nx">ws</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">upgrader</span><span class="p">.</span><span class="nf">Upgrade</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Writer</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
	<span class="k">defer</span> <span class="nx">ws</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="p">)</span>
  
	<span class="c1">// 初始化ssh连接
</span><span class="c1"></span>	<span class="nx">cl</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;claims&#34;</span><span class="p">)</span>
	<span class="nx">s</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;session&#34;</span><span class="p">)</span>
	<span class="nx">claims</span> <span class="o">:=</span> <span class="nx">cl</span><span class="p">.</span><span class="p">(</span><span class="o">*</span><span class="nx">utils</span><span class="p">.</span><span class="nx">Claims</span><span class="p">)</span>
	<span class="nx">session</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="p">(</span><span class="o">*</span><span class="nx">utils</span><span class="p">.</span><span class="nx">Session</span><span class="p">)</span>

	<span class="nx">sshShell</span> <span class="o">:=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">SSHShellSession</span><span class="p">{</span>
		<span class="nx">Node</span><span class="p">:</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">Node</span><span class="p">{</span>
			<span class="nx">Host</span><span class="p">:</span> <span class="nx">claims</span><span class="p">.</span><span class="nx">Host</span><span class="p">,</span>
			<span class="nx">Port</span><span class="p">:</span> <span class="nx">claims</span><span class="p">.</span><span class="nx">Port</span><span class="p">,</span>
		<span class="p">}</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="kd">var</span> <span class="nx">wsBuff</span> <span class="nx">WebSocketBufferWriter</span>
	<span class="nx">sshShell</span><span class="p">.</span><span class="nx">StdoutPipe</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">wsBuff</span>
	<span class="nx">err</span> <span class="p">=</span> <span class="nx">sshConn</span><span class="p">.</span><span class="nf">Connect</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span>
	<span class="k">defer</span> <span class="nx">sshConn</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="p">)</span>
	<span class="k">defer</span> <span class="nx">wsBuff</span><span class="p">.</span><span class="nf">Flush</span><span class="p">(</span><span class="nx">websocket</span><span class="p">.</span><span class="nx">TextMessage</span><span class="p">,</span> <span class="nx">ws</span><span class="p">)</span>
	<span class="o">...</span><span class="o">...</span>
  <span class="o">...</span><span class="o">...</span>
<span class="p">}</span>
</code></pre></div><p><strong>连接保持：</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">WS</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
  <span class="o">...</span><span class="o">...</span>
  <span class="o">...</span><span class="o">...</span>
	<span class="nx">done</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
	<span class="nx">setDone</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span> <span class="nx">done</span> <span class="o">&lt;-</span> <span class="kc">true</span> <span class="p">}</span>

	<span class="c1">// 数据转换：websocket ----&gt; SSH
</span><span class="c1"></span>	<span class="nx">writeMessageToSSHServer</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">wc</span> <span class="nx">io</span><span class="p">.</span><span class="nx">WriteCloser</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">defer</span> <span class="nf">setDone</span><span class="p">(</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">{</span>
			<span class="c1">// 从websocket读取数据
</span><span class="c1"></span>			<span class="nx">msgType</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ws</span><span class="p">.</span><span class="nf">ReadMessage</span><span class="p">(</span><span class="p">)</span>

			<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">DispatchMessage</span><span class="p">(</span><span class="nx">sshShell</span><span class="p">.</span><span class="nx">Session</span><span class="p">,</span> <span class="nx">msgType</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">wc</span><span class="p">)</span><span class="p">;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Error: error write data to ssh server:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
				<span class="k">return</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="nx">stopper</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span>
	<span class="c1">// 数据转换：SSH ----&gt; websocket
</span><span class="c1"></span>	<span class="nx">writeBufferToWebSocket</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">defer</span> <span class="nf">setDone</span><span class="p">(</span><span class="p">)</span>
		<span class="nx">tick</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTicker</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">utils</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">SSH</span><span class="p">.</span><span class="nx">BufferCheckerCycleTime</span><span class="p">)</span><span class="p">)</span>
		<span class="k">defer</span> <span class="nx">tick</span><span class="p">.</span><span class="nf">Stop</span><span class="p">(</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">{</span>
			<span class="k">select</span> <span class="p">{</span>
			<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">tick</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
				<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">wsBuff</span><span class="p">.</span><span class="nf">Flush</span><span class="p">(</span><span class="nx">websocket</span><span class="p">.</span><span class="nx">TextMessage</span><span class="p">,</span> <span class="nx">ws</span><span class="p">)</span><span class="p">;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
					<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Error: error sending data via webSocket:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
					<span class="k">return</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">stopper</span><span class="p">:</span>
				<span class="k">return</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">go</span> <span class="nf">writeMessageToSSHServer</span><span class="p">(</span><span class="nx">sshShell</span><span class="p">.</span><span class="nx">StdinPipe</span><span class="p">)</span>
	<span class="k">go</span> <span class="nf">writeBufferToWebSocket</span><span class="p">(</span><span class="p">)</span>
	<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">defer</span> <span class="nf">setDone</span><span class="p">(</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sshShell</span><span class="p">.</span><span class="nx">Session</span><span class="p">.</span><span class="nf">Wait</span><span class="p">(</span><span class="p">)</span><span class="p">;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;ssh exist from server&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span><span class="p">(</span><span class="p">)</span>

	<span class="o">&lt;-</span><span class="nx">done</span>
	<span class="nx">stopper</span> <span class="o">&lt;-</span> <span class="kc">true</span> 
	<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Info: websocket finished!&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p><strong>控制访问权限</strong>：</p>
<p>利用 cf 自带的权限认证机制实现。</p>
]]></content>
		</item>
		
	</channel>
</rss>
