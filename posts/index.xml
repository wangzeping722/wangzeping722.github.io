<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
	<channel>
		<title>Posts on ç»™æˆ‘ä¸€æ¡é±¼ğŸŸ</title>
		<link>https://wangzeping722.github.io/posts/</link>
		<description>Recent content in Posts on ç»™æˆ‘ä¸€æ¡é±¼ğŸŸ</description>
		<generator>Hugo -- gohugo.io</generator>
		<language>zh</language>
		<copyright>This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.</copyright>
		<lastBuildDate>Mon, 05 Oct 2020 11:42:50 +0800</lastBuildDate>
		<atom:link href="https://wangzeping722.github.io/posts/index.xml" rel="self" type="application/rss+xml" />
		
		<item>
			<title>Kratos æ¡†æ¶å­¦ä¹ â€”â€”å¯åŠ¨æµç¨‹åˆ†æ</title>
			<link>https://wangzeping722.github.io/posts/bilibili-kratos-1/</link>
			<pubDate>Mon, 05 Oct 2020 11:42:50 +0800</pubDate>
			
			<guid>https://wangzeping722.github.io/posts/bilibili-kratos-1/</guid>
			<description>Kratos æ˜¯ b ç«™å¼€æºçš„å¾®æœåŠ¡æ¡†æ¶ï¼ŒåŒ…å«å¤§é‡å¾®æœåŠ¡ç›¸å…³æ¡†æ¶åŠå·¥å…·ï¼ŒåŒæ—¶æ•´å¥—Kratosæ¡†æ¶ä¹Ÿæ˜¯ä¸é”™çš„å­¦ä¹ ä»“åº“ï¼Œè¿™ä¸ªç³»åˆ—çš„æ–‡ç« å°†ä¼šå¯¹ Kratos çš„æºç è¿›è¡Œå­¦ä¹ å’Œåˆ†</description>
			<content type="html"><![CDATA[<p>Kratos æ˜¯ b ç«™å¼€æºçš„å¾®æœåŠ¡æ¡†æ¶ï¼ŒåŒ…å«å¤§é‡å¾®æœåŠ¡ç›¸å…³æ¡†æ¶åŠå·¥å…·ï¼ŒåŒæ—¶æ•´å¥—Kratosæ¡†æ¶ä¹Ÿæ˜¯ä¸é”™çš„å­¦ä¹ ä»“åº“ï¼Œè¿™ä¸ªç³»åˆ—çš„æ–‡ç« å°†ä¼šå¯¹ Kratos çš„æºç è¿›è¡Œå­¦ä¹ å’Œåˆ†æã€‚</p>
<p>å¦‚ä½•å®‰è£…å’Œä½¿ç”¨ kratos æ¡†æ¶å°±ä¸åœ¨æœ¬æ–‡è¯¦ç»†æè¿°ï¼Œè¯·å‚è€ƒï¼š<a href="https://go-kratos.github.io/kratos/#/quickstart">go-kratos</a></p>
<h2 id="å‰–æ-demo-å¯åŠ¨æµç¨‹">å‰–æ demo å¯åŠ¨æµç¨‹</h2>
<p>é€šè¿‡ wiki ä¸­çš„æŒ‡ç¤ºï¼Œæˆ‘ä»¬ç”Ÿæˆäº†ä¸€ä¸ª <strong>kratos-demo</strong> çš„é¡¹ç›®ï¼Œç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p>
<pre><code>â”œâ”€â”€ CHANGELOG.md 
â”œâ”€â”€ OWNERS
â”œâ”€â”€ README.md
â”œâ”€â”€ api                     # apiç›®å½•ä¸ºå¯¹å¤–ä¿ç•™çš„protoæ–‡ä»¶åŠç”Ÿæˆçš„pb.goæ–‡ä»¶
â”‚   â”œâ”€â”€ api.bm.go
â”‚   â”œâ”€â”€ api.pb.go           # é€šè¿‡go generateç”Ÿæˆçš„pb.goæ–‡ä»¶
â”‚   â”œâ”€â”€ api.proto
â”‚   â””â”€â”€ client.go
â”œâ”€â”€ cmd
â”‚   â””â”€â”€ main.go             # cmdç›®å½•ä¸ºmainæ‰€åœ¨
â”œâ”€â”€ configs                 # configsä¸ºé…ç½®æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ application.toml    # åº”ç”¨çš„è‡ªå®šä¹‰é…ç½®æ–‡ä»¶ï¼Œå¯èƒ½æ˜¯ä¸€äº›ä¸šåŠ¡å¼€å…³å¦‚ï¼šuseABtest = true
â”‚   â”œâ”€â”€ db.toml             # dbç›¸å…³é…ç½®
â”‚   â”œâ”€â”€ grpc.toml           # grpcç›¸å…³é…ç½®
â”‚   â”œâ”€â”€ http.toml           # httpç›¸å…³é…ç½®
â”‚   â”œâ”€â”€ memcache.toml       # memcacheç›¸å…³é…ç½®
â”‚   â””â”€â”€ redis.toml          # redisç›¸å…³é…ç½®
â”œâ”€â”€ go.mod
â”œâ”€â”€ go.sum
â””â”€â”€ internal                # internalä¸ºé¡¹ç›®å†…éƒ¨åŒ…ï¼ŒåŒ…æ‹¬ä»¥ä¸‹ç›®å½•ï¼š
â”‚   â”œâ”€â”€ dao                 # daoå±‚ï¼Œç”¨äºæ•°æ®åº“ã€cacheã€MQã€ä¾èµ–æŸä¸šåŠ¡grpc|httpç­‰èµ„æºè®¿é—®
â”‚   â”‚   â”œâ”€â”€ dao.bts.go
â”‚   â”‚   â”œâ”€â”€ dao.go
â”‚   â”‚   â”œâ”€â”€ db.go
â”‚   â”‚   â”œâ”€â”€ mc.cache.go
â”‚   â”‚   â”œâ”€â”€ mc.go
â”‚   â”‚   â””â”€â”€ redis.go
â”‚   â”œâ”€â”€ di                  # ä¾èµ–æ³¨å…¥å±‚ é‡‡ç”¨wireé™æ€åˆ†æä¾èµ–
â”‚   â”‚   â”œâ”€â”€ app.go
â”‚   â”‚   â”œâ”€â”€ wire.go         # wire å£°æ˜
â”‚   â”‚   â””â”€â”€ wire_gen.go     # go generate ç”Ÿæˆçš„ä»£ç 
â”‚   â”œâ”€â”€ model               # modelå±‚ï¼Œç”¨äºå£°æ˜ä¸šåŠ¡ç»“æ„ä½“
â”‚   â”‚   â””â”€â”€ model.go
â”‚   â”œâ”€â”€ server              # serverå±‚ï¼Œç”¨äºåˆå§‹åŒ–grpcå’Œhttp server
â”‚   â”‚   â”œâ”€â”€ grpc            # grpcå±‚ï¼Œç”¨äºåˆå§‹åŒ–grpc serverå’Œå®šä¹‰method
â”‚   â”‚   â”‚   â””â”€â”€ server.go
â”‚   â”‚   â””â”€â”€ http            # httpå±‚ï¼Œç”¨äºåˆå§‹åŒ–http serverå’Œå£°æ˜handler
â”‚   â”‚       â””â”€â”€ server.go
â”‚   â””â”€â”€ service             # serviceå±‚ï¼Œç”¨äºä¸šåŠ¡é€»è¾‘å¤„ç†ï¼Œä¸”ä¸ºæ–¹ä¾¿httpå’Œgrpcå…±ç”¨æ–¹æ³•ï¼Œå»ºè®®å…¥å‚å’Œå‡ºå‚ä¿æŒgrpcé£æ ¼ï¼Œä¸”ä½¿ç”¨pbæ–‡ä»¶ç”Ÿæˆä»£ç 
â”‚       â””â”€â”€ service.go
â””â”€â”€ test                    # æµ‹è¯•èµ„æºå±‚ ç”¨äºå­˜æ”¾æµ‹è¯•ç›¸å…³èµ„æºæ•°æ® å¦‚docker-composeé…ç½® æ•°æ®åº“åˆå§‹åŒ–è¯­å¥ç­‰
    â””â”€â”€ docker-compose.yaml
</code></pre><p>ä¸éš¾çœ‹å‡ºï¼Œ<code>cmd/main.go</code> ä¾¿æ˜¯ç¨‹åºçš„å…¥å£ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ <code>cmd/main.go</code> çš„ä»£ç ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">main</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">flag</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="p">)</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Init</span><span class="p">(</span><span class="kc">nil</span><span class="p">)</span> <span class="c1">// debug flag: log.dir={path}
</span><span class="c1"></span>	<span class="k">defer</span> <span class="nx">log</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="p">)</span>
	<span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;kratos-demo start&#34;</span><span class="p">)</span>
	<span class="nx">paladin</span><span class="p">.</span><span class="nf">Init</span><span class="p">(</span><span class="p">)</span> <span class="c1">// é…ç½®æ–‡ä»¶åˆå§‹åŒ–
</span><span class="c1"></span>	<span class="nx">_</span><span class="p">,</span> <span class="nx">closeFunc</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">di</span><span class="p">.</span><span class="nf">InitApp</span><span class="p">(</span><span class="p">)</span>	<span class="c1">// åˆå§‹åŒ– App(),å¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªå¾®æœåŠ¡çš„å®ä½“å¯¹è±¡, åˆ©ç”¨ç¼–è¯‘æœŸä¾èµ–æ³¨å…¥,æ¥åˆå§‹åŒ– app ä¸­çš„å„ä¸ªç»„ä»¶
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="nx">c</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>	<span class="c1">// å®ç°ä¼˜é›…çš„é€€å‡º
</span><span class="c1"></span>	<span class="nx">signal</span><span class="p">.</span><span class="nf">Notify</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGHUP</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGQUIT</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGTERM</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGINT</span><span class="p">)</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="nx">s</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">c</span>
		<span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;get a signal %s&#34;</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nf">String</span><span class="p">(</span><span class="p">)</span><span class="p">)</span>
		<span class="k">switch</span> <span class="nx">s</span> <span class="p">{</span>
		<span class="k">case</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGQUIT</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGTERM</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGINT</span><span class="p">:</span>
			<span class="nf">closeFunc</span><span class="p">(</span><span class="p">)</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Info</span><span class="p">(</span><span class="s">&#34;kratos-demo exit&#34;</span><span class="p">)</span>
			<span class="nx">time</span><span class="p">.</span><span class="nf">Sleep</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
			<span class="k">return</span>
		<span class="k">case</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGHUP</span><span class="p">:</span>
		<span class="k">default</span><span class="p">:</span>
			<span class="k">return</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>æ•´ä¸ªæµç¨‹æ˜¯éå¸¸çš„æ¸…æ¥šï¼š</p>
<ol>
<li>åˆå§‹åŒ–æ—¥å¿—ï¼›</li>
<li>åˆå§‹åŒ–é…ç½®ï¼›</li>
<li>åˆå§‹åŒ– Appï¼ˆè°ƒç”¨ç¼–è¯‘æœŸä¾èµ–æ³¨å…¥ç”Ÿæˆçš„æ–¹æ³• NewAppï¼‰ï¼Œè¿™ä¸€æ­¥ä¹‹åå°±èƒ½å¤Ÿå¯¹å¤–æä¾›æœåŠ¡äº†ï¼›</li>
<li>æœ€åå®ç°äº†ä¼˜é›…çš„å…³é—­å’Œé‡å¯ã€‚</li>
</ol>
<h2 id="ç¼–è¯‘æœŸä¾èµ–æ³¨å…¥">ç¼–è¯‘æœŸä¾èµ–æ³¨å…¥</h2>
<p>Kratos æ¡†æ¶ä½¿ç”¨ <a href="https://github.com/google/wire">wire</a> è¿›è¡Œç¼–è¯‘æœŸä¾èµ–æ³¨å…¥ï¼Œä½¿å¾—å„ä¸ªæ¨¡å—ä¹‹é—´ä¿æŒä½è€¦åˆã€‚å¦‚ä½•ä½¿ç”¨ wireï¼Œæœ¬æ–‡ä¸åšè¯´æ˜ï¼Œä¸‹é¢ç›´æ¥çœ‹ demo æ˜¯å¦‚ä½•ä½¿ç”¨è¿™ä¸ªæŠ€æœ¯çš„ã€‚</p>
<p><code>di.InitApp()</code> å°±æ˜¯åˆ©ç”¨ç¼–è¯‘æœŸæ³¨å…¥ç”Ÿæˆçš„å‡½æ•°ï¼Œè€Œè¿™ä¸ªå‡½æ•°çš„ç›®çš„å°±æ˜¯ç»„åˆåˆå§‹åŒ– <code>App</code> æ‰€éœ€è¦çš„ä¸€åˆ‡èµ„æºï¼Œåˆå§‹åŒ–å¹¶è¿”å› <code>App</code> å¯¹è±¡ã€‚</p>
<p>é¦–å…ˆæˆ‘ä»¬å¯ä»¥çœ‹è§åœ¨ <code>internal/dao/dao.go</code> å’Œ <code>internal/service/service.go</code> æ–‡ä»¶ä¸­å„çœ‹è§ä¸€ä¸ª Providerï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">var</span> <span class="nx">Provider</span> <span class="p">=</span> <span class="nx">wire</span><span class="p">.</span><span class="nf">NewSet</span><span class="p">(</span><span class="nx">New</span><span class="p">,</span> <span class="nx">NewDB</span><span class="p">,</span> <span class="nx">NewRedis</span><span class="p">,</span> <span class="nx">NewMC</span><span class="p">)</span>
<span class="kd">var</span> <span class="nx">Provider</span> <span class="p">=</span> <span class="nx">wire</span><span class="p">.</span><span class="nf">NewSet</span><span class="p">(</span><span class="nx">New</span><span class="p">,</span> <span class="nx">wire</span><span class="p">.</span><span class="nf">Bind</span><span class="p">(</span><span class="nb">new</span><span class="p">(</span><span class="nx">pb</span><span class="p">.</span><span class="nx">DemoServer</span><span class="p">)</span><span class="p">,</span> <span class="nb">new</span><span class="p">(</span><span class="o">*</span><span class="nx">Service</span><span class="p">)</span><span class="p">)</span><span class="p">)</span>
</code></pre></div><p>åœ¨ <code>internal/di/wire.go</code> æˆ‘ä»¬åˆçœ‹è§äº†ä¸‹é¢è¿™æ®µä»£ç ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="c1">//go:generate kratos t wire
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">InitApp</span><span class="p">(</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">App</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nb">panic</span><span class="p">(</span><span class="nx">wire</span><span class="p">.</span><span class="nf">Build</span><span class="p">(</span><span class="nx">dao</span><span class="p">.</span><span class="nx">Provider</span><span class="p">,</span> <span class="nx">service</span><span class="p">.</span><span class="nx">Provider</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">New</span><span class="p">,</span> <span class="nx">grpc</span><span class="p">.</span><span class="nx">New</span><span class="p">,</span> <span class="nx">NewApp</span><span class="p">)</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p>æ³¨æ„ï¼Œæˆ‘ä»¬çœ‹è§äº†ä¼šä½¿ç”¨<code>go:generate kratos t wire</code>è¿™æ®µç”Ÿæˆå‘½ä»¤æ¥ç”Ÿæˆä»£ç </p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">InitApp</span><span class="p">(</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">App</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">redis</span><span class="p">,</span> <span class="nx">cleanup</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dao</span><span class="p">.</span><span class="nf">NewRedis</span><span class="p">(</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">memcache</span><span class="p">,</span> <span class="nx">cleanup2</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dao</span><span class="p">.</span><span class="nf">NewMC</span><span class="p">(</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">cleanup</span><span class="p">(</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">db</span><span class="p">,</span> <span class="nx">cleanup3</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dao</span><span class="p">.</span><span class="nf">NewDB</span><span class="p">(</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">cleanup2</span><span class="p">(</span><span class="p">)</span>
		<span class="nf">cleanup</span><span class="p">(</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">daoDao</span><span class="p">,</span> <span class="nx">cleanup4</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">dao</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">redis</span><span class="p">,</span> <span class="nx">memcache</span><span class="p">,</span> <span class="nx">db</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">cleanup3</span><span class="p">(</span><span class="p">)</span>
		<span class="nf">cleanup2</span><span class="p">(</span><span class="p">)</span>
		<span class="nf">cleanup</span><span class="p">(</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">serviceService</span><span class="p">,</span> <span class="nx">cleanup5</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">service</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">daoDao</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">cleanup4</span><span class="p">(</span><span class="p">)</span>
		<span class="nf">cleanup3</span><span class="p">(</span><span class="p">)</span>
		<span class="nf">cleanup2</span><span class="p">(</span><span class="p">)</span>
		<span class="nf">cleanup</span><span class="p">(</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">engine</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">serviceService</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">cleanup5</span><span class="p">(</span><span class="p">)</span>
		<span class="nf">cleanup4</span><span class="p">(</span><span class="p">)</span>
		<span class="nf">cleanup3</span><span class="p">(</span><span class="p">)</span>
		<span class="nf">cleanup2</span><span class="p">(</span><span class="p">)</span>
		<span class="nf">cleanup</span><span class="p">(</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">server</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">grpc</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="nx">serviceService</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">cleanup5</span><span class="p">(</span><span class="p">)</span>
		<span class="nf">cleanup4</span><span class="p">(</span><span class="p">)</span>
		<span class="nf">cleanup3</span><span class="p">(</span><span class="p">)</span>
		<span class="nf">cleanup2</span><span class="p">(</span><span class="p">)</span>
		<span class="nf">cleanup</span><span class="p">(</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="nx">app</span><span class="p">,</span> <span class="nx">cleanup6</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">NewApp</span><span class="p">(</span><span class="nx">serviceService</span><span class="p">,</span> <span class="nx">engine</span><span class="p">,</span> <span class="nx">server</span><span class="p">)</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nf">cleanup5</span><span class="p">(</span><span class="p">)</span>
		<span class="nf">cleanup4</span><span class="p">(</span><span class="p">)</span>
		<span class="nf">cleanup3</span><span class="p">(</span><span class="p">)</span>
		<span class="nf">cleanup2</span><span class="p">(</span><span class="p">)</span>
		<span class="nf">cleanup</span><span class="p">(</span><span class="p">)</span>
		<span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">app</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
		<span class="nf">cleanup6</span><span class="p">(</span><span class="p">)</span>
		<span class="nf">cleanup5</span><span class="p">(</span><span class="p">)</span>
		<span class="nf">cleanup4</span><span class="p">(</span><span class="p">)</span>
		<span class="nf">cleanup3</span><span class="p">(</span><span class="p">)</span>
		<span class="nf">cleanup2</span><span class="p">(</span><span class="p">)</span>
		<span class="nf">cleanup</span><span class="p">(</span><span class="p">)</span>
	<span class="p">}</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div><p>æŠŠä¸Šé¢çš„é€»è¾‘ä¸²èµ·æ¥å°±æ˜¯ï¼š</p>
<ol>
<li>dao.NewRedis()</li>
<li>dao.NewMC()</li>
<li>dao.NewDB()</li>
<li>dao.New(redis, memcache, db)</li>
<li>service.New(daoDao)</li>
<li>http.New(serviceService)</li>
<li>grpc.New(serviceService)</li>
<li>NewApp(serviceService, engine, server)</li>
</ol>
<p>è‡³æ­¤ï¼Œä¾èµ–æ³¨å…¥å®Œæˆã€‚</p>
<p>å…¶å®æ•´ä¸ªå¾®æœåŠ¡çš„å¯åŠ¨æµç¨‹ä¹Ÿæ˜¯éå¸¸ç®€å•çš„ï¼Œæ¥ä¸‹æ¥çš„æ–‡ç« ä¸­æˆ‘å°±é‡ç‚¹åˆ†ææ¯”è¾ƒæ„Ÿå…´è¶£çš„ç‚¹ã€‚</p>
]]></content>
		</item>
		
		<item>
			<title>DNSå­¦ä¹ æ€»ç»“</title>
			<link>https://wangzeping722.github.io/posts/dns-recording/</link>
			<pubDate>Mon, 23 Dec 2019 10:36:05 +0800</pubDate>
			
			<guid>https://wangzeping722.github.io/posts/dns-recording/</guid>
			<description>DNS æœ‰å¤šç§è®°å½•ç±»å‹ï¼Œæ¯ç§è®°å½•éƒ½æœ‰ä¸åŒçš„ä½œç”¨ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦æ€»ç»“äº†å¸¸ç”¨çš„è®°å½•ã€‚ A Aï¼ˆAddressï¼‰è®°å½•ç”¨æ¥æŒ‡å®šä¸»æœºåï¼ˆåŸŸåï¼‰å¯¹åº”çš„ IPv4 åœ°å€è®°å½•ã€‚æ¯”</description>
			<content type="html"><![CDATA[<p>DNS æœ‰å¤šç§è®°å½•ç±»å‹ï¼Œæ¯ç§è®°å½•éƒ½æœ‰ä¸åŒçš„ä½œç”¨ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦æ€»ç»“äº†å¸¸ç”¨çš„è®°å½•ã€‚</p>
<h4 id="a">A</h4>
<p>Aï¼ˆAddressï¼‰è®°å½•ç”¨æ¥æŒ‡å®šä¸»æœºåï¼ˆåŸŸåï¼‰å¯¹åº”çš„ IPv4 åœ°å€è®°å½•ã€‚æ¯”å¦‚ï¼Œå½“ä½ æµè§ˆä¸€ä¸ªç½‘é¡µæ—¶å€™ä¼šï¼Œæµè§ˆå™¨å°±ä¼šå…ˆå»æŸ¥æ‰¾å¯¹åº”åŸŸåçš„ A è®°å½•ï¼Œæ¥è·å– IP åœ°å€ï¼Œè·å¾—äº† IP åœ°å€ï¼Œæ‰èƒ½ä¸æœåŠ¡å™¨å»ºç«‹è¿æ¥ã€‚</p>
<blockquote>
<p>æˆ‘ä»¬å¯ä»¥ä¸ºåŒä¸€ä¸ªåŸŸåæ·»åŠ å¤šä¸ª A è®°å½•ï¼Œè§£æçš„æ—¶å€™ï¼Œä¼šå¾—åˆ°å¤šä¸ª IPï¼Œä¼šéšæœºé€‰æ‹©ä¸€ä¸ªä½¿ç”¨ã€‚</p>
</blockquote>
<p><em>åŸŸåä¸åŒºåˆ†å¤§å°å†™ã€‚è®°å½•çš„åç§°åº”è¯¥æ˜¯ç”± ASCII ç å­—æ¯ã€æ•°å­—å’Œ - ç»„æˆã€‚</em></p>
<h4 id="aaaa">AAAA</h4>
<p>AAAA è®°å½•ç”¨æ¥æŒ‡å®šä¸»æœºåï¼ˆåŸŸåï¼‰å¯¹åº”çš„ IPv6 åœ°å€è®°å½•ï¼Œå…¶ä»–ä¸ A ç›¸åŒã€‚</p>
<h4 id="cname-canonical-names">CNAME ï¼ˆcanonical namesï¼‰</h4>
<p>CNAMEï¼ˆè§„èŒƒåç§°ï¼‰ï¼Œä¹Ÿå°±æ˜¯åˆ«åè®°å½•ï¼Œå®ƒèƒ½å¤Ÿè®©æˆ‘ä»¬æŠŠå¤šä¸ªåå­—æ˜ å°„åˆ°åŒä¸€ä¸ªä¸»æœºã€‚</p>
<p>åº”ç”¨åœºæ™¯ï¼š</p>
<ul>
<li>ä½¿ç”¨ CDN æœåŠ¡æ—¶ã€‚</li>
<li>å‡å¦‚ä¸€ä¸ªæœåŠ¡å™¨è¿è¡Œç€ 100 ä¸ªç½‘ç«™ï¼Œè¿™ 100 ä¸ªç½‘ç«™ CNAME åˆ° <code>a.example.com</code>ã€‚å½“è¯¥æœåŠ¡å™¨ IP æ”¹å˜æ—¶ï¼Œä½ åªéœ€æ”¹å˜ <code>a.example.com</code>çš„ IP å°±å¯ä»¥äº†ã€‚</li>
</ul>
<p>æ³¨æ„ï¼šç”±äº<code>CNAME</code>è®°å½•å°±æ˜¯ä¸€ä¸ªæ›¿æ¢ï¼Œæ‰€ä»¥åŸŸåä¸€æ—¦è®¾ç½®<code>CNAME</code>è®°å½•ä»¥åï¼Œå°±ä¸èƒ½å†è®¾ç½®å…¶ä»–è®°å½•äº†ï¼ˆæ¯”å¦‚<code>A</code>è®°å½•å’Œ<code>MX</code>è®°å½•ï¼‰ï¼Œè¿™æ˜¯ä¸ºäº†é˜²æ­¢äº§ç”Ÿå†²çªã€‚ä¸¾ä¾‹æ¥è¯´ï¼Œ<code>foo.com</code>æŒ‡å‘<code>bar.com</code>ï¼Œè€Œä¸¤ä¸ªåŸŸåå„æœ‰è‡ªå·±çš„<code>MX</code>è®°å½•ï¼Œå¦‚æœä¸¤è€…ä¸ä¸€è‡´ï¼Œå°±ä¼šäº§ç”Ÿé—®é¢˜ã€‚ç”±äºé¡¶çº§åŸŸåé€šå¸¸è¦è®¾ç½®<code>MX</code>è®°å½•ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸å…è®¸ç”¨æˆ·å¯¹é¡¶çº§åŸŸåè®¾ç½®<code>CNAME</code>è®°å½•ã€‚</p>
<p>Aè®°å½•æ˜¯æŠŠåŸŸåè§£æåˆ°IPåœ°å€ï¼Œè€ŒCNAMEè®°å½•æ˜¯æŠŠåŸŸåè§£æåˆ°å¦å¤–ä¸€ä¸ªåŸŸåï¼Œè€Œè¿™ä¸ªåŸŸåæœ€ç»ˆä¼šæŒ‡å‘Aè®°å½•ï¼Œåœ¨åŠŸèƒ½å®ç°åœ¨ä¸ŠAè®°å½•ä¸CNAMEè®°å½•æ²¡æœ‰åŒºåˆ«ã€‚</p>
<p>ä¾‹å¦‚ï¼š</p>
<pre><code class="language-dns" data-lang="dns">a.example.com       IN      A       192.168.1.101
b.example.com       IN      CNAME   a.example.comï¼ˆè§„èŒƒåç§°ï¼‰
</code></pre><p>ä½ åœ¨è¯·æ±‚ b.example.com çš„æ—¶å€™ï¼Œä»–ä¼šå…ˆè¿”å›ç»™ä½ ä¸€ä¸ª CNAME ï¼Œç„¶åä½ åœ¨ç”¨ CNAME å»æŸ¥è¯¢ã€‚</p>
<h4 id="ns">NS</h4>
<p>NSï¼ˆName Serverï¼‰ï¼ŒåŸŸåæœåŠ¡å™¨è®°å½•ï¼Œè¿”å›ä¿å­˜ä¸‹ä¸€çº§åŸŸåä¿¡æ¯çš„æœåŠ¡å™¨åœ°å€ã€‚è¯¥è®°å½•åªèƒ½è®¾ç½®ä¸ºåŸŸåï¼Œä¸èƒ½è®¾ç½®ä¸ºIPåœ°å€ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œä¸ºäº†æœåŠ¡çš„å®‰å…¨å¯é ï¼Œè‡³å°‘åº”è¯¥æœ‰ä¸¤æ¡<code>NS</code>è®°å½•ï¼Œè€Œ<code>A</code>è®°å½•å’Œ<code>MX</code>è®°å½•ä¹Ÿå¯ä»¥æœ‰å¤šæ¡ï¼Œè¿™æ ·å°±æä¾›äº†æœåŠ¡çš„å†—ä½™æ€§ï¼Œé˜²æ­¢å‡ºç°å•ç‚¹å¤±è´¥ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ dig NS google.com
google.com.		777	IN	NS	ns4.google.com.
google.com.		777	IN	NS	ns3.google.com.
google.com.		777	IN	NS	ns2.google.com.
google.com.		777	IN	NS	ns1.google.com.
</code></pre></div><p>æˆ‘ä»¬å¯ä»¥çœ‹è§ï¼Œgoogle çš„æƒå¨ NS æœåŠ¡å™¨æœ‰å››ä¸ªã€‚</p>
<h4 id="mx">MX</h4>
<p>MXï¼ˆMX recordï¼‰ï¼Œé‚®ä»¶äº¤æ¢è®°å½•ï¼Œç”¨äºé‚®ä»¶æœåŠ¡å™¨çš„åœ°å€ã€‚MX è®°å½•å…è®¸è®¾ç½®ä¼˜å…ˆçº§ï¼Œå½“å¤šä¸ªé‚®ä»¶æœåŠ¡å™¨å¯ç”¨æ—¶ï¼Œä¼šæ ¹æ®è¯¥å€¼å†³å®šæŠ•é€’é‚®ä»¶çš„æœåŠ¡å™¨ï¼ˆå€¼å°çš„ä¼˜å…ˆï¼‰ï¼Œä¸‹é¢çš„<code>20, 10, 40 ...</code>å°±è¡¨ç¤ºä¼˜å…ˆçº§ã€‚</p>
<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">$ dig MX google.com
google.com.		306	IN	MX	<span class="m">20</span> alt1.aspmx.l.google.com.
google.com.		306	IN	MX	<span class="m">10</span> aspmx.l.google.com.
google.com.		306	IN	MX	<span class="m">40</span> alt3.aspmx.l.google.com.
google.com.		306	IN	MX	<span class="m">30</span> alt2.aspmx.l.google.com.
google.com.		306	IN	MX	<span class="m">50</span> alt4.aspmx.l.google.com.
</code></pre></div><h4 id="soa">SOA</h4>
<p>SOA å«åšèµ·å§‹æˆæƒæœºæ„è®°å½•ï¼ŒNSç”¨äºæ ‡è¯†å¤šå°åŸŸåè§£ææœåŠ¡å™¨ï¼ŒSOAè®°å½•ç”¨äºåœ¨ä¼—å¤šNSè®°å½•ä¸­çš„<strong>ä¸»æœåŠ¡å™¨</strong>ã€‚SOA è®°å½•è¡¨ç¤ºæ­¤åŸŸåçš„æƒå¨è§£ææœåŠ¡å™¨åœ°å€ã€‚ å½“è¦æŸ¥è¯¢çš„åŸŸååœ¨æ‰€æœ‰é€’å½’è§£ææœåŠ¡å™¨ä¸­æ²¡æœ‰åŸŸåè§£æçš„ç¼“å­˜æ—¶ï¼Œå°±ä¼šå›æºæ¥è¯·æ±‚æ­¤åŸŸåçš„SOAè®°å½•ï¼Œä¹Ÿå«æƒå¨è§£æè®°å½•ã€‚</p>
<p>æ²¡æœ‰SOAè®°å½•çš„ zone ä¸ç¬¦åˆ RFC 1035 è¦æ±‚çš„æ ‡å‡†ã€‚</p>
<pre><code>$TTL 86400
@   IN  SOA     startech60serve root.startech60serve.com. (
        2018110201  ;Serial
        3600        ;Refresh
        1800        ;Retry
        604800      ;Expire
        86400       ;Minimum TTL
)
        IN  NS      startech60serve
        IN  A       192.168.1.3
        IN  MX 10   startech60serve
startech60serve     IN  A       192.168.1.3
</code></pre><p><code>root.startech60serve.com. </code>å…¶ä¸­ç¬¬ä¸€ä¸ªç‚¹è¡¨ç¤ºæ˜¯@</p>
<h4 id="txt">TXT</h4>
<p>TXTï¼ˆTXT recordï¼‰ï¼Œæ–‡æœ¬è®°å½•ï¼Œä¸€èˆ¬ç”¨æ¥æè¿°ä¸€ä¸ªåŸŸåï¼Œæˆ–è€…ç”¨æ¥åšæŸç§éªŒè¯åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼š</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">$ dig TXT google.com
google.com.		300	IN	TXT	<span class="s2">&#34;docusign=05958488-4752-4ef2-95eb-aa7ba8a3bd0e&#34;</span>
google.com.		3600	IN	TXT	<span class="s2">&#34;facebook-domain-verification=22rm551cu4k0ab0bxsw536tlds4h95&#34;</span>
google.com.		300	IN	TXT	<span class="s2">&#34;docusign=1b0a6754-49b1-4db5-8540-d2c12664b289&#34;</span>
google.com.		3600	IN	TXT	<span class="s2">&#34;globalsign-smime-dv=CDYX+XFHUw2wml6/Gb8+59BsH31KzUr6c1l2BPvqKX8=&#34;</span>
google.com.		3600	IN	TXT	<span class="s2">&#34;v=spf1 include:_spf.google.com ~all&#34;</span>
</code></pre></div><h4 id="ptr">PTR</h4>
<p>PTR è®°å½•æ˜¯ A è®°å½•çš„é€†å‘è®°å½•ï¼Œåˆç§°åš IP åæŸ¥è®°å½•æˆ–æŒ‡é’ˆè®°å½•ï¼Œè´Ÿè´£å°† IP åå‘è§£æä¸ºåŸŸåï¼Œå³åå‘åŸŸåè§£æã€‚</p>
<p>å‚è€ƒï¼š</p>
<p><a href="https://skyao.io/learning-dns/dns/">https://skyao.io/learning-dns/dns/</a></p>
<p><a href="https://deepzz.com/post/dns-recording-type.html">https://deepzz.com/post/dns-recording-type.html</a></p>
]]></content>
		</item>
		
		<item>
			<title>å¦‚ä½•è®¾è®¡ä¸å®ç° WebConsole</title>
			<link>https://wangzeping722.github.io/posts/how-to-write-webconsole/</link>
			<pubDate>Wed, 04 Dec 2019 09:13:51 +0800</pubDate>
			
			<guid>https://wangzeping722.github.io/posts/how-to-write-webconsole/</guid>
			<description>1. è°ƒç ” å‰ç«¯ï¼šäº†è§£åˆ°æœ‰ä¸€ä¸ªéå¸¸ä¼˜ç§€çš„å¼€æºwebç»ˆç«¯åº“ï¼š xterm.js , ä½¿ç”¨èµ·æ¥ä¹Ÿæ¯”è¾ƒç®€å•ã€‚ åç«¯ï¼šä½¿ç”¨ go è¯­è¨€å®ç°ï¼Œå› ä¸º go è¯­è¨€æ‹¥æœ‰è®¸å¤šä¼˜ç§€çš„å¼€æºsshåº“ï¼Œèƒ½å¤Ÿ</description>
			<content type="html"><![CDATA[<h3 id="1-è°ƒç ”">1. è°ƒç ”</h3>
<p>å‰ç«¯ï¼šäº†è§£åˆ°æœ‰ä¸€ä¸ªéå¸¸ä¼˜ç§€çš„å¼€æºwebç»ˆç«¯åº“ï¼š <strong>xterm.js</strong> , ä½¿ç”¨èµ·æ¥ä¹Ÿæ¯”è¾ƒç®€å•ã€‚</p>
<p>åç«¯ï¼šä½¿ç”¨ go è¯­è¨€å®ç°ï¼Œå› ä¸º go è¯­è¨€æ‹¥æœ‰è®¸å¤šä¼˜ç§€çš„å¼€æºsshåº“ï¼Œèƒ½å¤Ÿæ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚</p>
<p>éš¾ç‚¹ï¼š</p>
<pre><code>1. å¦‚ä½•ä¸ cf(cloud foundry) è¿›è¡Œäº¤äº’å¾—åˆ° `ssh code` ï¼Ÿ
2. å¦‚ä½•æŠŠ ssh å‘½ä»¤è¡Œè½¬æ¢æˆ websocket é€šè®¯, å¹¶è¾“å‡ºåˆ° xterm.js ä¸­ï¼Ÿ
3. å¦‚ä½•æ§åˆ¶è®¿é—®æƒé™ï¼Ÿ
</code></pre>
<h3 id="2-åŸç†">2. åŸç†</h3>
<p><img src="webconsole1.png" alt="webconsoleåŸç†å›¾"></p>
<p>â€‹	1. æµè§ˆå™¨å‘æœåŠ¡å™¨å‘èµ· websocket è¯·æ±‚</p>
<p>â€‹	2. æœåŠ¡å™¨é€šè¿‡ ssh è¿æ¥åˆ° cf å®¹å™¨</p>
<p>â€‹	3. è¿æ¥å»ºç«‹ï¼ŒæœåŠ¡å™¨è´Ÿè´£è½¬å‘æ¶ˆæ¯</p>
<p>åœ¨åç«¯å’Œæµè§ˆå™¨ä¹‹é—´å»ºç«‹websocketè¿æ¥åï¼Œå°†ç”¨æˆ·åœ¨æµè§ˆå™¨ä¸­è¾“å…¥çš„å‘½ä»¤é€šè¿‡ websocket åè®®å‘é€åˆ°åç«¯ï¼Œåç«¯ä½¿ç”¨ ssh åè®®å°†å‘½ä»¤è¾“å…¥åˆ°å®¹å™¨sshè¿›ç¨‹çš„ stdinï¼Œå‘½ä»¤æ‰§è¡Œåï¼Œå†ä» stdout ä¸­è¯»å–è¾“å‡ºï¼Œé€šè¿‡websocketåè®®è¿”å›æµè§ˆå™¨æ˜¾ç¤ºç»™ç”¨æˆ·ï¼Œè¾¾åˆ°äº¤äº’çš„ç›®çš„ã€‚</p>
<h3 id="3-é—®é¢˜è§£å†³ä»¥åŠæœåŠ¡ç«¯å®ç°">3. é—®é¢˜è§£å†³ä»¥åŠæœåŠ¡ç«¯å®ç°</h3>
<p>åœ¨å‰ä¸¤ä¸ªæ­¥éª¤ä¸­ï¼Œæˆ‘å·²ç»é€šè¿‡åˆ†ææŠŠåŸç†å’Œéš¾ç‚¹æ¢³ç†æ¸…æ¥šäº†ï¼Œç›®å‰å°±éœ€è¦ç€æ‰‹è§£å†³è¿™äº›é—®é¢˜ã€‚</p>
<h4 id="31-å¦‚ä½•è·å–-ssh-code">3.1 å¦‚ä½•è·å– ssh code</h4>
<p>cf æœ‰ä¸€ä¸ªè‡ªå¸¦çš„å‘½ä»¤ <code>cf ssh-code</code> èƒ½å¤Ÿè·å–è¿æ¥åˆ°å®¹å™¨ç”¨çš„ <code>ssh code</code>ï¼Œä½†æ˜¯æˆ‘å¹¶æ²¡æœ‰åœ¨ cf å¼€æºçš„ go è¯­è¨€å®¢æˆ·ç«¯ <code>cfclient</code> ä¸­å‘ç°ç›¸å…³çš„ APIï¼Œæ‰€ä»¥æˆ‘å»æŸ¥çœ‹äº† cf cli çš„æºç ï¼Œå¹¶åœ¨é‡Œé¢å‘ç°äº† <strong>cc</strong> æš´éœ²å‡ºæ¥çš„æ¥å£ï¼Œæœ‰äº†è¿™ä¸ªæ¥å£ä¹‹åï¼Œå°±èƒ½å¤Ÿé€šè¿‡ http è¯·æ±‚çš„æ–¹å¼è·å– <code>ssh-code</code>ã€‚ç”±äº <code>cfclient</code> ä¸­å¹¶æ²¡æœ‰ç›¸å…³çš„ä»£ç ï¼Œæ‰€ä»¥ä¸å¾—ä¸è‡ªå·±å®ç°ä¸€äº›æ–¹æ¥è·å– <code>ssh-code</code>, äºæ˜¯è¿™ä¸ªé—®é¢˜è§£å†³äº†ã€‚</p>
<h4 id="32-å¦‚ä½•å°†-websocket-å’Œ-ssh-è¿™ä¸¤ä¸ªåè®®çš„æ¶ˆæ¯è¿›è¡Œè½¬æ¢">3.2 å¦‚ä½•å°† websocket å’Œ ssh è¿™ä¸¤ä¸ªåè®®çš„æ¶ˆæ¯è¿›è¡Œè½¬æ¢</h4>
<p><strong>è¿æ¥å»ºç«‹</strong>ï¼š</p>
<p><img src="webconsole2.png" alt=""></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">WS</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// åˆå§‹åŒ–websocketè¿æ¥
</span><span class="c1"></span>	<span class="nx">upgrader</span> <span class="o">:=</span> <span class="nx">websocket</span><span class="p">.</span><span class="nx">Upgrader</span><span class="p">{</span>
		<span class="nx">ReadBufferSize</span><span class="p">:</span>  <span class="mi">1024</span><span class="p">,</span>
		<span class="nx">WriteBufferSize</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
	<span class="p">}</span>
	<span class="nx">ws</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">upgrader</span><span class="p">.</span><span class="nf">Upgrade</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Writer</span><span class="p">,</span> <span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
	<span class="k">defer</span> <span class="nx">ws</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="p">)</span>
  
	<span class="c1">// åˆå§‹åŒ–sshè¿æ¥
</span><span class="c1"></span>	<span class="nx">cl</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;claims&#34;</span><span class="p">)</span>
	<span class="nx">s</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">c</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">&#34;session&#34;</span><span class="p">)</span>
	<span class="nx">claims</span> <span class="o">:=</span> <span class="nx">cl</span><span class="p">.</span><span class="p">(</span><span class="o">*</span><span class="nx">utils</span><span class="p">.</span><span class="nx">Claims</span><span class="p">)</span>
	<span class="nx">session</span> <span class="o">:=</span> <span class="nx">s</span><span class="p">.</span><span class="p">(</span><span class="o">*</span><span class="nx">utils</span><span class="p">.</span><span class="nx">Session</span><span class="p">)</span>

	<span class="nx">sshShell</span> <span class="o">:=</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">SSHShellSession</span><span class="p">{</span>
		<span class="nx">Node</span><span class="p">:</span> <span class="nx">utils</span><span class="p">.</span><span class="nx">Node</span><span class="p">{</span>
			<span class="nx">Host</span><span class="p">:</span> <span class="nx">claims</span><span class="p">.</span><span class="nx">Host</span><span class="p">,</span>
			<span class="nx">Port</span><span class="p">:</span> <span class="nx">claims</span><span class="p">.</span><span class="nx">Port</span><span class="p">,</span>
		<span class="p">}</span><span class="p">,</span>
	<span class="p">}</span>

	<span class="kd">var</span> <span class="nx">wsBuff</span> <span class="nx">WebSocketBufferWriter</span>
	<span class="nx">sshShell</span><span class="p">.</span><span class="nx">StdoutPipe</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">wsBuff</span>
	<span class="nx">err</span> <span class="p">=</span> <span class="nx">sshConn</span><span class="p">.</span><span class="nf">Connect</span><span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">password</span><span class="p">)</span>
	<span class="k">defer</span> <span class="nx">sshConn</span><span class="p">.</span><span class="nf">Close</span><span class="p">(</span><span class="p">)</span>
	<span class="k">defer</span> <span class="nx">wsBuff</span><span class="p">.</span><span class="nf">Flush</span><span class="p">(</span><span class="nx">websocket</span><span class="p">.</span><span class="nx">TextMessage</span><span class="p">,</span> <span class="nx">ws</span><span class="p">)</span>
	<span class="o">...</span><span class="o">...</span>
  <span class="o">...</span><span class="o">...</span>
<span class="p">}</span>
</code></pre></div><p><strong>è¿æ¥ä¿æŒï¼š</strong></p>
<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kd">func</span> <span class="nf">WS</span><span class="p">(</span><span class="nx">c</span> <span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">{</span>
  <span class="o">...</span><span class="o">...</span>
  <span class="o">...</span><span class="o">...</span>
	<span class="nx">done</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
	<span class="nx">setDone</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span> <span class="nx">done</span> <span class="o">&lt;-</span> <span class="kc">true</span> <span class="p">}</span>

	<span class="c1">// æ•°æ®è½¬æ¢ï¼šwebsocket ----&gt; SSH
</span><span class="c1"></span>	<span class="nx">writeMessageToSSHServer</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="nx">wc</span> <span class="nx">io</span><span class="p">.</span><span class="nx">WriteCloser</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">defer</span> <span class="nf">setDone</span><span class="p">(</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">{</span>
			<span class="c1">// ä»websocketè¯»å–æ•°æ®
</span><span class="c1"></span>			<span class="nx">msgType</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ws</span><span class="p">.</span><span class="nf">ReadMessage</span><span class="p">(</span><span class="p">)</span>

			<span class="k">if</span> <span class="nx">err</span> <span class="p">=</span> <span class="nf">DispatchMessage</span><span class="p">(</span><span class="nx">sshShell</span><span class="p">.</span><span class="nx">Session</span><span class="p">,</span> <span class="nx">msgType</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">wc</span><span class="p">)</span><span class="p">;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
				<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Error: error write data to ssh server:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
				<span class="k">return</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="nx">stopper</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">bool</span><span class="p">)</span>
	<span class="c1">// æ•°æ®è½¬æ¢ï¼šSSH ----&gt; websocket
</span><span class="c1"></span>	<span class="nx">writeBufferToWebSocket</span> <span class="o">:=</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">defer</span> <span class="nf">setDone</span><span class="p">(</span><span class="p">)</span>
		<span class="nx">tick</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nf">NewTicker</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nf">Duration</span><span class="p">(</span><span class="nx">utils</span><span class="p">.</span><span class="nx">Config</span><span class="p">.</span><span class="nx">SSH</span><span class="p">.</span><span class="nx">BufferCheckerCycleTime</span><span class="p">)</span><span class="p">)</span>
		<span class="k">defer</span> <span class="nx">tick</span><span class="p">.</span><span class="nf">Stop</span><span class="p">(</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">{</span>
			<span class="k">select</span> <span class="p">{</span>
			<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">tick</span><span class="p">.</span><span class="nx">C</span><span class="p">:</span>
				<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">wsBuff</span><span class="p">.</span><span class="nf">Flush</span><span class="p">(</span><span class="nx">websocket</span><span class="p">.</span><span class="nx">TextMessage</span><span class="p">,</span> <span class="nx">ws</span><span class="p">)</span><span class="p">;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
					<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Error: error sending data via webSocket:&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
					<span class="k">return</span>
				<span class="p">}</span>
			<span class="k">case</span> <span class="o">&lt;-</span><span class="nx">stopper</span><span class="p">:</span>
				<span class="k">return</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">go</span> <span class="nf">writeMessageToSSHServer</span><span class="p">(</span><span class="nx">sshShell</span><span class="p">.</span><span class="nx">StdinPipe</span><span class="p">)</span>
	<span class="k">go</span> <span class="nf">writeBufferToWebSocket</span><span class="p">(</span><span class="p">)</span>
	<span class="k">go</span> <span class="kd">func</span><span class="p">(</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">defer</span> <span class="nf">setDone</span><span class="p">(</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sshShell</span><span class="p">.</span><span class="nx">Session</span><span class="p">.</span><span class="nf">Wait</span><span class="p">(</span><span class="p">)</span><span class="p">;</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span><span class="p">{</span>
			<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;ssh exist from server&#34;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span><span class="p">(</span><span class="p">)</span>

	<span class="o">&lt;-</span><span class="nx">done</span>
	<span class="nx">stopper</span> <span class="o">&lt;-</span> <span class="kc">true</span> 
	<span class="nx">log</span><span class="p">.</span><span class="nf">Println</span><span class="p">(</span><span class="s">&#34;Info: websocket finished!&#34;</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div><p><strong>æ§åˆ¶è®¿é—®æƒé™</strong>ï¼š</p>
<p>åˆ©ç”¨ cf è‡ªå¸¦çš„æƒé™è®¤è¯æœºåˆ¶å®ç°ã€‚</p>
]]></content>
		</item>
		
	</channel>
</rss>
